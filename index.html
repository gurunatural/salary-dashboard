<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salary Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Set base font -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styling for number inputs (hide arrows) */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        /* Modal styles */
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        /* Calendar Styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .calendar-day {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 36px;
            width: 36px;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .calendar-day.header {
            font-weight: 600;
            font-size: 0.75rem;
            color: #4b5563; /* text-gray-600 */
        }
        .calendar-day.current-month:hover {
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        .calendar-day.other-month {
            color: #d1d5db; /* text-gray-300 */
            cursor: not-allowed;
        }
        .calendar-day.selected {
            background-color: #ef4444; /* bg-red-500 */
            color: white;
            font-weight: 600;
        }
        .calendar-day.today {
            border: 1px solid #3b82f6; /* border-blue-500 */
        }
        
        /* Tab styles */
        .tab-btn {
            @apply px-8 py-3 text-xl font-bold text-gray-600 rounded-lg hover:bg-gray-200 transition-all duration-200;
        }
        .tab-btn.active {
            @apply bg-blue-600 text-white shadow-md hover:bg-blue-700;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- NEW: Main App Container (Hidden by default) -->
    <div id="mainAppContainer" class="hidden">
        <!-- Tab Navigation -->
        <div class="bg-white shadow-sm sticky top-0 z-40 p-5">
            <div class="container mx-auto max-w-4xl flex justify-between items-center">
                <nav class="flex gap-6">
                    <button id="dashboardTab" class="tab-btn active">
                        Salary Dashboard
                    </button>
                    <button id="salaryDataTab" class="tab-btn">
                        Salary Data
                    </button>
                    <button id="analysisTab" class="tab-btn">
                        Analysis
                    </button>
                </nav>
                <!-- UPDATED: Mode Toggle to Button -->
                <div class="flex items-center space-x-2">
                    <button id="modeSwitchBtn" class="bg-blue-600 text-white py-1 px-3 rounded-lg font-semibold text-sm hover:bg-blue-700 transition duration-200 shadow-sm" data-target-mode="owner">
                        Switch to Owner Mode
                    </button>
                </div>
            </div>
        </div>

        <!-- Page 1: Salary Dashboard -->
        <div id="dashboardPage" class="container mx-auto max-w-4xl p-4 sm:p-8">
            <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl">
                
                <!-- Logo -->
                <div class="flex justify-center mb-6">
                    <img src="https://i.postimg.cc/rsRFnMMc/1002397847-removebg-preview-1.png" alt="Company Logo" class="h-20 w-auto"
                        onerror="this.style.display='none'; this.nextElementSibling.classList.remove('hidden');">
                    <!-- Fallback text if image fails to load -->
                    <div class="hidden text-gray-500 text-center">Logo could not be loaded</div>
                </div>
                
                <!-- Header -->
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-6 text-center">
                    Employee Salary Dashboard
                </h1>

                <!-- Main Form -->
                <div class="space-y-6">

                    <!-- Row 1: Employee, Month, and Year -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <label for="employeeName" class="block text-sm font-medium text-gray-700">Employee Name</label>
                                <button id="manageEmployeesBtn" class="text-xs text-blue-600 hover:text-blue-800 font-medium">Manage</button>
                            </div>
                            <select id="employeeName" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Select Employee</option>
                                <!-- Options will be populated by JS from Firestore -->
                            </select>
                        </div>
                        <div>
                            <label for="month" class="block text-sm font-medium text-gray-700 mb-1">Select Month</label>
                            <select id="month" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option>January</option>
                                <option>February</option>
                                <option>March</option>
                                <option>April</option>
                                <option>May</option>
                                <option>June</option>
                                <option>July</option>
                                <option>August</option>
                                <option>September</option>
                                <option>October</option>
                                <option>November</option>
                                <option>December</option>
                            </select>
                        </div>
                        <div>
                            <label for="year" class="block text-sm font-medium text-gray-700 mb-1">Select Year</label>
                            <select id="year" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <!-- Options will be populated by JS -->
                            </select>
                        </div>
                    </div>

                    <!-- Row 2: Salary and Attendance -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="baseSalary" class="block text-sm font-medium text-gray-700 mb-1">Base Salary</label>
                            <div class="flex">
                                <span class="inline-flex items-center px-3 rounded-l-lg border border-r-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">₹</span>
                                <input type="number" id="baseSalary" placeholder="e.g., 50000" class="w-full px-4 py-2 border border-gray-300 rounded-r-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label for="absentDays" class="block text-sm font-medium text-gray-700 mb-1">Absent</label>
                                <div class="flex">
                                    <input type="text" id="absentDays" placeholder="0" readonly class="w-full px-4 py-2 border border-gray-300 rounded-l-lg shadow-sm focus:outline-none bg-gray-50 cursor-pointer">
                                    <button id="openAbsentCalendar" class="px-3 py-2 border border-l-0 border-gray-300 rounded-r-lg bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label for="halfDays" class="block text-sm font-medium text-gray-700 mb-1">Half Days</label>
                                <div class="flex">
                                    <input type="text" id="halfDays" placeholder="0" readonly class="w-full px-4 py-2 border border-gray-300 rounded-l-lg shadow-sm focus:outline-none bg-gray-50 cursor-pointer">
                                    <button id="openHalfDayCalendar" class="px-3 py-2 border border-l-0 border-gray-300 rounded-r-lg bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label for="extraDays" class="block text-sm font-medium text-gray-700 mb-1">Extra Days</label>
                                <div class="flex">
                                    <input type="text" id="extraDays" placeholder="0" readonly class="w-full px-4 py-2 border border-gray-300 rounded-l-lg shadow-sm focus:outline-none bg-gray-50 cursor-pointer">
                                    <button id="openExtraDayCalendar" class="px-3 py-2 border border-l-0 border-gray-300 rounded-r-lg bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Row 3: Additions -->
                    <div class="border-t border-gray-200 pt-6 space-y-6">
                        <h2 class="text-xl font-semibold text-gray-800">Additions</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="overtimeHours" class="block text-sm font-medium text-gray-700 mb-1">Overtime Hours</label>
                                <div class="flex">
                                    <span class="inline-flex items-center px-3 rounded-l-lg border border-r-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">hrs</span>
                                    <input type="number" id="overtimeHours" placeholder="0" class="w-full px-4 py-2 border border-gray-300 rounded-r-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            <div>
                                <label for="otherAddition" class="block text-sm font-medium text-gray-700 mb-1">Other Addition</label>
                                <div class="flex">
                                    <span class="inline-flex items-center px-3 rounded-l-lg border border-r-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">₹</span>
                                    <input type="number" id="otherAddition" placeholder="0.00" class="w-full px-4 py-2 border border-gray-300 rounded-r-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            <div class="md:col-span-2">
                                <label for="otherAdditionRemark" class="block text-sm font-medium text-gray-700 mb-1">Other Addition Remark</label>
                                <input type="text" id="otherAdditionRemark" placeholder="e.g., Performance Bonus" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                    </div>

                    <!-- Row 4: Deductions -->
                    <div class="border-t border-gray-200 pt-6 space-y-6">
                        <h2 class="text-xl font-semibold text-gray-800">Deductions</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="advancePayment" class="block text-sm font-medium text-gray-700 mb-1">Advance Payment</label>
                                <div class="flex">
                                    <span class="inline-flex items-center px-3 rounded-l-lg border border-r-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">₹</span>
                                    <input type="number" id="advancePayment" placeholder="0.00" class="w-full px-4 py-2 border border-gray-300 rounded-r-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            <div>
                                <label for="otherDeduction" class="block text-sm font-medium text-gray-700 mb-1">Other Deduction</label>
                                <div class="flex">
                                    <span class="inline-flex items-center px-3 rounded-l-lg border border-r-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">₹</span>
                                    <input type="number" id="otherDeduction" placeholder="0.00" class="w-full px-4 py-2 border border-gray-300 rounded-r-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            <div class="md:col-span-2">
                                <label for="otherDeductionRemark" class="block text-sm font-medium text-gray-700 mb-1">Other Deduction Remark</label>
                                <input type="text" id="otherDeductionRemark" placeholder="e.g., Canteen Bill" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                    </div>

                    <!-- Row 5: Calculate Button -->
                    <div class="border-t border-gray-200 pt-8">
                        <button id="calculateButton" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold text-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 shadow-md">
                            Calculate Net Pay & Save
                        </button>
                        <!-- New Cancel Edit Button -->
                        <button id="cancelEditRecordBtn" class="w-full bg-gray-600 text-white py-2 px-6 rounded-lg font-semibold text-base hover:bg-gray-700 mt-2 transition duration-200 shadow-md hidden">
                            Cancel Edit
                        </button>
                        <p id="saveStatus" class="text-center text-green-600 text-sm mt-2 h-4"></p>
                    </div>
                </div>

                <!-- Summary Section (Hidden by default) -->
                <div id="summarySection" class="hidden mt-10 border-t border-gray-300 pt-8">
                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-6 text-center">
                        Pay Summary
                    </h2>
                    
                    <div class="bg-gray-50 p-6 rounded-lg shadow-inner border border-gray-200">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <div class="text-lg font-semibold text-gray-800" id="summaryEmployee"></div>
                                <div class="text-sm text-gray-500" id="summaryMonth"></div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-500">Pay Summary</div>
                                <div class="text-lg font-semibold text-gray-800" id="summaryDate"></div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            
                            <!-- Earnings Column -->
                            <div class="bg-white p-4 rounded-lg shadow-sm border">
                                <h3 class="font-bold text-lg text-green-700 mb-3 border-b pb-2">Earnings</h3>
                                <div class="space-y-2">
                                    <div class="flex justify-between text-gray-700">
                                        <span>Base Salary:</span>
                                        <span class="font-medium text-gray-900" id="summaryBase"></span>
                                    </div>
                                    <div class="flex justify-between text-gray-700">
                                        <span>Extra Day Addition:</span>
                                        <span class="font-medium text-gray-900" id="summaryExtraDay"></span>
                                    </div>
                                    <div id="summaryExtraDayDates" class="text-xs text-gray-500 italic pl-4 hidden"></div>
                                    <div class="flex justify-between text-gray-700">
                                        <span>Overtime Pay:</span>
                                        <span class="font-medium text-gray-900" id="summaryOvertime"></span>
                                    </div>
                                    <div id="summaryOvertimeHours" class="text-xs text-gray-500 italic pl-4 hidden"></div>
                                    <div class="flex justify-between text-gray-700">
                                        <span>Other Additions:</span>
                                        <span class="font-medium text-gray-900" id="summaryOtherAddition"></span>
                                    </div>
                                    <div id="summaryOtherAdditionRemark" class="text-xs text-gray-500 italic pl-4"></div>
                                    
                                    <div class="flex justify-between font-bold border-t pt-2 mt-2">
                                        <span class="text-gray-800">Total Earnings:</span>
                                        <span class="text-green-600" id="summaryTotalEarnings"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Deductions Column -->
                            <div class="bg-white p-4 rounded-lg shadow-sm border">
                                <h3 class="font-bold text-lg text-red-700 mb-3 border-b pb-2">Deductions</h3>
                                <div class="space-y-2">
                                    <div class="flex justify-between text-gray-700">
                                        <span>Absent Day Deduction:</span>
                                        <span class="font-medium text-gray-900" id="summaryAbsent"></span>
                                    </div>
                                    <div id="summaryAbsentDates" class="text-xs text-gray-500 italic pl-4 hidden"></div>
                                    <div class="flex justify-between text-gray-700">
                                        <span>Half Day Deduction:</span>
                                        <span class="font-medium text-gray-900" id="summaryHalfDay"></span>
                                    </div>
                                    <div id="summaryHalfDayDates" class="text-xs text-gray-500 italic pl-4 hidden"></div>
                                    <div class="flex justify-between text-gray-700">
                                        <span>Advance Payment:</span>
                                        <span class="font-medium text-gray-900" id="summaryAdvance"></span>
                                    </div>
                                    <div class="flex justify-between text-gray-700">
                                        <span>Other Deductions:</span>
                                        <span class="font-medium text-gray-900" id="summaryOtherDeduction"></span>
                                    </div>
                                    <div id="summaryOtherDeductionRemark" class="text-xs text-gray-500 italic pl-4"></div>

                                    <div class="flex justify-between font-bold border-t pt-2 mt-2">
                                        <span class="text-gray-800">Total Deductions:</span>
                                        <span class="text-red-600" id="summaryTotalDeductions"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Net Pay -->
                        <div class="mt-6 bg-blue-100 border border-blue-200 p-4 rounded-lg flex justify-between items-center text-xl sm:text-2xl font-bold">
                            <span class="text-blue-800">Net Pay:</span>
                            <span class="text-blue-700" id="summaryNetPay"></span>
                        </div>

                        <!-- Download PDF Button -->
                        <div class="mt-8">
                            <button id="downloadPdfButton" class="w-full bg-green-600 text-white py-3 px-6 rounded-lg font-semibold text-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-200 shadow-md">
                                Download as PDF
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Page 2: Salary Data (Hidden by default) -->
        <div id="salaryDataPage" class="hidden container mx-auto max-w-4xl p-4 sm:p-8">
            <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-6 text-center">
                    Saved Salary Data
                </h1>

                <!-- Filter Controls -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg border">
                    <div>
                        <label for="filterEmployeeName" class="block text-sm font-medium text-gray-700 mb-1">Filter by Employee</label>
                        <select id="filterEmployeeName" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All Employees</option>
                            <!-- Populated by JS from Firestore -->
                        </select>
                    </div>
                    <div>
                        <label for="filterMonth" class="block text-sm font-medium text-gray-700 mb-1">Filter by Month</label>
                        <select id="filterMonth" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All Months</option>
                            <option>January</option>
                            <option>February</option>
                            <option>March</option>
                            <option>April</option>
                            <option>May</option>
                            <option>June</option>
                            <option>July</option>
                            <option>August</option>
                            <option>September</option>
                            <option>October</option>
                            <option>November</option>
                            <option>December</option>
                        </select>
                    </div>
                    <div>
                        <label for="filterYear" class="block text-sm font-medium text-gray-700 mb-1">Filter by Year</label>
                        <select id="filterYear" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All Years</option>
                            <!-- Populated by JS from Firestore data -->
                        </select>
                    </div>
                </div>
                
                <!-- NEW: Export Button -->
                <div class="mb-4 flex justify-end">
                    <button id="exportCsvBtn" class="bg-emerald-600 text-white py-2 px-4 rounded-lg font-semibold text-sm hover:bg-emerald-700 transition duration-200 shadow-sm flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        Export to CSV
                    </button>
                </div>

                <div id="salaryRecordsContainer" class="space-y-4">
                    <!-- Salary records will be populated here by JS -->
                    <p id="noRecordsText" class="text-gray-500 text-center italic">Loading records...</p>
                </div>
            </div>
        </div>

        <!-- Page 3: Analysis (Hidden by default) -->
        <div id="analysisPage" class="hidden container mx-auto max-w-4xl p-4 sm:p-8">
            <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-6 text-center">
                    Salary Data Analysis
                </h1>

                <div id="analysisContent" class="space-y-6">
                    <!-- Analysis content will be populated by JS -->

                    <!-- NEW: Monthly Salary Chart -->
                    <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-md">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Total Salary Paid Per Month</h3>
                        <div class="h-64 md:h-80">
                            <canvas id="monthlySalaryChart"></canvas>
                        </div>
                    </div>

                    <!-- Stat Cards Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        
                        <!-- Total Distributed -->
                        <div class="bg-blue-50 p-6 rounded-xl border border-blue-200 shadow-md">
                            <h3 class="text-sm font-medium text-blue-600 uppercase tracking-wide">Total Salary Distributed</h3>
                            <p class="text-4xl font-bold text-blue-800 mt-2" id="analysisTotalDistributed">₹0.00</p>
                        </div>

                        <!-- Total Payslips -->
                        <div class="bg-green-50 p-6 rounded-xl border border-green-200 shadow-md">
                            <h3 class="text-sm font-medium text-green-600 uppercase tracking-wide">Total Payslips Issued</h3>
                            <p class="text-4xl font-bold text-green-800 mt-2" id="analysisTotalPayslips">0</p>
                        </div>

                        <!-- Average Pay -->
                        <div class="bg-indigo-50 p-6 rounded-xl border border-indigo-200 shadow-md">
                            <h3 class="text-sm font-medium text-indigo-600 uppercase tracking-wide">Average Net Pay</h3>
                            <p class="text-4xl font-bold text-indigo-800 mt-2" id="analysisAveragePay">₹0.00</p>
                        </div>

                        <!-- Highest Single Payslip -->
                        <div class="bg-yellow-50 p-6 rounded-xl border border-yellow-200 shadow-md">
                            <h3 class="text-sm font-medium text-yellow-600 uppercase tracking-wide">Highest Single Payslip</h3>
                            <p class="text-4xl font-bold text-yellow-800 mt-2" id="analysisHighestPayslipAmount">₹0.00</p>
                            <p class="text-sm text-gray-600 mt-1" id="analysisHighestPayslipEmployee">N/A</p>
                        </div>
                    </div>

                    <!-- Financial Summary -->
                    <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-md">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Financial Summary</h3>
                        <div class="flex justify-around items-center">
                            <div class="text-center">
                                <p class="text-sm font-medium text-green-600 uppercase">Total Earnings</p>
                                <p class="text-2xl font-bold text-green-700" id="analysisTotalEarnings">₹0.00</p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm font-medium text-red-600 uppercase">Total Deductions</p>
                                <p class="text-2xl font-bold text-red-700" id="analysisTotalDeductions">₹0.00</p>
                            </div>
                        </div>
                    </div>

                    <!-- Top Paid Employees -->
                    <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-md">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Total Pay by Employee</h3>
                        <ul class="space-y-3 max-h-60 overflow-y-auto" id="analysisEmployeeTotalsList">
                            <!-- Employee totals will be populated here -->
                        </ul>
                    </div>
                </div>
                
                <p id="noAnalysisDataText" class="text-gray-500 text-center italic hidden">No salary data found to analyze.</p>

            </div>
        </div>
    </div> <!-- End of #mainAppContainer -->


    <!-- Employee Management Modal -->
    <div id="employeeModal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-white w-full max-w-md p-6 rounded-xl shadow-2xl transform scale-95">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Manage Employees</h2>
                <button id="closeEmployeeModal" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            
            <!-- List of Employees -->
            <div id="employeeListContainer" class="max-h-60 overflow-y-auto space-y-2 mb-4 pr-2">
                <!-- Employee items will be populated by JS from Firestore -->
                <p class="text-gray-500 text-sm italic">Loading employees...</p>
            </div>

            <!-- Add/Edit Employee Form -->
            <div>
                <h3 id="employeeFormTitle" class="text-lg font-semibold text-gray-700 mb-2">Add New Employee</h3>
                <div class="space-y-3">
                    <div>
                        <label for="newEmployeeName" class="block text-sm font-medium text-gray-700 mb-1">Employee Name</label>
                        <input type="text" id="newEmployeeName" placeholder="Enter name" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="newEmployeeSalary" class="block text-sm font-medium text-gray-700 mb-1">Default Base Salary</label>
                        <div class="flex">
                            <span class="inline-flex items-center px-3 rounded-l-lg border border-r-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">₹</span>
                            <input type="number" id="newEmployeeSalary" placeholder="e.g., 50000" class="w-full px-4 py-2 border border-gray-300 rounded-r-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <!-- NEW: Hide Employee Checkbox -->
                    <div class="flex items-center">
                        <input type="checkbox" id="newEmployeeHidden" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <label for="newEmployeeHidden" class="ml-2 block text-sm font-medium text-gray-700">Hide from Accountant Mode</label>
                    </div>
                    <div class="flex gap-2">
                        <button id="addEmployeeBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-200 flex-1">Add</button>
                        <button id="cancelEditBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 hidden">Cancel</button>
                    </div>
                </div>
                <p id="employeeError" class="text-red-500 text-xs mt-1 hidden"></p>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Employee Modal -->
    <div id="confirmDeleteModal" class="modal fixed inset-0 z-60 flex items-center justify-center bg-black bg-opacity-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-white w-full max-w-sm p-6 rounded-xl shadow-2xl transform scale-95">
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Confirm Employee Deletion</h3>
            <p class="text-gray-600 mb-6">Are you sure you want to delete <strong id="employeeToDeleteName"></strong>?</p>
            <div class="flex justify-end gap-3">
                <button id="cancelDeleteBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="confirmDeleteBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Salary Record Modal (NEW) -->
    <div id="confirmDeleteRecordModal" class="modal fixed inset-0 z-60 flex items-center justify-center bg-black bg-opacity-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-white w-full max-w-sm p-6 rounded-xl shadow-2xl transform scale-95">
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Confirm Record Deletion</h3>
            <p class="text-gray-600 mb-6">Are you sure you want to delete this salary record?</p>
            <p class="text-gray-800 font-medium text-center mb-6" id="recordToDeleteInfo"></p>
            <div class="flex justify-end gap-3">
                <button id="cancelDeleteRecordBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="confirmDeleteRecordBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <!-- Owner Mode Password Modal -->
    <div id="passwordModal" class="modal fixed inset-0 z-60 flex items-center justify-center bg-black bg-opacity-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-white w-full max-w-sm p-6 rounded-xl shadow-2xl transform scale-95">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Owner Access Required</h3>
            <div class="space-y-3">
                <div>
                    <label for="passwordInput" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="passwordInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <p id="passwordError" class="text-red-500 text-xs mt-1 hidden">Incorrect password.</p>
                <div class="flex justify-end gap-3 pt-2">
                    <button id="cancelPasswordBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button id="loginPasswordBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Login</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Absent Calendar Modal -->
    <div id="calendarModal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-white w-full max-w-md p-6 rounded-xl shadow-2xl transform scale-95">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800" id="calendarHeader">Select Absent Dates</h2>
                <button id="closeCalendarModal" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            
            <div class="calendar-grid mb-4" id="calendarGrid">
                <!-- Calendar will be built here by JS -->
            </div>

            <div class="flex justify-end gap-3">
                <button id="cancelCalendarBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="saveCalendarBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Save Dates</button>
            </div>
        </div>
    </div>

    <!-- NEW: App Lock Modal (Visible by default) -->
    <div id="appLockModal" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-75">
        <div class="modal-content bg-white w-full max-w-sm p-6 rounded-xl shadow-2xl">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 text-center">Dashboard Locked</h3>
            <div class="space-y-3">
                <div>
                    <label for="appLockPasswordInput" class="block text-sm font-medium text-gray-700 mb-1">Enter PIN</label>
                    <input type="password" id="appLockPasswordInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <p id="appLockError" class="text-red-500 text-xs mt-1 hidden">Incorrect PIN.</p>
                <div class="flex justify-end gap-3 pt-2">
                    <button id="unlockAppBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Unlock</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Firebase and App Logic -->
    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            addDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            getDocs,
            Timestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config and Global Vars ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // --- THIS IS THE NEW CONFIG FROM THE USER ---
        const userFirebaseConfig = {
          apiKey: "AIzaSyCMppXprg2OJswgLSXmmPgyhaRhxwDp0NA",
          authDomain: "salarymanagement-7f0ec.firebaseapp.com",
          projectId: "salarymanagement-7f0ec",
          storageBucket: "salarymanagement-7f0ec.firebasestorage.app",
          messagingSenderId: "857263287159",
          appId: "1:857263287159:web:70b284c66afa5be7590f72"
        };
        // --- END OF NEW CONFIG ---

        // Use the environment-provided config if it exists, otherwise use the one hardcoded above.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userFirebaseConfig;
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId;
        let employeesCollection, salaryRecordsCollection;

        // --- App State ---
        let salaryRecords = []; // Will be populated from Firestore
        let employees = []; // Will be populated from Firestore
        let employeeToDelete = null; // Stores {id, name}
        let employeeToEditId = null; // Stores ID for editing
        let recordToEditId = null; // NEW: Stores ID for editing a salary record
        let recordToDeleteId = null; // NEW: Stores ID for deleting a salary record
        let lastCalculationData = null; // To store data for PDF generation
        
        // --- NEW: Mode State ---
        let isOwnerMode = false; // Default to Accountant Mode
        let hiddenEmployeeNames = []; // Cache of hidden employee names

        // --- DOM Elements ---
        // Will be populated by the setupApp function
        let employeeSelect, manageEmployeesBtn, employeeModal, closeEmployeeModal, employeeListContainer,
            newEmployeeNameInput, newEmployeeSalaryInput, newEmployeeHiddenInput, addEmployeeBtn,
            employeeError, employeeFormTitle, cancelEditBtn, baseSalaryInput, confirmDeleteModal,
            employeeToDeleteName, cancelDeleteBtn, confirmDeleteBtn, confirmDeleteRecordModal,
            recordToDeleteInfo, cancelDeleteRecordBtn, confirmDeleteRecordBtn, exportCsvBtn,
            cancelEditRecordBtn, calculateButton, modeSwitchBtn, passwordModal, passwordInput,
            passwordError, cancelPasswordBtn, loginPasswordBtn, calendarModal, openAbsentCalendarBtn,
            openHalfDayCalendarBtn, openExtraDayCalendarBtn, closeCalendarModalBtn, cancelCalendarBtn,
            saveCalendarBtn, calendarGrid, calendarHeader, absentDaysInput, halfDaysInput,
            extraDaysInput, downloadPdfButton, saveStatus, dashboardTab, salaryDataTab,
            dashboardPage, salaryDataPage, salaryRecordsContainer, noRecordsText, analysisTab,
            analysisPage, analysisContent, noAnalysisDataText, analysisTotalDistributed,
            analysisTotalPayslips, analysisAveragePay, analysisHighestPayslipAmount,
            analysisHighestPayslipEmployee, analysisTotalEarnings, analysisTotalDeductions,
            analysisEmployeeTotalsList, monthlySalaryChartCanvas, monthlyChartInstance,
            summaryOvertimeHoursEl, filterEmployeeName, filterMonth, filterYear;

        // --- NEW: App Lock DOM Elements (available globally) ---
        const appLockModal = document.getElementById('appLockModal');
        const appLockPasswordInput = document.getElementById('appLockPasswordInput');
        const appLockError = document.getElementById('appLockError');
        const unlockAppBtn = document.getElementById('unlockAppBtn');
        const mainAppContainer = document.getElementById('mainAppContainer');


        // --- Calendar State ---
        let tempSelectedDates = [];
        let currentCalendarInput = null;
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

        // --- Modal Utility Functions ---
        const showModal = (modal) => {
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.querySelector('.modal-content').classList.remove('scale-95');
        };

        const hideModal = (modal) => {
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.querySelector('.modal-content').classList.add('scale-95');
        };

        /**
         * Renders the fetched salary records on the Salary Data page.
         */
        function renderSalaryRecords() {
            // 1. Get filter values
            const nameFilter = filterEmployeeName.value;
            const monthFilter = filterMonth.value;
            const yearFilter = filterYear.value;

            // 2. Filter the global salaryRecords array
            const filteredRecords = salaryRecords.filter(record => {
                const nameMatch = !nameFilter || record.employeeName === nameFilter;
                const monthMatch = !monthFilter || record.month === monthFilter;
                const yearMatch = !yearFilter || record.year == yearFilter; // Use '==' for string/number
                
                return nameMatch && monthMatch && yearMatch;
            });

            // 3. Render the *filtered* array
            salaryRecordsContainer.innerHTML = ''; // Clear existing
            
            if (filteredRecords.length === 0) {
                // Show a helpful message
                if (salaryRecords.length === 0) {
                    noRecordsText.textContent = "No salary records found.";
                } else {
                    noRecordsText.textContent = "No salary records match your filters.";
                }
                noRecordsText.classList.remove('hidden');
                return;
            }
            
            noRecordsText.classList.add('hidden');
            
            // PDF-safe currency formatter
            const formatPdfCurrency = (amount) => {
                const fixedAmount = (amount || 0).toFixed(2);
                const parts = fixedAmount.split('.');
                let integerPart = parts[0];
                const decimalPart = parts[1];
                integerPart = integerPart.replace(/(\d)(?=(\d\d)+\d$)/g, "$1,");
                return `Rs. ${integerPart}.${decimalPart}`;
            };

            filteredRecords.forEach(record => { // Use filteredRecords
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-lg shadow-sm border";
                
                // Use the JS Date object created when saving
                const recordDate = record.createdAt ? record.createdAt.toLocaleDateString('en-IN') : 'N/A';

                card.innerHTML = `
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                        <div class="mb-4 sm:mb-0">
                            <h3 class="text-lg font-semibold text-gray-800">${record.employeeName}</h3>
                            <p class="text-sm text-gray-600">For ${record.month}, ${record.year}</p>
                            <p class="text-sm text-gray-400 text-xs">Saved on: ${recordDate}</p>
                        </div>
                        <div class="flex flex-col items-start sm:items-end w-full sm:w-auto">
                            <span class="text-xl font-bold text-blue-700">${formatPdfCurrency(record.netPay)}</span>
                        </div>
                    </div>
                    <!-- NEW: Action Buttons -->
                    <div class="mt-4 pt-4 border-t border-gray-100 flex justify-end gap-2">
                        <button class="download-record-btn bg-green-100 text-green-700 text-sm font-medium py-1 px-3 rounded-full hover:bg-green-200" data-id="${record.id}">
                            Download PDF
                        </button>
                        <button class="edit-record-btn bg-blue-100 text-blue-700 text-sm font-medium py-1 px-3 rounded-full hover:bg-blue-200" data-id="${record.id}">
                            Edit
                        </button>
                        <button class="delete-record-btn bg-red-100 text-red-700 text-sm font-medium py-1 px-3 rounded-full hover:bg-red-200" data-id="${record.id}">
                            Delete
                        </button>
                    </div>
                `;
                salaryRecordsContainer.appendChild(card);
            });
        }

        /**
         * Calculates and renders the analysis page.
         */
        function renderAnalysis() {
            // PDF-safe currency formatter
            const formatPdfCurrency = (amount) => {
                const fixedAmount = (amount || 0).toFixed(2);
                const parts = fixedAmount.split('.');
                let integerPart = parts[0];
                const decimalPart = parts[1];
                integerPart = integerPart.replace(/(\d)(?=(\d\d)+\d$)/g, "$1,");
                return `Rs. ${integerPart}.${decimalPart}`;
            };

            if (salaryRecords.length === 0) {
                analysisContent.classList.add('hidden');
                noAnalysisDataText.classList.remove('hidden');
                return;
            }

            analysisContent.classList.remove('hidden');
            noAnalysisDataText.classList.add('hidden');

            // --- Perform Calculations ---

            // 1. Total Salary Distributed
            const totalDistributed = salaryRecords.reduce((acc, r) => acc + (r.netPay || 0), 0);
            
            // 2. Total Payslips
            const totalPayslips = salaryRecords.length;

            // 3. Average Pay
            const averagePay = totalPayslips > 0 ? (totalDistributed / totalPayslips) : 0;

            // 4. Highest Single Payslip
            const highestPayslip = salaryRecords.reduce((max, r) => (r.netPay > max.netPay) ? r : max, { netPay: -Infinity });

            // 5. Total Earnings vs Deductions
            const totalEarnings = salaryRecords.reduce((acc, r) => acc + (r.totalEarnings || 0), 0);
            const totalDeductions = salaryRecords.reduce((acc, r) => acc + (r.totalDeductions || 0), 0);

            // 6. Total Pay by Employee
            const employeeTotals = salaryRecords.reduce((acc, r) => {
                const name = r.employeeName;
                if (!acc[name]) {
                    acc[name] = 0;
                }
                acc[name] += (r.netPay || 0);
                return acc;
            }, {});

            const sortedEmployeeTotals = Object.entries(employeeTotals)
                .map(([name, total]) => ({ name, total }))
                .sort((a, b) => b.total - a.total); // Sort descending

            // --- Update DOM ---
            analysisTotalDistributed.textContent = formatPdfCurrency(totalDistributed);
            analysisTotalPayslips.textContent = totalPayslips;
            analysisAveragePay.textContent = formatPdfCurrency(averagePay);

            if (highestPayslip.netPay > -Infinity) {
                analysisHighestPayslipAmount.textContent = formatPdfCurrency(highestPayslip.netPay);
                analysisHighestPayslipEmployee.textContent = `To ${highestPayslip.employeeName} for ${highestPayslip.month}, ${highestPayslip.year}`;
            } else {
                analysisHighestPayslipAmount.textContent = "N/A";
                analysisHighestPayslipEmployee.textContent = "";
            }

            analysisTotalEarnings.textContent = formatPdfCurrency(totalEarnings);
            analysisTotalDeductions.textContent = formatPdfCurrency(totalDeductions);

            // Populate employee list
            analysisEmployeeTotalsList.innerHTML = '';
            if (sortedEmployeeTotals.length > 0) {
                sortedEmployeeTotals.forEach(emp => {
                    const li = document.createElement('li');
                    li.className = "flex justify-between items-center p-3 bg-gray-50 rounded-lg border";
                    li.innerHTML = `
                        <span class="font-medium text-gray-700">${emp.name}</span>
                        <span class="font-bold text-gray-900">${formatPdfCurrency(emp.total)}</span>
                    `;
                    analysisEmployeeTotalsList.appendChild(li);
                });
            } else {
                analysisEmployeeTotalsList.innerHTML = '<li class="text-gray-500 italic">No employee data to show.</li>';
            }

            // --- NEW: Render Monthly Salary Chart ---
            renderMonthlyChart();
        }

        /**
         * NEW: Renders the monthly salary bar chart.
         */
        function renderMonthlyChart() {
            if (!monthlySalaryChartCanvas) return;

            // 1. Process data for the chart
            const monthlyTotals = salaryRecords.reduce((acc, r) => {
                const key = `${r.month}-${r.year}`;
                if (!acc[key]) {
                    acc[key] = 0;
                }
                acc[key] += (r.netPay || 0);
                return acc;
            }, {});

            // 2. Sort the data chronologically
            const sortedMonthlyData = Object.entries(monthlyTotals)
                .map(([key, total]) => {
                    const [month, year] = key.split('-');
                    return {
                        key,
                        total,
                        date: new Date(year, monthNames.indexOf(month), 1) // Create a sortable date
                    };
                })
                .sort((a, b) => a.date - b.date); // Sort chronologically

            // 3. Prepare chart labels and data
            const labels = sortedMonthlyData.map(d => d.key);
            const data = sortedMonthlyData.map(d => d.total);

            // 4. Destroy old chart instance if it exists
            if (monthlyChartInstance) {
                monthlyChartInstance.destroy();
            }

            // 5. Create the new chart
            const ctx = monthlySalaryChartCanvas.getContext('2d');
            monthlyChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Salary Paid',
                        data: data,
                        backgroundColor: 'rgba(59, 130, 246, 0.7)', // bg-blue-500 with opacity
                        borderColor: 'rgba(59, 130, 246, 1)', // border-blue-500
                        borderWidth: 1,
                        borderRadius: 5,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value, index, values) {
                                    return '₹' + value.toLocaleString('en-IN');
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        },
                        legend: {
                            display: false // Hide legend for a cleaner look with one dataset
                        }
                    }
                }
            });
        }


        // --- Employee Data Functions (Firestore) ---

        /**
         * Populates all employee dropdowns from the global 'employees' array.
         */
        function renderEmployeeSelect() {
            const currentSelection = employeeSelect.value;
            const currentFilterSelection = filterEmployeeName.value; // Save filter selection
            
            employeeSelect.innerHTML = '<option value="">Select Employee</option>';
            filterEmployeeName.innerHTML = '<option value="">All Employees</option>'; // Add default
            
            // Sort by name
            const sortedEmployees = [...employees].sort((a, b) => a.name.localeCompare(b.name)); 
            
            sortedEmployees.forEach(emp => {
                // For dashboard dropdown
                const option = document.createElement('option');
                option.value = emp.name;
                option.textContent = emp.name;
                if (emp.name === currentSelection) {
                    option.selected = true;
                }
                employeeSelect.appendChild(option);

                // For filter dropdown
                const filterOption = document.createElement('option');
                filterOption.value = emp.name;
                filterOption.textContent = emp.name;
                if (emp.name === currentFilterSelection) { // Restore filter selection
                    filterOption.selected = true;
                }
                filterEmployeeName.appendChild(filterOption);
            });
        }

        /**
         * Renders the list in the 'Manage Employees' modal.
         */
        function renderEmployeeManagementList() {
            employeeListContainer.innerHTML = '';
            if (employees.length === 0) {
                employeeListContainer.innerHTML = '<p class="text-gray-500 text-sm italic">No employees added.</p>';
                return;
            }
            
            // Sort by name
            const sortedEmployees = [...employees].sort((a, b) => a.name.localeCompare(b.name)); 

            sortedEmployees.forEach(emp => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-2 bg-gray-50 rounded-lg border';
                // NEW: Added "Hidden" badge and data-hidden attribute
                div.innerHTML = `
                    <div>
                        <span class="text-gray-800 font-medium">${emp.name}</span>
                        <span class="text-sm text-gray-500 ml-2">(${(emp.baseSalary || 0).toLocaleString('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0, maximumFractionDigits: 0 })})</span>
                        ${emp.isHidden ? '<span class="ml-2 text-xs font-medium bg-red-100 text-red-800 px-2 py-0.5 rounded-full">Hidden</span>' : ''}
                    </div>
                    <div>
                        <button class="edit-employee-btn text-blue-500 hover:text-blue-700 text-sm font-medium mr-3" data-id="${emp.id}" data-name="${emp.name}" data-salary="${emp.baseSalary || 0}" data-hidden="${emp.isHidden || false}">
                            Edit
                        </button>
                        <button class="delete-employee-btn text-red-500 hover:text-red-700 font-bold text-xl" data-id="${emp.id}" data-name="${emp.name}">&times;</button>
                    </div>
                `;
                employeeListContainer.appendChild(div);
            });
        }

        /**
         * Resets the Add/Edit Employee form
         */
        function resetEmployeeForm() {
            newEmployeeNameInput.value = '';
            newEmployeeSalaryInput.value = '';
            newEmployeeHiddenInput.checked = false; // NEW: Reset checkbox
            employeeError.classList.add('hidden');
            employeeToEditId = null;
            employeeFormTitle.textContent = 'Add New Employee';
            addEmployeeBtn.textContent = 'Add';
            cancelEditBtn.classList.add('hidden');
            addEmployeeBtn.classList.add('flex-1'); // Make 'Add' button full-width again
        }

        /**
         * Adds or updates an employee in Firestore.
         */
        async function addEmployee() {
            const name = newEmployeeNameInput.value.trim();
            const salaryString = newEmployeeSalaryInput.value.trim();
            const salary = parseFloat(salaryString) || 0;
            const isHidden = newEmployeeHiddenInput.checked; // NEW: Get hidden state

            if (!name) {
                employeeError.textContent = 'Please enter a name.';
                employeeError.classList.remove('hidden');
                return;
            }
            if (salaryString === '' || salary < 0) {
                 employeeError.textContent = 'Please enter a valid salary (0 or more).';
                 employeeError.classList.remove('hidden');
                 return;
            }
            // Case-insensitive check, allows saving if the name belongs to the employee being edited
            if (employees.some(emp => emp.name.toLowerCase() === name.toLowerCase() && emp.id !== employeeToEditId)) {
                employeeError.textContent = 'This employee already exists.';
                employeeError.classList.remove('hidden');
                return;
            }

            try {
                addEmployeeBtn.disabled = true;
                addEmployeeBtn.textContent = employeeToEditId ? "Updating..." : "Adding...";

                if (employeeToEditId) {
                    // This is an update
                    const docRef = doc(db, employeesCollection.path, employeeToEditId);
                    await updateDoc(docRef, {
                        name: name,
                        baseSalary: salary,
                        isHidden: isHidden // NEW: Save hidden state
                    });
                    console.log("Employee updated with ID: ", employeeToEditId);
                } else {
                    // This is an add
                    const docRef = await addDoc(employeesCollection, {
                        name: name,
                        baseSalary: salary,
                        isHidden: isHidden, // NEW: Save hidden state
                        createdAt: Timestamp.now()
                    });
                    console.log("Employee added with ID: ", docRef.id);
                }
                
                resetEmployeeForm(); // Reset the form
                
            } catch (error) {
                console.error("Error saving employee:", error);
                employeeError.textContent = "Error saving employee. Please try again.";
                employeeError.classList.remove('hidden');
            } finally {
                addEmployeeBtn.disabled = false;
                // Button text is reset by resetEmployeeForm()
            }
        }
        
        /**
         * Deletes an employee from Firestore.
         */
        async function confirmDelete() {
            if (!employeeToDelete) {
                console.error("No employee selected for deletion.");
                hideModal(confirmDeleteModal);
                return;
            }

            confirmDeleteBtn.disabled = true;
            confirmDeleteBtn.textContent = "Deleting...";

            try {
                const docRef = doc(db, employeesCollection.path, employeeToDelete.id);
                await deleteDoc(docRef);
                console.log("Employee deleted successfully:", employeeToDelete.name);
            } catch (error) {
                console.error("Error deleting employee:", error);
            } finally {
                hideModal(confirmDeleteModal);
                employeeToDelete = null;
                confirmDeleteBtn.disabled = false;
                confirmDeleteBtn.textContent = "Delete";
                // List will auto-update thanks to onSnapshot
            }
        }
        
        /**
         * Saves or updates the calculated salary record to Firestore.
         * MODIFIED: Now checks for `recordToEditId` to update existing doc.
         */
        async function saveSalaryRecord(recordData) {
            try {
                if (recordToEditId) {
                    // This is an UPDATE
                    const docRef = doc(db, salaryRecordsCollection.path, recordToEditId);
                    await updateDoc(docRef, recordData); // Just update the data
                    console.log("Salary record updated in Firestore with ID:", recordToEditId);
                    saveStatus.textContent = "Updated successfully!";

                } else {
                    // This is a NEW record
                    const newRecord = {
                        ...recordData,
                        createdAt: Timestamp.now() // Use Firestore Timestamp
                    };
                    const docRef = await addDoc(salaryRecordsCollection, newRecord);
                    console.log("Salary record saved to Firestore with ID:", docRef.id);
                    saveStatus.textContent = "Saved successfully!";
                }
                
                setTimeout(() => saveStatus.textContent = "", 2000); // Clear message
            } catch (error) {
                console.error("Error saving salary record to Firestore:", error);
                saveStatus.textContent = "Error saving record.";
                setTimeout(() => saveStatus.textContent = "", 2000); // Clear message
            }
        }

        /**
         * NEW: Deletes a salary record from Firestore.
         */
        async function confirmDeleteRecord() {
            if (!recordToDeleteId) {
                console.error("No record selected for deletion.");
                hideModal(confirmDeleteRecordModal);
                return;
            }

            confirmDeleteRecordBtn.disabled = true;
            confirmDeleteRecordBtn.textContent = "Deleting...";

            try {
                const docRef = doc(db, salaryRecordsCollection.path, recordToDeleteId);
                await deleteDoc(docRef);
                console.log("Salary record deleted successfully:", recordToDeleteId);
            } catch (error) {
                console.error("Error deleting salary record:", error);
            } finally {
                hideModal(confirmDeleteRecordModal);
                recordToDeleteId = null;
                confirmDeleteRecordBtn.disabled = false;
                confirmDeleteRecordBtn.textContent = "Delete";
                // UI will auto-update from onSnapshot
            }
        }


        /**
         * NEW: Exports the currently filtered salary data to a CSV file.
         */
        function exportToCsv() {
            // 1. Get filter values
            const nameFilter = filterEmployeeName.value;
            const monthFilter = filterMonth.value;
            const yearFilter = filterYear.value;

            // 2. Filter the global salaryRecords array
            const filteredRecords = salaryRecords.filter(record => {
                const nameMatch = !nameFilter || record.employeeName === nameFilter;
                const monthMatch = !monthFilter || record.month === monthFilter;
                const yearMatch = !yearFilter || record.year == yearFilter;
                return nameMatch && monthMatch && yearMatch;
            });

            if (filteredRecords.length === 0) {
                console.log("No data to export.");
                // Optionally show a small message
                const originalText = exportCsvBtn.innerHTML;
                exportCsvBtn.textContent = "No data";
                exportCsvBtn.disabled = true;
                setTimeout(() => {
                    exportCsvBtn.innerHTML = originalText;
                    exportCsvBtn.disabled = false;
                }, 2000);
                return;
            }

            // 3. Define CSV Headers
            const headers = [
                "Employee Name", "Month", "Year",
                "Base Salary", "Extra Day Addition", "Overtime Pay", "Overtime Hours", "Other Addition", "Total Earnings",
                "Absent Deduction", "Half Day Deduction", "Advance Payment", "Other Deduction", "Total Deductions",
                "Net Pay",
                "Absent Dates (YYYY-MM-DD)", "Half Day Dates (YYYY-MM-DD)", "Extra Day Dates (YYYY-MM-DD)",
                "Other Addition Remark", "Other Deduction Remark"
            ];

            let csvContent = headers.join(",") + "\n";

            // 4. Helper to sanitize fields
            const sanitize = (str) => {
                if (str == null) return '""';
                let s = String(str).replace(/"/g, '""'); // Escape double quotes
                if (s.includes(',')) s = `"${s}"`; // Add quotes if comma
                return s;
            };

            // 5. Add rows
            filteredRecords.forEach(record => {
                const row = [
                    record.employeeName,
                    record.month,
                    record.year,
                    record.baseSalary || 0,
                    record.extraDayAddition || 0,
                    record.overtimePay || 0,
                    record.overtimeHours || 0,
                    record.otherAddition || 0,
                    record.totalEarnings || 0,
                    record.absentDeduction || 0,
                    record.halfDayDeduction || 0,
                    record.advancePayment || 0,
                    record.otherDeduction || 0,
                    record.totalDeductions || 0,
                    record.netPay || 0,
                    `"${(record.absentDates || []).join(";")}"`, // Quote lists
                    `"${(record.halfDayDates || []).join(";")}"`,
                    `"${(record.extraDayDates || []).join(";")}"`,
                    sanitize(record.otherAdditionRemark),
                    sanitize(record.otherDeductionRemark)
                ];
                csvContent += row.join(",") + "\n";
            });

            // 6. Create and Trigger Download
            const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvContent);
            const link = document.createElement("a");
            
            const filenameYear = filterYear.value || "all_years";
            const filenameMonth = filterMonth.value || "all_months";
            const filename = `salary_export_${filenameYear}_${filenameMonth}.csv`;

            link.setAttribute("href", encodedUri);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }


        /**
         * Sets up a real-time listener for the employees collection.
         */
        function listenForEmployees() {
            if (!employeesCollection) return;
            onSnapshot(employeesCollection, (snapshot) => {
                // FIRST: Update the full list and the cache of hidden names
                const allEmployees = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                hiddenEmployeeNames = allEmployees.filter(emp => emp.isHidden).map(emp => emp.name);
                
                // SECOND: Filter the main 'employees' array based on the mode
                if (isOwnerMode) {
                    employees = allEmployees;
                } else {
                    employees = allEmployees.filter(emp => !emp.isHidden);
                }
                
                console.log("Employees updated:", employees);
                renderEmployeeSelect();
                renderEmployeeManagementList();
            }, (error) => {
                console.error("Error listening for employees:", error);
                employeeListContainer.innerHTML = '<p class="text-red-500 text-sm italic">Error loading employees.</p>';
            });
        }

        /**
         * Sets up a real-time listener for the salary records collection.
         */
        function listenForSalaryRecords() {
            if (!salaryRecordsCollection) return;

            // Query to sort by date, newest first
            const q = query(salaryRecordsCollection); 
            // Note: We will sort in JS. Firestore sorting requires indexes.
            
            onSnapshot(q, (snapshot) => {
                salaryRecords = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        id: doc.id,
                        ...data,
                        // Convert Firestore Timestamp back to JS Date
                        createdAt: data.createdAt ? data.createdAt.toDate() : new Date() 
                    };
                });

                // NEW: Filter records based on mode
                if (!isOwnerMode) {
                    salaryRecords = salaryRecords.filter(rec => !hiddenEmployeeNames.includes(rec.employeeName));
                }

                // Sort in JavaScript (newest first)
                salaryRecords.sort((a, b) => b.createdAt - a.createdAt);

                console.log("Salary records updated:", salaryRecords);
                renderSalaryRecords(); // Re-render the list on the data page
            }, (error) => {
                console.error("Error listening for salary records:", error);
                noRecordsText.textContent = "Error loading salary records.";
                noRecordsText.classList.remove('hidden');
            });
        }

        /**
         * NEW: Sets the application's user mode (Owner vs. Accountant).
         */
        function setMode(isOwner) {
            isOwnerMode = isOwner;
            localStorage.setItem('salaryAppMode', isOwner ? 'owner' : 'accountant');

            if (isOwner) {
                // Now in Owner Mode, button shows "Switch to Accountant"
                modeSwitchBtn.textContent = "Switch to Accountant Mode";
                modeSwitchBtn.dataset.targetMode = 'accountant';
                modeSwitchBtn.classList.add('bg-gray-600', 'hover:bg-gray-700');
                modeSwitchBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            } else {
                // Now in Accountant Mode, button shows "Switch to Owner"
                modeSwitchBtn.textContent = "Switch to Owner Mode";
                modeSwitchBtn.dataset.targetMode = 'owner';
                modeSwitchBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                modeSwitchBtn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
            }
            
            // Re-run the listeners' filtering logic
            if (employeesCollection) listenForEmployees();
            if (salaryRecordsCollection) listenForSalaryRecords();
            
            // Re-render analysis if the page is active
            if (analysisTab.classList.contains('active')) {
                renderAnalysis();
            }
        }


        /**
         * NEW: Resets the main salary dashboard form.
         */
        function resetMainForm() {
            // Clear all text/number inputs
            document.getElementById('employeeName').value = '';
            document.getElementById('baseSalary').value = '';
            document.getElementById('overtimeHours').value = '';
            document.getElementById('otherAddition').value = '';
            document.getElementById('otherAdditionRemark').value = '';
            document.getElementById('advancePayment').value = '';
            document.getElementById('otherDeduction').value = '';
            document.getElementById('otherDeductionRemark').value = '';
            
            // Clear calendar inputs
            absentDaysInput.value = '0';
            absentDaysInput.dataset.dates = '[]';
            halfDaysInput.value = '0';
            halfDaysInput.dataset.dates = '[]';
            extraDaysInput.value = '0';
            extraDaysInput.dataset.dates = '[]';
            
            // Reset date dropdowns to current
            initDateFields(); 
            
            // Reset edit state
            recordToEditId = null;
            calculateButton.textContent = 'Calculate Net Pay & Save';
            cancelEditRecordBtn.classList.add('hidden');
            
            // Hide summary
            document.getElementById('summarySection').classList.add('hidden');
        }

        // --- Calendar Functions ---
        function renderCalendar(month, year) {
            calendarGrid.innerHTML = '';
            const monthIndex = monthNames.indexOf(month);
            if (monthIndex === -1 || !year) {
                calendarGrid.innerHTML = '<p class="col-span-7 text-red-500">Please select a valid month and year first.</p>';
                return;
            }

            calendarHeader.textContent = `${month}, ${year}`;
            
            const firstDayOfMonth = new Date(year, monthIndex, 1).getDay(); // 0 = Sunday, 1 = Monday, ...
            const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, monthIndex, 0).getDate();
            
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];

            // 1. Add day headers (S, M, T, W, T, F, S) - Sunday first
            ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day header';
                dayEl.textContent = day;
                calendarGrid.appendChild(dayEl);
            });

            // 2. Add padding days from previous month
            for (let i = 0; i < firstDayOfMonth; i++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day other-month';
                dayEl.textContent = daysInPrevMonth - firstDayOfMonth + 1 + i;
                calendarGrid.appendChild(dayEl);
            }

            // 3. Add days for current month
            for (let i = 1; i <= daysInMonth; i++) {
                const dayEl = document.createElement('div');
                const dateStr = `${year}-${String(monthIndex + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                
                dayEl.className = 'calendar-day current-month';
                dayEl.textContent = i;
                dayEl.dataset.date = dateStr;

                if (dateStr === todayStr) {
                    dayEl.classList.add('today');
                }
                
                if (tempSelectedDates.includes(dateStr)) {
                    dayEl.classList.add('selected');
                }

                calendarGrid.appendChild(dayEl);
            }

            // 4. Add padding days for next month
            const totalCells = firstDayOfMonth + daysInMonth;
            const remainingCells = (totalCells % 7 === 0) ? 0 : 7 - (totalCells % 7); // More accurate padding
            
            for (let i = 1; i <= remainingCells; i++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day other-month';
                dayEl.textContent = i;
                calendarGrid.appendChild(dayEl);
            }
        }

        function openCalendar(targetInput, title) {
            currentCalendarInput = targetInput;
            calendarHeader.textContent = title;

            const selectedMonth = document.getElementById('month').value;
            const selectedYear = document.getElementById('year').value;
            
            // Load existing dates from input data attribute if present
            const existingDates = currentCalendarInput.dataset.dates;
            tempSelectedDates = existingDates ? JSON.parse(existingDates) : [];
            
            renderCalendar(selectedMonth, selectedYear);
            showModal(calendarModal);
        }

        /**
         * Populates month and year dropdowns.
         */
        function initDateFields() {
             // Set current month as default
            const currentDate = new Date();
            const currentMonthIndex = currentDate.getMonth();
            const currentMonthName = monthNames[currentMonthIndex];
            document.getElementById('month').value = currentMonthName;
            
            // Populate and set current year as default
            const currentYear = currentDate.getFullYear();
            const yearSelect = document.getElementById('year');
            const filterYearSelect = document.getElementById('filterYear'); // Get filter select
            const startYear = currentYear - 50; 
            const endYear = 2095;
            
            // Only repopulate if they are empty
            if (filterYearSelect.options.length <= 1) { 
                filterYearSelect.innerHTML = '<option value="">All Years</option>'; // Add default
                yearSelect.innerHTML = ''; // Clear dashboard select
                for (let year = endYear; year >= startYear; year--) { // Loop from newest to oldest
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    
                    const filterOption = option.cloneNode(true); // Clone for filter
                    
                    yearSelect.appendChild(option);
                    filterYearSelect.appendChild(filterOption);
                }
            }
            
            yearSelect.value = currentYear; // Set default for dashboard
            
            // Only set filter defaults if they are not already set
            if (!filterMonth.value) {
                filterMonth.value = currentMonthName;
            }
            if (!filterYear.value) {
                filterYear.value = currentYear; 
            }
        }
        
        /**
         * Generates a PDF payslip using jsPDF.
         * Can be called with specific data (from saved records) or will use lastCalculationData.
         */
        function generatePdf(data) {
            const record = data || lastCalculationData;
            
            if (!record) {
                console.log("No data to generate PDF."); 
                // We shouldn't use alert()
                saveStatus.textContent = "No data to generate PDF.";
                setTimeout(() => saveStatus.textContent = "", 2000);
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // PDF-safe currency formatter (uses Rs. and Indian commas)
            const formatPdfCurrency = (amount) => {
                const fixedAmount = (amount || 0).toFixed(2);
                const parts = fixedAmount.split('.');
                let integerPart = parts[0];
                const decimalPart = parts[1];
                // Regex for Indian comma formatting (e.g., 1,00,000)
                integerPart = integerPart.replace(/(\d)(?=(\d\d)+\d$)/g, "$1,");
                return `Rs. ${integerPart}.${decimalPart}`;
            };
            
            let yPos = 20;

            // Header
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text("Pay Slip", 105, yPos, { align: 'center' });
            yPos += 15;
            
            doc.setFontSize(16);
            doc.setFont(undefined, 'normal');
            doc.text("Guru naturals and agro industries", 15, yPos);
            yPos += 7;
            doc.setFontSize(10);
            doc.text("21, shanti vihar colony near bengali square", 15, yPos);
            yPos += 5;
            doc.text("kanadia road indore", 15, yPos);
            yPos += 10;

            // Employee Info
            doc.setFontSize(11);
            doc.text(`Employee Name: ${record.employeeName}`, 15, yPos);
            doc.text(`Pay Period: ${record.month}, ${record.year}`, 140, yPos);
            yPos += 10;
            doc.line(15, yPos, 195, yPos); // Divider
            yPos += 10;

            // Earnings
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text("Earnings", 15, yPos);
            doc.text("Amount (INR)", 195, yPos, { align: 'right' });
            yPos += 8;
            doc.setFont(undefined, 'normal');
            doc.setFontSize(11);

            doc.text("Base Salary:", 15, yPos);
            doc.text(formatPdfCurrency(record.baseSalary), 195, yPos, { align: 'right' });
            yPos += 7;
            doc.text("Extra Day Addition:", 15, yPos);
            doc.text(formatPdfCurrency(record.extraDayAddition), 195, yPos, { align: 'right' });
            
            // NEW: Add Extra Day dates to PDF
            if (record.extraDayDates && record.extraDayDates.length > 0) {
                yPos += 7; // Move down for dates
                const formattedDates = record.extraDayDates.map(d => d.split('-')[2]).join(', ');
                doc.setFont(undefined, 'italic');
                doc.setFontSize(9);
                doc.text(`  (Dates: ${formattedDates})`, 15, yPos);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(11);
            }
            yPos += 7;
            
            // PDF: Show Overtime Hours and Calculated Pay
            let overtimeLabel = "Overtime Pay:";
            if (record.overtimeHours && record.overtimeHours > 0) {
                overtimeLabel = `Overtime Pay (${record.overtimeHours} hrs):`;
            }
            doc.text(overtimeLabel, 15, yPos);
            doc.text(formatPdfCurrency(record.overtimePay), 195, yPos, { align: 'right' });
            yPos += 7;

            doc.text("Other Additions:", 15, yPos);
            doc.text(formatPdfCurrency(record.otherAddition), 195, yPos, { align: 'right' });
            
            if (record.otherAdditionRemark) {
                yPos += 7;
                doc.setFont(undefined, 'italic');
                doc.setFontSize(9);
                doc.text(`  (${record.otherAdditionRemark})`, 15, yPos);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(11);
            }
            yPos += 7;
            
            doc.line(15, yPos, 195, yPos); // Divider
            yPos += 7;
            doc.setFont(undefined, 'bold');
            doc.text("Total Earnings:", 15, yPos);
            doc.text(formatPdfCurrency(record.totalEarnings), 195, yPos, { align: 'right' });
            yPos += 15; // Extra space

            // Deductions
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text("Deductions", 15, yPos);
            doc.text("Amount (INR)", 195, yPos, { align: 'right' });
            yPos += 8;
            doc.setFont(undefined, 'normal');
            doc.setFontSize(11);

            doc.text("Absent Day Deduction:", 15, yPos);
            doc.text(formatPdfCurrency(record.absentDeduction), 195, yPos, { align: 'right' });
            
            // NEW: Add Absent Day dates to PDF
            if (record.absentDates && record.absentDates.length > 0) {
                yPos += 7; // Move down for dates
                const formattedDates = record.absentDates.map(d => d.split('-')[2]).join(', ');
                doc.setFont(undefined, 'italic');
                doc.setFontSize(9);
                doc.text(`  (Dates: ${formattedDates})`, 15, yPos);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(11);
            }
            yPos += 7;
            
            doc.text("Half Day Deduction:", 15, yPos);
            doc.text(formatPdfCurrency(record.halfDayDeduction), 195, yPos, { align: 'right' });
            
            // NEW: Add Half Day dates to PDF
            if (record.halfDayDates && record.halfDayDates.length > 0) {
                yPos += 7; // Move down for dates
                const formattedDates = record.halfDayDates.map(d => d.split('-')[2]).join(', ');
                doc.setFont(undefined, 'italic');
                doc.setFontSize(9);
                doc.text(`  (Dates: ${formattedDates})`, 15, yPos);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(11);
            }
            yPos += 7;
            
            doc.text("Advance Payment:", 15, yPos);
            doc.text(formatPdfCurrency(record.advancePayment), 195, yPos, { align: 'right' });
            yPos += 7;
            doc.text("Other Deductions:", 15, yPos);
            doc.text(formatPdfCurrency(record.otherDeduction), 195, yPos, { align: 'right' });
            
            if (record.otherDeductionRemark) {
                yPos += 7;
                doc.setFont(undefined, 'italic');
                doc.setFontSize(9);
                doc.text(`  (${record.otherDeductionRemark})`, 15, yPos);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(11);
            }
            yPos += 7;

            doc.line(15, yPos, 195, yPos); // Divider
            yPos += 7;
            doc.setFont(undefined, 'bold');
            doc.text("Total Deductions:", 15, yPos);
            doc.text(formatPdfCurrency(record.totalDeductions), 195, yPos, { align: 'right' });
            yPos += 15; // Extra space

            // Net Pay
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text("Net Pay:", 15, yPos);
            doc.text(formatPdfCurrency(record.netPay), 195, yPos, { align: 'right' });
            yPos += 10;

            // Footer
            yPos = doc.internal.pageSize.height - 20;
            doc.setFontSize(10);
            doc.setFont(undefined, 'italic');
            doc.text("This is a computer-generated pay slip.", 105, yPos, { align: 'center' });


            // Save
            doc.save(`Payslip_${record.employeeName.replace(/ /g, '_')}_${record.month}_${record.year}.pdf`);
        }


        // --- Firebase Initialization and Auth ---
        async function initializeFirebase() {
            try {
                if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                    console.warn("Firebase config is missing. App will run in-memory mode.");
                    // We can't proceed with Firebase
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug');

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("User is authenticated:", user.uid);
                        userId = user.uid;

                        // --- Define Firestore Collections ---
                        // Use public data path for this collaborative app
                        employeesCollection = collection(db, `artifacts/${appId}/public/data/employees`);
                        salaryRecordsCollection = collection(db, `artifacts/${appId}/public/data/salaryRecords`);

                        // --- Start Data Listeners ---
                        listenForEmployees();
                        listenForSalaryRecords();
                    } else {
                        console.log("User is not authenticated.");
                        userId = null;
                        // Handle logged-out state if necessary (e.g., disable UI)
                    }
                });

                // Sign in
                if (initialAuthToken) {
                    console.log("Signing in with custom token...");
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    console.log("Signing in anonymously...");
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase initialization error:", error);
                noRecordsText.textContent = "Error connecting to database.";
                noRecordsText.classList.remove('hidden');
            }
        }

        // --- NEW: Main App Initialization Function ---
        // This function now holds all the setup code that runs *after* unlocking
        function setupApp() {
            // --- Populate DOM Elements ---
            employeeSelect = document.getElementById('employeeName');
            manageEmployeesBtn = document.getElementById('manageEmployeesBtn');
            employeeModal = document.getElementById('employeeModal');
            closeEmployeeModal = document.getElementById('closeEmployeeModal');
            employeeListContainer = document.getElementById('employeeListContainer');
            newEmployeeNameInput = document.getElementById('newEmployeeName');
            newEmployeeSalaryInput = document.getElementById('newEmployeeSalary'); 
            newEmployeeHiddenInput = document.getElementById('newEmployeeHidden');
            addEmployeeBtn = document.getElementById('addEmployeeBtn');
            employeeError = document.getElementById('employeeError');
            employeeFormTitle = document.getElementById('employeeFormTitle'); 
            cancelEditBtn = document.getElementById('cancelEditBtn'); 
            baseSalaryInput = document.getElementById('baseSalary'); 
            confirmDeleteModal = document.getElementById('confirmDeleteModal');
            employeeToDeleteName = document.getElementById('employeeToDeleteName');
            cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
            confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            confirmDeleteRecordModal = document.getElementById('confirmDeleteRecordModal');
            recordToDeleteInfo = document.getElementById('recordToDeleteInfo');
            cancelDeleteRecordBtn = document.getElementById('cancelDeleteRecordBtn');
            confirmDeleteRecordBtn = document.getElementById('confirmDeleteRecordBtn');
            exportCsvBtn = document.getElementById('exportCsvBtn');
            cancelEditRecordBtn = document.getElementById('cancelEditRecordBtn');
            calculateButton = document.getElementById('calculateButton');
            modeSwitchBtn = document.getElementById('modeSwitchBtn');
            passwordModal = document.getElementById('passwordModal');
            passwordInput = document.getElementById('passwordInput');
            passwordError = document.getElementById('passwordError');
            cancelPasswordBtn = document.getElementById('cancelPasswordBtn');
            loginPasswordBtn = document.getElementById('loginPasswordBtn');
            calendarModal = document.getElementById('calendarModal');
            openAbsentCalendarBtn = document.getElementById('openAbsentCalendar');
            openHalfDayCalendarBtn = document.getElementById('openHalfDayCalendar');
            openExtraDayCalendarBtn = document.getElementById('openExtraDayCalendar');
            closeCalendarModalBtn = document.getElementById('closeCalendarModal');
            cancelCalendarBtn = document.getElementById('cancelCalendarBtn');
            saveCalendarBtn = document.getElementById('saveCalendarBtn');
            calendarGrid = document.getElementById('calendarGrid');
            calendarHeader = document.getElementById('calendarHeader');
            absentDaysInput = document.getElementById('absentDays');
            halfDaysInput = document.getElementById('halfDays');
            extraDaysInput = document.getElementById('extraDays');
            downloadPdfButton = document.getElementById('downloadPdfButton');
            saveStatus = document.getElementById('saveStatus');
            dashboardTab = document.getElementById('dashboardTab');
            salaryDataTab = document.getElementById('salaryDataTab');
            dashboardPage = document.getElementById('dashboardPage');
            salaryDataPage = document.getElementById('salaryDataPage');
            salaryRecordsContainer = document.getElementById('salaryRecordsContainer');
            noRecordsText = document.getElementById('noRecordsText');
            analysisTab = document.getElementById('analysisTab');
            analysisPage = document.getElementById('analysisPage');
            analysisContent = document.getElementById('analysisContent');
            noAnalysisDataText = document.getElementById('noAnalysisDataText');
            analysisTotalDistributed = document.getElementById('analysisTotalDistributed');
            analysisTotalPayslips = document.getElementById('analysisTotalPayslips');
            analysisAveragePay = document.getElementById('analysisAveragePay');
            analysisHighestPayslipAmount = document.getElementById('analysisHighestPayslipAmount');
            analysisHighestPayslipEmployee = document.getElementById('analysisHighestPayslipEmployee');
            analysisTotalEarnings = document.getElementById('analysisTotalEarnings');
            analysisTotalDeductions = document.getElementById('analysisTotalDeductions');
            analysisEmployeeTotalsList = document.getElementById('analysisEmployeeTotalsList');
            monthlySalaryChartCanvas = document.getElementById('monthlySalaryChart');
            summaryOvertimeHoursEl = document.getElementById('summaryOvertimeHours');
            filterEmployeeName = document.getElementById('filterEmployeeName');
            filterMonth = document.getElementById('filterMonth');
            filterYear = document.getElementById('filterYear');
            
            // --- Run Initial Setup ---
            initDateFields();
            
            // NEW: Set initial mode from localStorage, defaulting to 'accountant'
            const savedMode = localStorage.getItem('salaryAppMode') || 'accountant';
            setMode(savedMode === 'owner');

            initializeFirebase(); // Start Firebase connection
            
            // --- Tab Navigation Listeners ---
            dashboardTab.addEventListener('click', () => {
                dashboardPage.classList.remove('hidden');
                salaryDataPage.classList.add('hidden');
                analysisPage.classList.add('hidden'); // Hide analysis
                dashboardTab.classList.add('active');
                salaryDataTab.classList.remove('active');
                analysisTab.classList.remove('active'); // Deactivate analysis
            });

            salaryDataTab.addEventListener('click', () => {
                dashboardPage.classList.add('hidden');
                salaryDataPage.classList.remove('hidden');
                analysisPage.classList.add('hidden'); // Hide analysis
                dashboardTab.classList.remove('active');
                salaryDataTab.classList.add('active');
                analysisTab.classList.remove('active'); // Deactivate analysis
                // Data is already being listened for, but a manual re-render
                // can be good if filters were changed while on the other tab.
                renderSalaryRecords();
            });

            analysisTab.addEventListener('click', () => {
                dashboardPage.classList.add('hidden');
                salaryDataPage.classList.add('hidden');
                analysisPage.classList.remove('hidden'); // Show analysis
                dashboardTab.classList.remove('active');
                salaryDataTab.classList.remove('active');
                analysisTab.classList.add('active'); // Activate analysis
                // Calculate and render analysis data
                renderAnalysis();
            });

            // --- Employee Modal Listeners ---
            manageEmployeesBtn.addEventListener('click', () => {
                resetEmployeeForm(); // Reset form every time it's opened
                showModal(employeeModal);
            });
            closeEmployeeModal.addEventListener('click', () => hideModal(employeeModal));
            addEmployeeBtn.addEventListener('click', addEmployee);
            
            // Delete and Edit confirmation listeners (using delegation)
            employeeListContainer.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-employee-btn');
                const editBtn = e.target.closest('.edit-employee-btn');

                if (deleteBtn) {
                    employeeToDelete = {
                        id: deleteBtn.dataset.id,
                        name: deleteBtn.dataset.name
                    };
                    employeeToDeleteName.textContent = employeeToDelete.name;
                    showModal(confirmDeleteModal);
                } else if (editBtn) {
                    // Handle Edit
                    employeeToEditId = editBtn.dataset.id;
                    newEmployeeNameInput.value = editBtn.dataset.name;
                    newEmployeeSalaryInput.value = editBtn.dataset.salary;
                    newEmployeeHiddenInput.checked = (editBtn.dataset.hidden === 'true'); // NEW: Set checkbox state
                    
                    employeeFormTitle.textContent = 'Edit Employee';
                    addEmployeeBtn.textContent = 'Update';
                    cancelEditBtn.classList.remove('hidden');
                    addEmployeeBtn.classList.remove('flex-1'); // Make 'Add' button regular size
                    
                    newEmployeeNameInput.focus(); // Focus on the name input
                }
            });
            cancelDeleteBtn.addEventListener('click', () => hideModal(confirmDeleteModal));
            confirmDeleteBtn.addEventListener('click', confirmDelete);
            cancelEditBtn.addEventListener('click', resetEmployeeForm); // Add listener for cancel edit
            
            // --- PDF Download Listener ---
            downloadPdfButton.addEventListener('click', () => generatePdf()); // Calls with no args

            // --- Salary Record Edit/Delete/Download Listeners (Event Delegation) ---
            salaryRecordsContainer.addEventListener('click', (e) => {
                const downloadBtn = e.target.closest('.download-record-btn');
                const editBtn = e.target.closest('.edit-record-btn');
                const deleteBtn = e.target.closest('.delete-record-btn');

                if (downloadBtn) {
                    const recordId = downloadBtn.dataset.id;
                    const recordToDownload = salaryRecords.find(r => r.id === recordId);
                    if (recordToDownload) {
                        generatePdf(recordToDownload);
                    } else {
                        console.error("Could not find record to download:", recordId);
                    }
                }

                if (editBtn) {
                    const recordId = editBtn.dataset.id;
                    const recordToEdit = salaryRecords.find(r => r.id === recordId);
                    if (recordToEdit) {
                        // 1. Populate the form
                        document.getElementById('employeeName').value = recordToEdit.employeeName;
                        document.getElementById('month').value = recordToEdit.month;
                        document.getElementById('year').value = recordToEdit.year;
                        document.getElementById('baseSalary').value = recordToEdit.baseSalary || '';
                        document.getElementById('overtimeHours').value = recordToEdit.overtimeHours || ''; // Use overtimeHours
                        document.getElementById('otherAddition').value = recordToEdit.otherAddition || '';
                        document.getElementById('otherAdditionRemark').value = recordToEdit.otherAdditionRemark || '';
                        document.getElementById('advancePayment').value = recordToEdit.advancePayment || '';
                        document.getElementById('otherDeduction').value = recordToEdit.otherDeduction || '';
                        document.getElementById('otherDeductionRemark').value = recordToEdit.otherDeductionRemark || '';
                        
                        // 2. Populate calendar inputs
                        absentDaysInput.value = (recordToEdit.absentDates || []).length;
                        absentDaysInput.dataset.dates = JSON.stringify(recordToEdit.absentDates || []);
                        halfDaysInput.value = (recordToEdit.halfDayDates || []).length;
                        halfDaysInput.dataset.dates = JSON.stringify(recordToEdit.halfDayDates || []);
                        extraDaysInput.value = (recordToEdit.extraDayDates || []).length;
                        extraDaysInput.dataset.dates = JSON.stringify(recordToEdit.extraDayDates || []);


                        // 3. Set edit state
                        recordToEditId = recordId;
                        calculateButton.textContent = "Update & Save";
                        cancelEditRecordBtn.classList.remove('hidden');

                        // 4. Switch to dashboard tab
                        dashboardTab.click();
                        window.scrollTo(0, 0); // Scroll to top
                    } else {
                        console.error("Could not find record to edit:", recordId);
                    }
                }

                if (deleteBtn) {
                    const recordId = deleteBtn.dataset.id;
                    const record = salaryRecords.find(r => r.id === recordId);
                    if (record) {
                        recordToDeleteInfo.textContent = `${record.employeeName} - ${record.month} ${record.year}`;
                        recordToDeleteId = recordId;
                        showModal(confirmDeleteRecordModal);
                    } else {
                         console.error("Could not find record to delete:", recordId);
                    }
                }
            });

            // --- Salary Record Delete Modal Listeners ---
            cancelDeleteRecordBtn.addEventListener('click', () => {
                hideModal(confirmDeleteRecordModal);
                recordToDeleteId = null;
            });
            confirmDeleteRecordBtn.addEventListener('click', confirmDeleteRecord);

            // --- Main Form Cancel Edit Listener ---
            cancelEditRecordBtn.addEventListener('click', resetMainForm);

            // --- NEW: Export CSV Listener ---
            exportCsvBtn.addEventListener('click', exportToCsv);

            // --- UPDATED: Mode Switch Listener ---
            modeSwitchBtn.addEventListener('click', () => {
                const targetMode = modeSwitchBtn.dataset.targetMode;
                if (targetMode === 'accountant') {
                    // Switching from Owner -> Accountant (no password)
                    setMode(false);
                } else {
                    // Switching from Accountant -> Owner (needs password)
                    passwordInput.value = '';
                    passwordError.classList.add('hidden');
                    showModal(passwordModal);
                }
            });

            // --- NEW: Password Modal Listeners ---
            loginPasswordBtn.addEventListener('click', () => {
                if (passwordInput.value === '9111000') { // This is the Owner Mode password
                    setMode(true);
                    hideModal(passwordModal);
                } else {
                    passwordError.classList.remove('hidden');
                    passwordInput.value = '';
                }
            });

            cancelPasswordBtn.addEventListener('click', () => {
                hideModal(passwordModal);
            });


            // --- Filter Listeners ---
            filterEmployeeName.addEventListener('change', renderSalaryRecords);
            filterMonth.addEventListener('change', renderSalaryRecords);
            filterYear.addEventListener('change', renderSalaryRecords);

            // --- Auto-fill Base Salary on Employee Change ---
            employeeSelect.addEventListener('change', () => {
                // Only auto-fill if NOT in edit mode
                if (!recordToEditId) {
                    const selectedName = employeeSelect.value;
                    if (selectedName) {
                        const selectedEmployee = employees.find(emp => emp.name === selectedName);
                        if (selectedEmployee) {
                            baseSalaryInput.value = selectedEmployee.baseSalary || '';
                        } else {
                            baseSalaryInput.value = '';
                        }
                    } else {
                        baseSalaryInput.value = '';
                    }
                }
            });

            // --- Calendar Listeners ---
            calendarGrid.addEventListener('click', (e) => {
                const dayEl = e.target.closest('.calendar-day');
                if (dayEl && dayEl.classList.contains('current-month')) {
                    const date = dayEl.dataset.date;
                    dayEl.classList.toggle('selected');
                    
                    if (tempSelectedDates.includes(date)) {
                        tempSelectedDates = tempSelectedDates.filter(d => d !== date);
                    } else {
                        tempSelectedDates.push(date);
                    }
                }
            });

            openAbsentCalendarBtn.addEventListener('click', () => openCalendar(absentDaysInput, 'Select Absent Dates'));
            openHalfDayCalendarBtn.addEventListener('click', () => openCalendar(halfDaysInput, 'Select Half Days'));
            openExtraDayCalendarBtn.addEventListener('click', () => openCalendar(extraDaysInput, 'Select Extra Days'));
            closeCalendarModalBtn.addEventListener('click', () => hideModal(calendarModal));
            cancelCalendarBtn.addEventListener('click', () => hideModal(calendarModal));

            saveCalendarBtn.addEventListener('click', () => {
                if (currentCalendarInput) {
                    currentCalendarInput.value = tempSelectedDates.length;
                    currentCalendarInput.dataset.dates = JSON.stringify(tempSelectedDates);
                }
                hideModal(calendarModal);
                currentCalendarInput = null;
                tempSelectedDates = [];
            });


            // --- Calculation Logic ---
            calculateButton.addEventListener('click', async function() {
                
                // --- Get Input Values ---
                const employeeName = document.getElementById('employeeName').value;
                const month = document.getElementById('month').value;
                const year = document.getElementById('year').value;

                if (!employeeName) {
                    saveStatus.textContent = "Please select an employee.";
                    setTimeout(() => saveStatus.textContent = "", 2000);
                    return;
                }
                
                // Parse all numerical inputs, defaulting to 0 if empty
                const baseSalary = parseFloat(document.getElementById('baseSalary').value) || 0;
                const absentDays = parseFloat(document.getElementById('absentDays').value) || 0; // This now gets the count
                const absentDates = JSON.parse(document.getElementById('absentDays').dataset.dates || '[]');
                const halfDays = parseFloat(document.getElementById('halfDays').value) || 0;
                const halfDayDates = JSON.parse(document.getElementById('halfDays').dataset.dates || '[]');
                const extraDays = parseFloat(document.getElementById('extraDays').value) || 0;
                const extraDayDates = JSON.parse(document.getElementById('extraDays').dataset.dates || '[]');
                
                const overtimeHours = parseFloat(document.getElementById('overtimeHours').value) || 0; // Get hours
                const otherAddition = parseFloat(document.getElementById('otherAddition').value) || 0;
                const otherAdditionRemark = document.getElementById('otherAdditionRemark').value;
                
                const advancePayment = parseFloat(document.getElementById('advancePayment').value) || 0;
                const otherDeduction = parseFloat(document.getElementById('otherDeduction').value) || 0;
                const otherDeductionRemark = document.getElementById('otherDeductionRemark').value;

                // --- Perform Calculations ---
                
                // Calculate per-day salary. Assuming 30 days in a month as requested by user.
                const perDaySalary = baseSalary > 0 ? (baseSalary / 30) : 0;
                // NEW: Calculate per-hour salary based on 9-hour day
                const perHourSalary = perDaySalary > 0 ? (perDaySalary / 9) : 0;

                const absentDeduction = perDaySalary * absentDays;
                const halfDayDeduction = (perDaySalary / 2) * halfDays;
                const extraDayAddition = perDaySalary * extraDays;
                const calculatedOvertimePay = perHourSalary * overtimeHours; // Calculate final pay

                const totalEarnings = baseSalary + extraDayAddition + calculatedOvertimePay + otherAddition;
                const totalDeductions = absentDeduction + halfDayDeduction + advancePayment + otherDeduction;
                
                const netPay = totalEarnings - totalDeductions;

                // --- Helper to Format Currency ---
                const formatCurrency = (amount) => {
                    return amount.toLocaleString('en-IN', { style: 'currency', currency: 'INR' });
                };

                // --- Store data for PDF generation AND saving ---
                // (This object is now our complete record)
                lastCalculationData = {
                    employeeName, month, year,
                    
                    baseSalary, // Store raw number
                    extraDayAddition, // Store raw number
                    overtimePay: calculatedOvertimePay, // Store the CALCULATED amount
                    overtimeHours: overtimeHours, // Store the raw hours
                    otherAddition, // Store raw number
                    totalEarnings, // Store raw number
                    
                    absentDeduction, // Store raw number
                    halfDayDeduction, // Store raw number
                    advancePayment, // Store raw number
                    otherDeduction, // Store raw number
                    totalDeductions, // Store raw number
                    
                    netPay, // Store raw number
                    
                    // Store the date arrays as well
                    absentDates,
                    halfDayDates,
                    extraDayDates,
                    
                    otherAdditionRemark,
                    otherDeductionRemark
                };

                // --- Save or Update in Firestore ---
                await saveSalaryRecord(lastCalculationData); // This function now handles both new and update
                
                // If this was an edit, reset the form
                if (recordToEditId) {
                    resetMainForm();
                }


                // --- Populate Summary Section ---
                document.getElementById('summaryEmployee').textContent = employeeName || "N/A";
                document.getElementById('summaryMonth').textContent = `For ${month}, ${year}`;
                document.getElementById('summaryDate').textContent = new Date().toLocaleDateString('en-IN');

                // Earnings
                document.getElementById('summaryBase').textContent = formatCurrency(baseSalary);
                document.getElementById('summaryExtraDay').textContent = `+ ${formatCurrency(extraDayAddition)}`;
                
                const summaryExtraDayDatesEl = document.getElementById('summaryExtraDayDates');
                if (extraDayDates.length > 0) {
                    const formattedDates = extraDayDates.map(d => d.split('-')[2]).join(', ');
                    summaryExtraDayDatesEl.textContent = `Dates: ${formattedDates}`;
                    summaryExtraDayDatesEl.classList.remove('hidden');
                } else {
                    summaryExtraDayDatesEl.classList.add('hidden');
                    summaryExtraDayDatesEl.textContent = '';
                }
                
                document.getElementById('summaryOvertime').textContent = `+ ${formatCurrency(calculatedOvertimePay)}`;
                if (overtimeHours > 0) {
                    summaryOvertimeHoursEl.textContent = `(${overtimeHours} hours)`;
                    summaryOvertimeHoursEl.classList.remove('hidden');
                } else {
                    summaryOvertimeHoursEl.classList.add('hidden');
                }

                const summaryOtherAdditionRemark = document.getElementById('summaryOtherAdditionRemark');
                if (otherAdditionRemark) {
                    summaryOtherAdditionRemark.textContent = `"${otherAdditionRemark}"`;
                    summaryOtherAdditionRemark.classList.remove('hidden');
                } else {
                    summaryOtherAdditionRemark.classList.add('hidden');
                    summaryOtherAdditionRemark.textContent = ''; // Clear content
                }

                // Populate the Total Earnings field
                document.getElementById('summaryTotalEarnings').textContent = formatCurrency(totalEarnings);

                // Deductions
                document.getElementById('summaryAbsent').textContent = `- ${formatCurrency(absentDeduction)}`;
                const summaryAbsentDatesEl = document.getElementById('summaryAbsentDates');
                if (absentDates.length > 0) {
                    const formattedDates = absentDates.map(d => d.split('-')[2]).join(', '); // Get just the day (e.g., '11, 16, 18')
                    summaryAbsentDatesEl.textContent = `Dates: ${formattedDates}`;
                    summaryAbsentDatesEl.classList.remove('hidden');
                } else {
                    summaryAbsentDatesEl.classList.add('hidden');
                    summaryAbsentDatesEl.textContent = ''; // Clear content
                }
                
                document.getElementById('summaryHalfDay').textContent = `- ${formatCurrency(halfDayDeduction)}`;
                
                const summaryHalfDayDatesEl = document.getElementById('summaryHalfDayDates');
                if (halfDayDates.length > 0) {
                    const formattedDates = halfDayDates.map(d => d.split('-')[2]).join(', ');
                    summaryHalfDayDatesEl.textContent = `Dates: ${formattedDates}`;
                    summaryHalfDayDatesEl.classList.remove('hidden');
                } else {
                    summaryHalfDayDatesEl.classList.add('hidden');
                    summaryHalfDayDatesEl.textContent = '';
                }
                
                document.getElementById('summaryAdvance').textContent = `- ${formatCurrency(advancePayment)}`;
                document.getElementById('summaryOtherDeduction').textContent = `- ${formatCurrency(otherDeduction)}`;
                document.getElementById('summaryTotalDeductions').textContent = formatCurrency(totalDeductions);
                
                const summaryOtherDeductionRemark = document.getElementById('summaryOtherDeductionRemark');
                 if (otherDeductionRemark) { 
                    summaryOtherDeductionRemark.textContent = `"${otherDeductionRemark}"`;
                    summaryOtherDeductionRemark.classList.remove('hidden');
                } else {
                    summaryOtherDeductionRemark.classList.add('hidden');
                    summaryOtherDeductionRemark.textContent = ''; // Clear content
                }

                // Net Pay
                document.getElementById('summaryNetPay').textContent = formatCurrency(netPay);

                // --- Show the Summary ---
                document.getElementById('summarySection').classList.remove('hidden');

                // Scroll to the summary
                document.getElementById('summarySection').scrollIntoView({ behavior: 'smooth' });
            });
        
        } // --- END of setupApp() ---


        // --- Initial Page Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // --- App Lock Logic ---
            const handleUnlock = () => {
                if (appLockPasswordInput.value === '911311') {
                    // Correct PIN
                    appLockModal.classList.add('opacity-0', 'pointer-events-none'); // Hide lock
                    mainAppContainer.classList.remove('hidden'); // Show app
                    setupApp(); // Run all the app setup
                } else {
                    // Incorrect PIN
                    appLockError.classList.remove('hidden');
                    appLockPasswordInput.value = '';
                }
            };

            unlockAppBtn.addEventListener('click', handleUnlock);
            appLockPasswordInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    handleUnlock();
                }
            });
        });
    </script>

</body>
</html>
