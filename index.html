<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salary Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- Set base font -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styling for number inputs (hide arrows) */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        /* Modal styles */
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        /* Calendar Styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .calendar-day {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 36px;
            width: 36px;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .calendar-day.header {
            font-weight: 600;
            font-size: 0.75rem;
            color: #4b5563; /* text-gray-600 */
        }
        .calendar-day.current-month:hover {
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        .calendar-day.other-month {
            color: #d1d5db; /* text-gray-300 */
            cursor: not-allowed;
        }
        .calendar-day.selected {
            background-color: #ef4444; /* bg-red-500 */
            color: white;
            font-weight: 600;
        }
        .calendar-day.today {
            border: 1px solid #3b82f6; /* border-blue-500 */
        }
        
        /* Tab styles */
        .tab-btn {
            @apply px-8 py-3 text-xl font-bold text-gray-600 rounded-lg hover:bg-gray-200 transition-all duration-200;
        }
        .tab-btn.active {
            @apply bg-blue-600 text-white shadow-md hover:bg-blue-700;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Dashboard Lock Screen Modal (NEW) -->
    <div id="dashboardLockModal" class="modal fixed inset-0 z-[100] flex items-center justify-center bg-gray-900">
        <div class="modal-content bg-white w-full max-w-sm p-6 rounded-xl shadow-2xl">
            <h3 class="text-2xl font-semibold text-gray-900 mb-4 text-center">Enter PIN</h3>
            <p class="text-gray-600 mb-6 text-center">Please enter the PIN to unlock the dashboard.</p>
            <input type="password" id="lockPinInput" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-center text-xl tracking-widest" maxlength="4">
            <p id="lockError" class="text-red-500 text-sm text-center mt-2 h-4"></p>
            <div class="flex justify-end gap-3 mt-6">
                <button id="unlockDashboardBtn" class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 font-semibold text-lg">Unlock</button>
            </div>
        </div>
    </div>

    <!-- Main App Container (NEW WRAPPER) -->
    <div id="mainAppContainer" class="hidden">

        <!-- Header: Tab Navigation & Mode Switch -->
        <div class="bg-white shadow-sm sticky top-0 z-40 p-5">
            <div class="container mx-auto max-w-4xl flex justify-between items-center">
                <nav class="flex gap-6">
                    <button id="dashboardTab" class="tab-btn active">
                        Salary Dashboard
                    </button>
                    <button id="salaryDataTab" class="tab-btn">
                        Salary Data
                    </button>
                    <button id="analysisTab" class="tab-btn">
                        Analysis
                    </button>
                </nav>
                <div class="flex items-center">
                    <button id="modeSwitchBtn" data-mode="accountant" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition duration-200 shadow-md">
                        Switch to Owner Mode
                    </button>
                </div>
            </div>
        </div>

        <!-- Page 1: Salary Dashboard -->
        <div id="dashboardPage" class="container mx-auto max-w-4xl p-4 sm:p-8">
            <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl">
            
                <!-- Logo -->
                <div class="flex justify-center mb-6">
                    <img src="https://i.postimg.cc/rsRFnMMc/1002397847-removebg-preview-1.png" alt="Company Logo" class="h-20 w-auto"
                         onerror="this.style.display='none'; this.nextElementSibling.classList.remove('hidden');">
                    <!-- Fallback text if image fails to load -->
                    <div class="hidden text-gray-500 text-center">Logo could not be loaded</div>
                </div>
                
                <!-- Header -->
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-6 text-center">
                    Employee Salary Dashboard
                </h1>
    
                <!-- Main Form -->
                <div class="space-y-6">
    
                    <!-- Row 1: Employee, Month, and Year -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <label for="employeeName" class="block text-sm font-medium text-gray-700">Employee Name</label>
                                <button id="manageEmployeesBtn" class="text-xs text-blue-600 hover:text-blue-800 font-medium">Manage</button>
                            </div>
                            <select id="employeeName" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Select Employee</option>
                                <!-- Options will be populated by JS from Firestore -->
                            </select>
                        </div>
                        <div>
                            <label for="month" class="block text-sm font-medium text-gray-700 mb-1">Select Month</label>
                            <select id="month" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option>January</option>
                                <option>February</option>
                                <option>March</option>
                                <option>April</option>
                                <option>May</option>
                                <option>June</option>
                                <option>July</option>
                                <option>August</option>
                                <option>September</option>
                                <option>October</option>
                                <option>November</option>
                                <option>December</option>
                            </select>
                        </div>
                        <div>
                            <label for="year" class="block text-sm font-medium text-gray-700 mb-1">Select Year</label>
                            <select id="year" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <!-- Options will be populated by JS -->
                            </select>
                        </div>
                    </div>
    
                    <!-- Row 2: Salary and Attendance -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="baseSalary" class="block text-sm font-medium text-gray-700 mb-1">Base Salary</label>
                            <div class="flex">
                                <span class="inline-flex items-center px-3 rounded-l-lg border border-r-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">₹</span>
                                <input type="number" id="baseSalary" placeholder="e.g., 50000" class="w-full px-4 py-2 border border-gray-300 rounded-r-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label for="absentDays" class="block text-sm font-medium text-gray-700 mb-1">Absent</label>
                                <div class="flex">
                                    <input type="text" id="absentDays" placeholder="0" readonly class="w-full px-4 py-2 border border-gray-300 rounded-l-lg shadow-sm focus:outline-none bg-gray-50 cursor-pointer">
                                    <button id="openAbsentCalendar" class="px-3 py-2 border border-l-0 border-gray-300 rounded-r-lg bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label for="halfDays" class="block text-sm font-medium text-gray-700 mb-1">Half Days</label>
                                <div class="flex">
                                    <input type="text" id="halfDays" placeholder="0" readonly class="w-full px-4 py-2 border border-gray-300 rounded-l-lg shadow-sm focus:outline-none bg-gray-50 cursor-pointer">
                                    <button id="openHalfDayCalendar" class="px-3 py-2 border border-l-0 border-gray-300 rounded-r-lg bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label for="extraDays" class="block text-sm font-medium text-gray-700 mb-1">Extra Days</label>
                                <div class="flex">
                                    <input type="text" id="extraDays" placeholder="0" readonly class="w-full px-4 py-2 border border-gray-300 rounded-l-lg shadow-sm focus:outline-none bg-gray-50 cursor-pointer">
                                    <button id="openExtraDayCalendar" class="px-3 py-2 border border-l-0 border-gray-300 rounded-r-lg bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
    
                    <!-- Row 3: Additions -->
                    <div class="border-t border-gray-200 pt-6 space-y-6">
                        <h2 class="text-xl font-semibold text-gray-800">Additions</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="overtimeHours" class="block text-sm font-medium text-gray-700 mb-1">Overtime (Hours)</label>
                                <div class="flex">
                                    <span class="inline-flex items-center px-3 rounded-l-lg border border-r-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">Hrs</span>
                                    <input type="number" id="overtimeHours" placeholder="e.g., 2.5" class="w-full px-4 py-2 border border-gray-300 rounded-r-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            <div>
                                <label for="otherAddition" class="block text-sm font-medium text-gray-700 mb-1">Other Addition</label>
                                <div class="flex">
                                    <span class="inline-flex items-center px-3 rounded-l-lg border border-r-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">₹</span>
                                    <input type="number" id="otherAddition" placeholder="0.00" class="w-full px-4 py-2 border border-gray-300 rounded-r-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            <div class="md:col-span-2">
                                 <label for="otherAdditionRemark" class="block text-sm font-medium text-gray-700 mb-1">Other Addition Remark</label>
                                <input type="text" id="otherAdditionRemark" placeholder="e.g., Performance Bonus" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                    </div>
    
                    <!-- Row 4: Deductions -->
                    <div class="border-t border-gray-200 pt-6 space-y-6">
                        <h2 class="text-xl font-semibold text-gray-800">Deductions</h2>
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="advancePayment" class="block text-sm font-medium text-gray-700 mb-1">Advance Payment</label>
                                    <div class="flex">
                                        <span class="inline-flex items-center px-3 rounded-l-lg border border-r-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">₹</span>
                                        <input type="number" id="advancePayment" placeholder="0.00" class="w-full px-4 py-2 border border-gray-300 rounded-r-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>
                                <div>
                                    <label for="otherDeduction" class="block text-sm font-medium text-gray-700 mb-1">Other Deduction</label>
                                    <div class="flex">
                                        <span class="inline-flex items-center px-3 rounded-l-lg border border-r-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">₹</span>
                                        <input type="number" id="otherDeduction" placeholder="0.00" class="w-full px-4 py-2 border border-gray-300 rounded-r-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="advancePaymentRemark" class="block text-sm font-medium text-gray-700 mb-1">Advance Payment Remark</label>
                                    <input type="text" id="advancePaymentRemark" placeholder="e.g., Loan Installment" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label for="otherDeductionRemark" class="block text-sm font-medium text-gray-700 mb-1">Other Deduction Remark</label>
                                    <input type="text" id="otherDeductionRemark" placeholder="e.g., Canteen Bill" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                        </div>
                    </div>
    
    
                    <!-- Row 5: Calculate Button -->
                    <div class="border-t border-gray-200 pt-8">
                        <div class="flex gap-4">
                            <button id="calculateButton" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold text-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 shadow-md">
                                Calculate Pay
                            </button>
                            <button id="cancelEditButton" class="hidden w-1/3 bg-gray-200 text-gray-800 py-3 px-6 rounded-lg font-semibold text-lg hover:bg-gray-300 transition duration-200">
                                Cancel Edit
                            </button>
                        </div>
                        <p id="saveStatus" class="text-center text-green-600 text-sm mt-2 h-4"></p>
                    </div>
                </div>
    
                <!-- Summary Section (Hidden by default) -->
                <div id="summarySection" class="hidden mt-10 border-t border-gray-300 pt-8">
                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-6 text-center">
                        Pay Summary
                    </h2>
                    
                    <div class="bg-gray-50 p-6 rounded-lg shadow-inner border border-gray-200">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <div class="text-lg font-semibold text-gray-800" id="summaryEmployee"></div>
                                <div class="text-sm text-gray-500" id="summaryMonth"></div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-500">Pay Summary</div>
                                <div class="text-lg font-semibold text-gray-800" id="summaryDate"></div>
                            </div>
                        </div>
    
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            
                            <!-- Earnings Column -->
                            <div class="bg-white p-4 rounded-lg shadow-sm border">
                                <h3 class="font-bold text-lg text-green-700 mb-3 border-b pb-2">Earnings</h3>
                                <div class="space-y-2">
                                    <div class="flex justify-between text-gray-700">
                                        <span>Base Salary:</span>
                                        <span class="font-medium text-gray-900" id="summaryBase"></span>
                                    </div>
                                    <div class="flex justify-between text-gray-700">
                                        <span>Extra Day Addition:</span>
                                        <span class="font-medium text-gray-900" id="summaryExtraDay"></span>
                                    </div>
                                    <div id="summaryExtraDayDates" class="text-xs text-gray-500 italic pl-4 hidden"></div>
                                    <div class="flex justify-between text-gray-700">
                                        <span>Overtime Pay:</span>
                                        <span class="font-medium text-gray-900" id="summaryOvertime"></span>
                                    </div>
                                    <div id="summaryOvertimeHours" class="text-xs text-gray-500 italic pl-4 hidden"></div>
                                    <div class="flex justify-between text-gray-700">
                                        <span>Other Additions:</span>
                                        <span class="font-medium text-gray-900" id="summaryOtherAddition"></span>
                                    </div>
                                    <div id="summaryOtherAdditionRemark" class="text-xs text-gray-500 italic pl-4"></div>
                                    
                                    <div class="flex justify-between font-bold border-t pt-2 mt-2">
                                        <span class="text-gray-800">Total Earnings:</span>
                                        <span class="text-green-600" id="summaryTotalEarnings"></span>
                                    </div>
                                </div>
                            </div>
    
                            <!-- Deductions Column -->
                            <div class="bg-white p-4 rounded-lg shadow-sm border">
                                <h3 class="font-bold text-lg text-red-700 mb-3 border-b pb-2">Deductions</h3>
                                <div class="space-y-2">
                                    <div class="flex justify-between text-gray-700">
                                        <span>Absent Day Deduction:</span>
                                        <span class="font-medium text-gray-900" id="summaryAbsent"></span>
                                    </div>
                                    <div id="summaryAbsentDates" class="text-xs text-gray-500 italic pl-4 hidden"></div>
                                    <div class="flex justify-between text-gray-700">
                                        <span>Half Day Deduction:</span>
                                        <span class="font-medium text-gray-900" id="summaryHalfDay"></span>
                                    </div>
                                    <div id="summaryHalfDayDates" class="text-xs text-gray-500 italic pl-4 hidden"></div>
                                    <div class="flex justify-between text-gray-700">
                                        <span>Advance Payment:</span>
                                        <span class="font-medium text-gray-900" id="summaryAdvance"></span>
                                    </div>
                                    <div id="summaryAdvanceRemark" class="text-xs text-gray-500 italic pl-4"></div>
                                    <div class="flex justify-between text-gray-700">
                                        <span>Other Deductions:</span>
                                        <span class="font-medium text-gray-900" id="summaryOtherDeduction"></span>
                                    </div>
                                    <div id="summaryOtherDeductionRemark" class="text-xs text-gray-500 italic pl-4"></div>
    
                                    <div class="flex justify-between font-bold border-t pt-2 mt-2">
                                        <span class="text-gray-800">Total Deductions:</span>
                                        <span class="text-red-600" id="summaryTotalDeductions"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
    
                        <!-- Net Pay -->
                        <div class="mt-6 bg-blue-100 border border-blue-200 p-4 rounded-lg flex justify-between items-center text-xl sm:text-2xl font-bold">
                            <span class="text-blue-800">Net Pay:</span>
                            <span class="text-blue-700" id="summaryNetPay"></span>
                        </div>
    
                        <!-- Action Buttons -->
                        <div class="mt-8 grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <button id="saveRecordButton" class="w-full bg-green-600 text-white py-3 px-6 rounded-lg font-semibold text-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-200 shadow-md">
                                Save Record
                            </button>
                            <button id="downloadPdfButton" class="w-full bg-gray-600 text-white py-3 px-6 rounded-lg font-semibold text-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-200 shadow-md">
                                Download as PDF
                            </button>
                        </div>
                    </div>
    
                </div>
            </div>
        </div>

        <!-- Page 2: Salary Data (Hidden by default) -->
        <div id="salaryDataPage" class="hidden container mx-auto max-w-4xl p-4 sm:p-8">
            <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-6 text-center">
                    Saved Salary Data
                </h1>
    
                <!-- Filter Controls -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 p-4 bg-gray-50 rounded-lg border">
                    <div>
                        <label for="filterEmployeeName" class="block text-sm font-medium text-gray-700 mb-1">Filter by Employee</label>
                        <select id="filterEmployeeName" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All Employees</option>
                            <!-- Populated by JS from Firestore -->
                        </select>
                    </div>
                    <div>
                        <label for="filterMonth" class="block text-sm font-medium text-gray-700 mb-1">Filter by Month</label>
                        <select id="filterMonth" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All Months</option>
                            <option>January</option>
                            <option>February</option>
                            <option>March</option>
                            <option>April</option>
                            <option>May</option>
                            <option>June</option>
                            <option>July</option>
                            <option>August</option>
                            <option>September</option>
                            <option>October</option>
                            <option>November</option>
                            <option>December</option>
                        </select>
                    </div>
                    <div>
                        <label for="filterYear" class="block text-sm font-medium text-gray-700 mb-1">Filter by Year</label>
                        <select id="filterYear" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All Years</option>
                            <!-- Populated by JS from Firestore data -->
                        </select>
                    </div>
                </div>
                
                <!-- CSV Export Button -->
                <div class="mb-6 flex justify-end">
                    <button id="exportCsvButton" class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition duration-200 shadow-md flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        Export to CSV
                    </button>
                </div>
                
                <div id="salaryRecordsContainer" class="space-y-4">
                    <!-- Salary records will be populated here by JS -->
                    <p id="noRecordsText" class="text-gray-500 text-center italic">Loading records...</p>
                </div>
            </div>
        </div>

        <!-- Page 3: Analysis (Hidden by default) -->
        <div id="analysisPage" class="hidden container mx-auto max-w-4xl p-4 sm:p-8">
            <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-6 text-center">
                    Salary Data Analysis
                </h1>
    
                <div id="analysisContent" class="space-y-6">
                    
                    <!-- Chart Section -->
                    <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-md">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4" id="analysisChartTitle">Total Salary Paid Per Month (Current Mode)</h3>
                        <div class="relative h-64 sm:h-80">
                            <canvas id="myChart"></canvas>
                        </div>
                    </div>
    
                    <!-- Stat Cards Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        
                        <!-- Total Distributed -->
                        <div class="bg-blue-50 p-6 rounded-xl border border-blue-200 shadow-md">
                            <h3 class="text-sm font-medium text-blue-600 uppercase tracking-wide">Total Salary Distributed (All Modes)</h3>
                            <p class="text-4xl font-bold text-blue-800 mt-2" id="analysisTotalDistributed">₹0.00</p>
                        </div>
    
                        <!-- Total Payslips -->
                        <div class="bg-green-50 p-6 rounded-xl border border-green-200 shadow-md">
                            <h3 class="text-sm font-medium text-green-600 uppercase tracking-wide">Total Payslips Issued (All Modes)</h3>
                            <p class="text-4xl font-bold text-green-800 mt-2" id="analysisTotalPayslips">0</p>
                        </div>
    
                        <!-- Average Pay -->
                        <div class="bg-indigo-50 p-6 rounded-xl border border-indigo-200 shadow-md">
                            <h3 class="text-sm font-medium text-indigo-600 uppercase tracking-wide">Average Net Pay (All Modes)</h3>
                            <p class="text-4xl font-bold text-indigo-800 mt-2" id="analysisAveragePay">₹0.00</p>
                        </div>
    
                        <!-- Highest Single Payslip -->
                        <div class="bg-yellow-50 p-6 rounded-xl border border-yellow-200 shadow-md">
                            <h3 class="text-sm font-medium text-yellow-600 uppercase tracking-wide">Highest Single Payslip (All Modes)</h3>
                            <p class="text-4xl font-bold text-yellow-800 mt-2" id="analysisHighestPayslipAmount">₹0.00</p>
                            <p class="text-sm text-gray-600 mt-1" id="analysisHighestPayslipEmployee">N/A</p>
                        </div>
    
                        <!-- Most Leave Taken -->
                        <div class="bg-red-50 p-6 rounded-xl border border-red-200 shadow-md">
                            <h3 class="text-sm font-medium text-red-600 uppercase tracking-wide">Most Leave Taken (Current Mode)</h3>
                            <p class="text-4xl font-bold text-red-800 mt-2" id="analysisMostLeave">0 days</p>
                            <p class="text-sm text-gray-600 mt-1" id="analysisMostLeaveEmployee">N/A</p>
                        </div>
    
                        <!-- Most Active Worker -->
                        <div class="bg-green-50 p-6 rounded-xl border border-green-200 shadow-md">
                            <h3 class="text-sm font-medium text-green-600 uppercase tracking-wide">Most Active Worker (Least Leave)</h3>
                            <p class="text-4xl font-bold text-green-800 mt-2" id="analysisMostActive">0 days</p>
                            <p class="text-sm text-gray-600 mt-1" id="analysisMostActiveEmployee">N/A</p>
                        </div>
                    </div>
    
                    <!-- Financial Summary -->
                    <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-md">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Financial Summary (All Modes)</h3>
                        <div class="flex justify-around items-center">
                            <div class="text-center">
                                <p class="text-sm font-medium text-green-600 uppercase">Total Earnings</p>
                                <p class="text-2xl font-bold text-green-700" id="analysisTotalEarnings">₹0.00</p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm font-medium text-red-600 uppercase">Total Deductions</p>
                                <p class="text-2xl font-bold text-red-700" id="analysisTotalDeductions">₹0.00</p>
                            </div>
                        </div>
                    </div>
    
                    <!-- Top Paid Employees -->
                    <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-md">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Total Pay by Employee (Current Mode)</h3>
                        <ul class="space-y-3 max-h-60 overflow-y-auto" id="analysisEmployeeTotalsList">
                            <!-- Employee totals will be populated here -->
                        </ul>
                    </div>
                </div>
                
                <p id="noAnalysisDataText" class="text-gray-500 text-center italic hidden">No salary data found to analyze.</p>
    
            </div>
        </div>
    </div> <!-- End of #mainAppContainer -->


    <!-- Employee Management Modal -->
    <div id="employeeModal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-white w-full max-w-md p-6 rounded-xl shadow-2xl transform scale-95">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800" id="employeeModalTitle">Manage Employees</h2>
                <button id="closeEmployeeModal" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            
            <!-- List of Employees -->
            <div id="employeeListContainer" class="max-h-60 overflow-y-auto space-y-2 mb-4 pr-2">
                <!-- Employee items will be populated by JS from Firestore -->
                <p class="text-gray-500 text-sm italic">Loading employees...</p>
            </div>

            <!-- Add/Edit Employee Form -->
            <div class="border-t pt-4">
                <h3 class="text-lg font-semibold text-gray-800 mb-2" id="employeeFormTitle">Add New Employee</h3>
                <div class="space-y-3">
                    <div>
                        <label for="newEmployeeName" class="block text-sm font-medium text-gray-700 mb-1">Employee Name</label>
                        <input type="text" id="newEmployeeName" placeholder="Enter name" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="newEmployeeSalary" class="block text-sm font-medium text-gray-700 mb-1">Default Base Salary</label>
                        <div class="flex">
                            <span class="inline-flex items-center px-3 rounded-l-lg border border-r-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">₹</span>
                            <input type="number" id="newEmployeeSalary" placeholder="e.g., 30000" class="w-full px-4 py-2 border border-gray-300 rounded-r-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button id="addEmployeeBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-200">Add Employee</button>
                        <button id="updateEmployeeBtn" class="hidden w-full bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition duration-200">Update Employee</button>
                        <button id="cancelEmployeeUpdateBtn" class="hidden w-1/3 bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
                    </div>
                    <p id="employeeError" class="text-red-500 text-xs mt-1 h-4"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Employee Delete Modal -->
    <div id="confirmDeleteModal" class="modal fixed inset-0 z-60 flex items-center justify-center bg-black bg-opacity-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-white w-full max-w-sm p-6 rounded-xl shadow-2xl transform scale-95">
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Confirm Deletion</h3>
            <p class="text-gray-600 mb-6">Are you sure you want to delete <strong id="employeeToDeleteName"></strong>?</p>
            <div class="flex justify-end gap-3">
                <button id="cancelDeleteBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="confirmDeleteBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>
    
    <!-- Confirm Record Delete Modal -->
    <div id="confirmRecordDeleteModal" class="modal fixed inset-0 z-60 flex items-center justify-center bg-black bg-opacity-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-white w-full max-w-sm p-6 rounded-xl shadow-2xl transform scale-95">
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Confirm Record Deletion</h3>
            <p class="text-gray-600 mb-6">Are you sure you want to delete this salary record for <strong id="recordToDeleteName"></strong>?</p>
            <div class="flex justify-end gap-3">
                <button id="cancelRecordDeleteBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="confirmRecordDeleteBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <!-- Calendar Modal -->
    <div id="calendarModal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-white w-full max-w-md p-6 rounded-xl shadow-2xl transform scale-95">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800" id="calendarHeader">Select Dates</h2>
                <button id="closeCalendarModal" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            
            <div class="calendar-grid mb-4" id="calendarGrid">
                <!-- Calendar will be built here by JS -->
            </div>

            <div class="flex justify-end gap-3">
                <button id="cancelCalendarBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="saveCalendarBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Save Dates</button>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="passwordModal" class="modal fixed inset-0 z-60 flex items-center justify-center bg-black bg-opacity-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-white w-full max-w-sm p-6 rounded-xl shadow-2xl transform scale-95">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Enter Owner Password</h3>
            <input type="password" id="passwordInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <p id="passwordError" class="text-red-500 text-xs mt-1 h-4"></p>
            <div class="flex justify-end gap-3 mt-4">
                <button id="cancelPasswordBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="submitPasswordBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Login</button>
            </div>
        </div>
    </div>

    <!-- Firebase and App Logic -->
    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            addDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            getDocs,
            Timestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config and Global Vars ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // Use user-provided config as a fallback
        const userFirebaseConfig = {
            apiKey: "AIzaSyCMppXprg2OJswgLSXmmPgyhaRhxwDp0NA",
            authDomain: "salarymanagement-7f0ec.firebaseapp.com",
            projectId: "salarymanagement-7f0ec",
            storageBucket: "salarymanagement-7f0ec.firebasestorage.app",
            messagingSenderId: "857263287159",
            appId: "1:857263287159:web:70b284c66afa5be7590f72"
        };
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify(userFirebaseConfig));
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId;
        let employeesCollection, salaryRecordsCollection;

        // --- App State ---
        let salaryRecords = []; // Will be populated from Firestore
        let employees = []; // Will be populated from Firestore
        let employeeToDelete = null; // Stores {id, name}
        let recordToDeleteId = null; // Stores ID of salary record to delete
        let lastCalculationData = null; // To store data for PDF generation
        let currentEditingRecordId = null; // To track if we are in edit mode
        let currentMode = "accountant"; // 'accountant' or 'owner'
        let chartInstance = null; // To hold the Chart.js instance

        // --- DOM Elements ---
        const employeeSelect = document.getElementById('employeeName');
        const manageEmployeesBtn = document.getElementById('manageEmployeesBtn');
        const employeeModal = document.getElementById('employeeModal');
        const closeEmployeeModal = document.getElementById('closeEmployeeModal');
        const employeeListContainer = document.getElementById('employeeListContainer');
        const newEmployeeNameInput = document.getElementById('newEmployeeName');
        const newEmployeeSalaryInput = document.getElementById('newEmployeeSalary');
        const addEmployeeBtn = document.getElementById('addEmployeeBtn');
        const updateEmployeeBtn = document.getElementById('updateEmployeeBtn');
        const cancelEmployeeUpdateBtn = document.getElementById('cancelEmployeeUpdateBtn');
        const employeeFormTitle = document.getElementById('employeeFormTitle');
        const employeeError = document.getElementById('employeeError');
        
        const confirmDeleteModal = document.getElementById('confirmDeleteModal');
        const employeeToDeleteName = document.getElementById('employeeToDeleteName');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        
        const confirmRecordDeleteModal = document.getElementById('confirmRecordDeleteModal');
        const recordToDeleteName = document.getElementById('recordToDeleteName');
        const cancelRecordDeleteBtn = document.getElementById('cancelRecordDeleteBtn');
        const confirmRecordDeleteBtn = document.getElementById('confirmRecordDeleteBtn');

        // --- Calendar Modal Elements ---
        const calendarModal = document.getElementById('calendarModal');
        const openAbsentCalendarBtn = document.getElementById('openAbsentCalendar');
        const openHalfDayCalendarBtn = document.getElementById('openHalfDayCalendar');
        const openExtraDayCalendarBtn = document.getElementById('openExtraDayCalendar');
        const closeCalendarModalBtn = document.getElementById('closeCalendarModal');
        const cancelCalendarBtn = document.getElementById('cancelCalendarBtn');
        const saveCalendarBtn = document.getElementById('saveCalendarBtn');
        const calendarGrid = document.getElementById('calendarGrid');
        const calendarHeader = document.getElementById('calendarHeader');
        const absentDaysInput = document.getElementById('absentDays');
        const halfDaysInput = document.getElementById('halfDays');
        const extraDaysInput = document.getElementById('extraDays');
        const downloadPdfButton = document.getElementById('downloadPdfButton');
        const saveStatus = document.getElementById('saveStatus');
        const calculateButton = document.getElementById('calculateButton');
        const cancelEditButton = document.getElementById('cancelEditButton');
        const saveRecordButton = document.getElementById('saveRecordButton');

        // --- Tab Navigation Elements ---
        const dashboardTab = document.getElementById('dashboardTab');
        const salaryDataTab = document.getElementById('salaryDataTab');
        const dashboardPage = document.getElementById('dashboardPage');
        const salaryDataPage = document.getElementById('salaryDataPage');
        const salaryRecordsContainer = document.getElementById('salaryRecordsContainer');
        const noRecordsText = document.getElementById('noRecordsText');
        const exportCsvButton = document.getElementById('exportCsvButton');

        // --- Page 3: Analysis Elements ---
        const analysisTab = document.getElementById('analysisTab');
        const analysisPage = document.getElementById('analysisPage');
        const analysisContent = document.getElementById('analysisContent');
        const noAnalysisDataText = document.getElementById('noAnalysisDataText');
        const analysisTotalDistributed = document.getElementById('analysisTotalDistributed');
        const analysisTotalPayslips = document.getElementById('analysisTotalPayslips');
        const analysisAveragePay = document.getElementById('analysisAveragePay');
        const analysisHighestPayslipAmount = document.getElementById('analysisHighestPayslipAmount');
        const analysisHighestPayslipEmployee = document.getElementById('analysisHighestPayslipEmployee');
        const analysisTotalEarnings = document.getElementById('analysisTotalEarnings');
        const analysisTotalDeductions = document.getElementById('analysisTotalDeductions');
        const analysisEmployeeTotalsList = document.getElementById('analysisEmployeeTotalsList');
        const analysisChartTitle = document.getElementById('analysisChartTitle');
        const analysisMostLeave = document.getElementById('analysisMostLeave');
        const analysisMostLeaveEmployee = document.getElementById('analysisMostLeaveEmployee');
        const analysisMostActive = document.getElementById('analysisMostActive');
        const analysisMostActiveEmployee = document.getElementById('analysisMostActiveEmployee');

        // --- Filter Elements ---
        const filterEmployeeName = document.getElementById('filterEmployeeName');
        const filterMonth = document.getElementById('filterMonth');
        const filterYear = document.getElementById('filterYear');
        
        // --- Mode Switch Elements ---
        const modeSwitchBtn = document.getElementById('modeSwitchBtn');
        const passwordModal = document.getElementById('passwordModal');
        const passwordInput = document.getElementById('passwordInput');
        const passwordError = document.getElementById('passwordError');
        const cancelPasswordBtn = document.getElementById('cancelPasswordBtn');
        const submitPasswordBtn = document.getElementById('submitPasswordBtn');

        // --- Lock Screen Elements (NEW) ---
        const dashboardLockModal = document.getElementById('dashboardLockModal');
        const lockPinInput = document.getElementById('lockPinInput');
        const unlockDashboardBtn = document.getElementById('unlockDashboardBtn');
        const lockError = document.getElementById('lockError');
        const mainAppContainer = document.getElementById('mainAppContainer');

        // --- Calendar State ---
        let tempSelectedDates = [];
        let currentCalendarInput = null;
        let currentEmployeeEditingId = null;
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

        // --- Modal Utility Functions ---
        const showModal = (modal) => {
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.querySelector('.modal-content').classList.remove('scale-95');
        };

        const hideModal = (modal) => {
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.querySelector('.modal-content').classList.add('scale-95');
        };

        /**
         * Renders the fetched salary records on the Salary Data page.
         */
        function renderSalaryRecords() {
            // 1. Get filter values
            const nameFilter = filterEmployeeName.value;
            const monthFilter = filterMonth.value;
            const yearFilter = filterYear.value;

            // 2. Filter the global salaryRecords array
            const filteredRecords = salaryRecords.filter(record => {
                const modeMatch = record.createdByMode === currentMode;
                const nameMatch = !nameFilter || record.employeeName === nameFilter;
                const monthMatch = !monthFilter || record.month === monthFilter;
                const yearMatch = !yearFilter || record.year == yearFilter; // Use '==' for string/number
                
                return modeMatch && nameMatch && monthMatch && yearMatch;
            });

            // 3. Render the *filtered* array
            salaryRecordsContainer.innerHTML = ''; // Clear existing
            
            if (filteredRecords.length === 0) {
                if (salaryRecords.length === 0) {
                    noRecordsText.textContent = "No salary records found.";
                } else {
                    noRecordsText.textContent = `No salary records found for this mode${nameFilter || monthFilter || yearFilter ? ' with current filters' : ''}.`;
                }
                noRecordsText.classList.remove('hidden');
                return;
            }
            
            noRecordsText.classList.add('hidden');
            
            // PDF-safe currency formatter
            const formatPdfCurrency = (amount) => {
                const fixedAmount = (amount || 0).toFixed(2);
                const parts = fixedAmount.split('.');
                let integerPart = parts[0];
                const decimalPart = parts[1];
                integerPart = integerPart.replace(/(\d)(?=(\d\d)+\d$)/g, "$1,");
                return `Rs. ${integerPart}.${decimalPart}`;
            };

            filteredRecords.forEach(record => { // Use filteredRecords
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-lg shadow-sm border flex flex-col sm:flex-row justify-between items-start";
                
                // Use the JS Date object created when saving
                const recordDate = record.createdAt ? record.createdAt.toLocaleString('en-IN', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true }) : 'N/A';

                card.innerHTML = `
                    <div class="mb-4 sm:mb-0">
                        <h3 class="text-lg font-semibold text-gray-800">${record.employeeName}</h3>
                        <p class="text-sm text-gray-600">For ${record.month}, ${record.year}</p>
                        <p class="text-xs text-gray-400">Saved on: ${recordDate}</p>
                    </div>
                    <div class="flex flex-col items-start sm:items-end w-full sm:w-auto">
                        <span class="text-xl font-bold text-blue-700">${formatPdfCurrency(record.netPay)}</span>
                        <div class="flex gap-2 mt-2">
                            <button class="edit-record-btn bg-blue-100 text-blue-700 text-sm font-medium py-1 px-3 rounded-full hover:bg-blue-200" data-id="${record.id}">
                                Edit
                            </button>
                            <button class="delete-record-btn bg-red-100 text-red-700 text-sm font-medium py-1 px-3 rounded-full hover:bg-red-200" data-id="${record.id}" data-name="${record.employeeName}">
                                Delete
                            </button>
                            <button class="download-record-pdf-btn bg-green-100 text-green-700 text-sm font-medium py-1 px-3 rounded-full hover:bg-green-200" data-id="${record.id}">
                                PDF
                            </button>
                        </div>
                    </div>
                `;
                salaryRecordsContainer.appendChild(card);
            });
        }

        /**
         * Calculates and renders the analysis page.
         */
        function renderAnalysis() {
            // PDF-safe currency formatter
            const formatPdfCurrency = (amount) => {
                const fixedAmount = (amount || 0).toFixed(2);
                const parts = fixedAmount.split('.');
                let integerPart = parts[0];
                const decimalPart = parts[1];
                integerPart = integerPart.replace(/(\d)(?=(\d\d)+\d$)/g, "$1,");
                return `Rs. ${integerPart}.${decimalPart}`;
            };

            // Use ALL records for main stats, regardless of mode
            const allRecords = salaryRecords;
            // Use MODE-SPECIFIC records for detailed lists and charts
            const modeRecords = salaryRecords.filter(r => r.createdByMode === currentMode);

            if (allRecords.length === 0) {
                analysisContent.classList.add('hidden');
                noAnalysisDataText.classList.remove('hidden');
                return;
            }

            analysisContent.classList.remove('hidden');
            noAnalysisDataText.classList.add('hidden');

            // --- Perform Calculations ---

            // 1. Total Salary Distributed (All Modes)
            const totalDistributed = allRecords.reduce((acc, r) => acc + (r.netPay || 0), 0);
            
            // 2. Total Payslips (All Modes)
            const totalPayslips = allRecords.length;

            // 3. Average Pay (All Modes)
            const averagePay = totalPayslips > 0 ? (totalDistributed / totalPayslips) : 0;

            // 4. Highest Single Payslip (All Modes)
            const highestPayslip = allRecords.reduce((max, r) => (r.netPay > max.netPay) ? r : max, { netPay: -Infinity });

            // 5. Total Earnings vs Deductions (All Modes)
            const totalEarnings = allRecords.reduce((acc, r) => acc + (r.totalEarnings || 0), 0);
            const totalDeductions = allRecords.reduce((acc, r) => acc + (r.totalDeductions || 0), 0);

            // 6. Total Pay by Employee (CURRENT MODE ONLY)
            const employeeTotals = modeRecords.reduce((acc, r) => {
                const name = r.employeeName;
                if (!acc[name]) {
                    acc[name] = 0;
                }
                acc[name] += (r.netPay || 0);
                return acc;
            }, {});

            const sortedEmployeeTotals = Object.entries(employeeTotals)
                .map(([name, total]) => ({ name, total }))
                .sort((a, b) => b.total - a.total); // Sort descending

            // 7. Attendance Analysis (CURRENT MODE ONLY)
            const employeeAttendance = modeRecords.reduce((acc, r) => {
                const name = r.employeeName;
                if (!acc[name]) {
                    acc[name] = 0;
                }
                // Leave = full absent days + 0.5 for each half day
                const leave = (r.absentDays || 0) + ((r.halfDays || 0) * 0.5);
                acc[name] += leave;
                return acc;
            }, {});

            const sortedAttendance = Object.entries(employeeAttendance)
                .map(([name, totalLeaveDays]) => ({ name, totalLeaveDays }))
                .sort((a, b) => b.totalLeaveDays - a.totalLeaveDays); // Sort descending

            let mostLeave = null;
            let mostActive = null;

            if (sortedAttendance.length > 0) {
                mostLeave = sortedAttendance[0];
                mostActive = sortedAttendance[sortedAttendance.length - 1]; // Last item is the lowest
            }


            // 8. Monthly Totals for Chart (CURRENT MODE ONLY)
            const monthlyTotals = modeRecords.reduce((acc, r) => {
                const monthIndex = monthNames.indexOf(r.month);
                const key = `${r.year}-${String(monthIndex).padStart(2, '0')}`; // e.g., "2025-09"
                if (!acc[key]) {
                    acc[key] = { total: 0, label: `${r.month.substring(0, 3)} ${r.year}` };
                }
                acc[key].total += (r.netPay || 0);
                return acc;
            }, {});

            const sortedMonthlyTotals = Object.entries(monthlyTotals)
                .map(([key, data]) => ({ key, ...data }))
                .sort((a, b) => a.key.localeCompare(b.key)); // Sort chronologically


            // --- Update DOM ---
            analysisTotalDistributed.textContent = formatPdfCurrency(totalDistributed);
            analysisTotalPayslips.textContent = totalPayslips;
            analysisAveragePay.textContent = formatPdfCurrency(averagePay);

            if (highestPayslip.netPay > -Infinity) {
                analysisHighestPayslipAmount.textContent = formatPdfCurrency(highestPayslip.netPay);
                analysisHighestPayslipEmployee.textContent = `To ${highestPayslip.employeeName} for ${highestPayslip.month}, ${highestPayslip.year}`;
            } else {
                analysisHighestPayslipAmount.textContent = "N/A";
                analysisHighestPayslipEmployee.textContent = "";
            }

            analysisTotalEarnings.textContent = formatPdfCurrency(totalEarnings);
            analysisTotalDeductions.textContent = formatPdfCurrency(totalDeductions);

            // Update new attendance cards
            if (mostLeave && mostLeave.totalLeaveDays > 0) {
                analysisMostLeave.textContent = `${mostLeave.totalLeaveDays} days`;
                analysisMostLeaveEmployee.textContent = mostLeave.name;
            } else {
                analysisMostLeave.textContent = "0 days";
                analysisMostLeaveEmployee.textContent = "N/A";
            }

            if (mostActive) {
                analysisMostActive.textContent = `${mostActive.totalLeaveDays} days`;
                analysisMostActiveEmployee.textContent = mostActive.name;
            } else {
                analysisMostActive.textContent = "0 days";
                analysisMostActiveEmployee.textContent = "N/A";
            }

            // Populate employee list
            analysisEmployeeTotalsList.innerHTML = '';
            if (sortedEmployeeTotals.length > 0) {
                sortedEmployeeTotals.forEach(emp => {
                    const li = document.createElement('li');
                    li.className = "flex justify-between items-center p-3 bg-gray-50 rounded-lg border";
                    li.innerHTML = `
                        <span class="font-medium text-gray-700">${emp.name}</span>
                        <span class="font-bold text-gray-900">${formatPdfCurrency(emp.total)}</span>
                    `;
                    analysisEmployeeTotalsList.appendChild(li);
                });
            } else {
                analysisEmployeeTotalsList.innerHTML = `<li class="text-gray-500 italic">No employee data to show in ${currentMode} mode.</li>`;
            }
            
            // Update Chart Title
            analysisChartTitle.textContent = `Total Salary Paid Per Month (${currentMode.charAt(0).toUpperCase() + currentMode.slice(1)} Mode)`;
            
            // Render Chart
            const chartLabels = sortedMonthlyTotals.map(m => m.label);
            const chartData = sortedMonthlyTotals.map(m => m.total);
            
            const ctx = document.getElementById('myChart').getContext('2d');
            
            if (chartInstance) {
                chartInstance.destroy(); // Destroy old chart before creating new one
            }
            
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'Total Salary Paid',
                        data: chartData,
                        backgroundColor: 'rgba(59, 130, 246, 0.5)', // bg-blue-500 with opacity
                        borderColor: 'rgba(59, 130, 246, 1)', // border-blue-500
                        borderWidth: 1,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '₹' + value.toLocaleString('en-IN');
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toLocaleString('en-IN', { style: 'currency', currency: 'INR' });
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }


        // --- Employee Data Functions (Firestore) ---

        /**
         * Populates all employee dropdowns from the global 'employees' array.
         */
        function renderEmployeeSelect() {
            const currentSelection = employeeSelect.value;
            const currentFilterSelection = filterEmployeeName.value; // Save filter selection
            
            employeeSelect.innerHTML = '<option value="">Select Employee</option>';
            filterEmployeeName.innerHTML = '<option value="">All Employees</option>'; // Add default
            
            // Sort by name
            const sortedEmployees = [...employees].sort((a, b) => a.name.localeCompare(b.name)); 
            
            sortedEmployees.forEach(emp => {
                // For dashboard dropdown
                const option = document.createElement('option');
                option.value = emp.name;
                option.textContent = emp.name;
                option.dataset.salary = emp.baseSalary || ""; // Store salary
                if (emp.name === currentSelection) {
                    option.selected = true;
                }
                employeeSelect.appendChild(option);

                // For filter dropdown
                const filterOption = document.createElement('option');
                filterOption.value = emp.name;
                filterOption.textContent = emp.name;
                if (emp.name === currentFilterSelection) { // Restore filter selection
                    filterOption.selected = true;
                }
                filterEmployeeName.appendChild(filterOption);
            });
        }

        /**
         * Renders the list in the 'Manage Employees' modal.
         */
        function renderEmployeeManagementList() {
            employeeListContainer.innerHTML = '';
            if (employees.length === 0) {
                employeeListContainer.innerHTML = '<p class="text-gray-500 text-sm italic">No employees added.</p>';
                return;
            }
            
            // Sort by name
            const sortedEmployees = [...employees].sort((a, b) => a.name.localeCompare(b.name)); 

            sortedEmployees.forEach(emp => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg border';
                const salaryDisplay = emp.baseSalary ? `(₹${emp.baseSalary.toLocaleString('en-IN')})` : '(No Salary Set)';
                div.innerHTML = `
                    <div>
                        <span class="text-gray-800 font-medium">${emp.name}</span>
                        <span class="text-gray-500 text-sm ml-2">${salaryDisplay}</span>
                    </div>
                    <div class="flex gap-2">
                        <button class="edit-employee-btn text-blue-600 hover:text-blue-800 font-medium" data-id="${emp.id}" data-name="${emp.name}" data-salary="${emp.baseSalary || ''}">Edit</button>
                        <button class="delete-employee-btn text-red-500 hover:text-red-700 font-medium" data-id="${emp.id}" data-name="${emp.name}">Delete</button>
                    </div>
                `;
                employeeListContainer.appendChild(div);
            });
        }
        
        /**
         * Resets the employee management form to 'Add' mode.
         */
        function resetEmployeeForm() {
            currentEmployeeEditingId = null;
            employeeFormTitle.textContent = "Add New Employee";
            newEmployeeNameInput.value = "";
            newEmployeeSalaryInput.value = "";
            addEmployeeBtn.classList.remove('hidden');
            updateEmployeeBtn.classList.add('hidden');
            cancelEmployeeUpdateBtn.classList.add('hidden');
            employeeError.classList.add('hidden');
        }

        /**
         * Adds a new employee to Firestore.
         */
        async function addEmployee() {
            const name = newEmployeeNameInput.value.trim();
            const baseSalary = parseFloat(newEmployeeSalaryInput.value) || 0;
            
            if (!name) {
                employeeError.textContent = 'Please enter a name.';
                employeeError.classList.remove('hidden');
                return;
            }
            if (employees.some(emp => emp.name.toLowerCase() === name.toLowerCase())) {
                employeeError.textContent = 'This employee already exists.';
                employeeError.classList.remove('hidden');
                return;
            }

            try {
                addEmployeeBtn.disabled = true;
                addEmployeeBtn.textContent = "Adding...";
                const docRef = await addDoc(employeesCollection, {
                    name: name,
                    baseSalary: baseSalary,
                    createdAt: Timestamp.now()
                });
                console.log("Employee added with ID: ", docRef.id);
                
                resetEmployeeForm(); // Reset form after successful add
                
                // Also clear the main form to avoid confusion
                clearForm();
                document.getElementById('summarySection').classList.add('hidden');
                
            } catch (error) {
                console.error("Error adding employee:", error);
                employeeError.textContent = "Error adding employee. Please try again.";
                employeeError.classList.remove('hidden');
            } finally {
                addEmployeeBtn.disabled = false;
                addEmployeeBtn.textContent = "Add Employee";
            }
        }
        
        /**
         * Updates an existing employee in Firestore.
         */
        async function updateEmployee() {
            const name = newEmployeeNameInput.value.trim();
            const baseSalary = parseFloat(newEmployeeSalaryInput.value) || 0;

            if (!name || !currentEmployeeEditingId) {
                employeeError.textContent = 'An error occurred. Please try again.';
                employeeError.classList.remove('hidden');
                return;
            }
            
            // Check if name already exists (and it's not the employee we are editing)
            if (employees.some(emp => emp.name.toLowerCase() === name.toLowerCase() && emp.id !== currentEmployeeEditingId)) {
                employeeError.textContent = 'This employee name already exists.';
                employeeError.classList.remove('hidden');
                return;
            }
            
            try {
                updateEmployeeBtn.disabled = true;
                updateEmployeeBtn.textContent = "Updating...";
                
                const docRef = doc(db, employeesCollection.path, currentEmployeeEditingId);
                await updateDoc(docRef, {
                    name: name,
                    baseSalary: baseSalary
                });
                
                console.log("Employee updated successfully:", name);
                resetEmployeeForm();
                
            } catch (error) {
                console.error("Error updating employee:", error);
                employeeError.textContent = "Error updating employee. Please try again.";
                employeeError.classList.remove('hidden');
            } finally {
                updateEmployeeBtn.disabled = false;
                updateEmployeeBtn.textContent = "Update Employee";
            }
        }
        
        /**
         * Deletes an employee from Firestore.
         */
        async function confirmDeleteEmployee() {
            if (!employeeToDelete) {
                console.error("No employee selected for deletion.");
                hideModal(confirmDeleteModal);
                return;
            }

            confirmDeleteBtn.disabled = true;
            confirmDeleteBtn.textContent = "Deleting...";

            try {
                const docRef = doc(db, employeesCollection.path, employeeToDelete.id);
                await deleteDoc(docRef);
                console.log("Employee deleted successfully:", employeeToDelete.name);
            } catch (error) {
                console.error("Error deleting employee:", error);
            } finally {
                hideModal(confirmDeleteModal);
                employeeToDelete = null;
                confirmDeleteBtn.disabled = false;
                confirmDeleteBtn.textContent = "Delete";
                // List will auto-update thanks to onSnapshot
            }
        }
        
        /**
         * Deletes a salary record from Firestore.
         */
        async function confirmDeleteRecord() {
            if (!recordToDeleteId) {
                console.error("No record selected for deletion.");
                hideModal(confirmRecordDeleteModal);
                return;
            }

            confirmRecordDeleteBtn.disabled = true;
            confirmRecordDeleteBtn.textContent = "Deleting...";

            try {
                const docRef = doc(db, salaryRecordsCollection.path, recordToDeleteId);
                await deleteDoc(docRef);
                console.log("Record deleted successfully:", recordToDeleteId);
            } catch (error) {
                console.error("Error deleting record:", error);
            } finally {
                hideModal(confirmRecordDeleteModal);
                recordToDeleteId = null;
                confirmRecordDeleteBtn.disabled = false;
                confirmRecordDeleteBtn.textContent = "Delete";
                // List will auto-update thanks to onSnapshot
            }
        }
        
        /**
         * Saves or updates the calculated salary record to Firestore.
         */
        async function saveSalaryRecord(recordData) {
            try {
                saveRecordButton.disabled = true;
                
                const newRecord = {
                    ...recordData,
                    createdByMode: currentMode, // Tag the record with the current mode
                    createdAt: Timestamp.now() // Use Firestore Timestamp
                };

                if (currentEditingRecordId) {
                    // This is an UPDATE
                    saveRecordButton.textContent = "Saving Updates...";
                    const docRef = doc(db, salaryRecordsCollection.path, currentEditingRecordId);
                    await updateDoc(docRef, recordData); // Only save the data, not createdAt
                    console.log("Salary record updated in Firestore with ID:", currentEditingRecordId);
                    saveStatus.textContent = "Updates saved successfully!";
                } else {
                    // This is a NEW record
                    saveRecordButton.textContent = "Saving Record...";
                    const docRef = await addDoc(salaryRecordsCollection, newRecord);
                    console.log("Salary record saved to Firestore with ID:", docRef.id);
                    saveStatus.textContent = "Saved successfully!";
                }
                
                setTimeout(() => saveStatus.textContent = "", 2000); // Clear message
                
                // After saving, reset the form
                resetToCalculateMode();
                clearForm();

            } catch (error) {
                console.error("Error saving salary record to Firestore:", error);
                saveStatus.textContent = "Error saving record.";
                setTimeout(() => saveStatus.textContent = "", 2000); // Clear message
            } finally {
                saveRecordButton.disabled = false;
                // Text is reset in resetToCalculateMode()
            }
        }

        /**
         * Sets up a real-time listener for the employees collection.
         */
        function listenForEmployees() {
            if (!employeesCollection) return;
            onSnapshot(employeesCollection, (snapshot) => {
                employees = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Employees updated:", employees);
                renderEmployeeSelect();
                renderEmployeeManagementList();
            }, (error) => {
                console.error("Error listening for employees:", error);
                employeeListContainer.innerHTML = '<p class="text-red-500 text-sm italic">Error loading employees.</p>';
            });
        }

        /**
         * Sets up a real-time listener for the salary records collection.
         */
        function listenForSalaryRecords() {
            if (!salaryRecordsCollection) return;

            const q = query(salaryRecordsCollection); 
            // Note: We will sort in JS. Firestore sorting requires indexes.
            
            onSnapshot(q, (snapshot) => {
                salaryRecords = snapshot.docs.map(doc => {
                    const data = doc.data();
                    let createdAtDate = null; // Default to null

                    if (data.createdAt) {
                        // Check if it's a Firestore Timestamp (new data)
                        if (typeof data.createdAt.toDate === 'function') {
                            createdAtDate = data.createdAt.toDate();
                        } 
                        // Check if it's a string (potentially old data)
                        else if (typeof data.createdAt === 'string') {
                            createdAtDate = new Date(data.createdAt);
                            // If string is invalid, reset to null
                            if (isNaN(createdAtDate.getTime())) {
                                createdAtDate = null;
                            }
                        }
                    }
                    // If data.createdAt is missing, it remains null

                    return {
                        id: doc.id,
                        ...data,
                        // This is now either a valid Date object or null
                        createdAt: createdAtDate 
                    };
                });

                // Sort in JavaScript (newest first)
                salaryRecords.sort((a, b) => b.createdAt - a.createdAt);

                console.log("Salary records updated:", salaryRecords);
                renderSalaryRecords(); // Re-render the list on the data page
                
                // Re-render analysis if on that page
                if (!analysisPage.classList.contains('hidden')) {
                    renderAnalysis();
                }
            }, (error) => {
                console.error("Error listening for salary records:", error);
                noRecordsText.textContent = "Error loading salary records.";
                noRecordsText.classList.remove('hidden');
            });
        }


        // --- Calendar Functions ---
        function renderCalendar(month, year) {
            calendarGrid.innerHTML = '';
            const monthIndex = monthNames.indexOf(month);
            if (monthIndex === -1 || !year) {
                calendarGrid.innerHTML = '<p class="col-span-7 text-red-500">Please select a valid month and year first.</p>';
                return;
            }

            calendarHeader.textContent = `${month}, ${year}`;
            
            const firstDayOfMonth = new Date(year, monthIndex, 1).getDay(); // 0 = Sunday, 1 = Monday, ...
            const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, monthIndex, 0).getDate();
            
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];

            // 1. Add day headers (S, M, T, W, T, F, S) - Sunday first
            ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day header';
                dayEl.textContent = day;
                calendarGrid.appendChild(dayEl);
            });

            // 2. Add padding days from previous month
            for (let i = 0; i < firstDayOfMonth; i++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day other-month';
                dayEl.textContent = daysInPrevMonth - firstDayOfMonth + 1 + i;
                calendarGrid.appendChild(dayEl);
            }

            // 3. Add days for current month
            for (let i = 1; i <= daysInMonth; i++) {
                const dayEl = document.createElement('div');
                const dateStr = `${year}-${String(monthIndex + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                
                dayEl.className = 'calendar-day current-month';
                dayEl.textContent = i;
                dayEl.dataset.date = dateStr;

                if (dateStr === todayStr) {
                    dayEl.classList.add('today');
                }
                
                if (tempSelectedDates.includes(dateStr)) {
                    dayEl.classList.add('selected');
                }

                calendarGrid.appendChild(dayEl);
            }

            // 4. Add padding days for next month
            const totalCells = firstDayOfMonth + daysInMonth;
            const remainingCells = (totalCells % 7 === 0) ? 0 : 7 - (totalCells % 7); // More accurate padding
            
            for (let i = 1; i <= remainingCells; i++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day other-month';
                dayEl.textContent = i;
                calendarGrid.appendChild(dayEl);
            }
        }

        function openCalendar(targetInput, title) {
            currentCalendarInput = targetInput;
            calendarHeader.textContent = title;

            const selectedMonth = document.getElementById('month').value;
            const selectedYear = document.getElementById('year').value;
            
            // Load existing dates from input data attribute if present
            const existingDates = currentCalendarInput.dataset.dates;
            tempSelectedDates = existingDates ? JSON.parse(existingDates) : [];
            
            renderCalendar(selectedMonth, selectedYear);
            showModal(calendarModal);
        }

        /**
         * Populates month and year dropdowns.
         */
        function initDateFields() {
            // Set default month to *previous* month
            const currentDate = new Date();
            currentDate.setMonth(currentDate.getMonth() - 1); // Go back one month
            
            const defaultMonthIndex = currentDate.getMonth();
            const defaultMonthName = monthNames[defaultMonthIndex];
            const defaultYear = currentDate.getFullYear(); // This handles Jan -> Dec wrap-around
            
            document.getElementById('month').value = defaultMonthName;
            
            // Populate and set current year as default
            const yearSelect = document.getElementById('year');
            const filterYearSelect = document.getElementById('filterYear'); // Get filter select
            const startYear = defaultYear - 50; 
            const endYear = 2095;
            
            // Clear existing options (for filter select)
            filterYearSelect.innerHTML = '<option value="">All Years</option>'; // Add default
            yearSelect.innerHTML = ''; // Clear dashboard select
            
            for (let year = endYear; year >= startYear; year--) { // Loop from newest to oldest
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                
                const filterOption = option.cloneNode(true); // Clone for filter
                
                yearSelect.appendChild(option);
                filterYearSelect.appendChild(filterOption);
            }
            yearSelect.value = defaultYear; // Set default for dashboard
            
            // Set default for filters
            document.getElementById('filterMonth').value = defaultMonthName;
            filterYearSelect.value = defaultYear; 
        }
        
        /**
         * Generates a PDF payslip using jsPDF.
         * Can be called with specific data (from saved records) or will use lastCalculationData.
         */
        function generatePdf(data) {
            const record = data || lastCalculationData;
            
            if (!record) {
                console.log("No data to generate PDF."); 
                saveStatus.textContent = "No data to generate PDF. Please calculate first.";
                setTimeout(() => saveStatus.textContent = "", 2000);
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // PDF-safe currency formatter (uses Rs. and Indian commas)
            const formatPdfCurrency = (amount) => {
                const fixedAmount = (amount || 0).toFixed(2);
                const parts = fixedAmount.split('.');
                let integerPart = parts[0];
                const decimalPart = parts[1];
                // Regex for Indian comma formatting (e.g., 1,00,000)
                integerPart = integerPart.replace(/(\d)(?=(\d\d)+\d$)/g, "$1,");
                return `Rs. ${integerPart}.${decimalPart}`;
            };
            
            // Helper to format date arrays
            const formatDateList = (dates) => {
                if (!dates || dates.length === 0) return "";
                const formattedDates = dates.map(d => d.split('-')[2]).join(', '); // Get just the day
                return `(Dates: ${formattedDates})`;
            };
            
            let yPos = 20;
            let itemY = 0; // To align remarks

            // Header
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text("Pay Slip", 105, yPos, { align: 'center' });
            yPos += 15;
            
            doc.setFontSize(16);
            doc.setFont(undefined, 'normal');
            doc.text("Guru naturals and agro industries", 15, yPos);
            yPos += 7;
            doc.setFontSize(10);
            doc.text("21, shanti vihar colony near bengali square", 15, yPos);
            yPos += 5;
            doc.text("kanadia road indore", 15, yPos);
            yPos += 10;

            // Employee Info
            doc.setFontSize(11);
            doc.text(`Employee Name: ${record.employeeName}`, 15, yPos);
            doc.text(`Pay Period: ${record.month}, ${record.year}`, 140, yPos);
            yPos += 10;
            doc.line(15, yPos, 195, yPos); // Divider
            yPos += 10;

            // Earnings
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text("Earnings", 15, yPos);
            doc.text("Amount (INR)", 195, yPos, { align: 'right' });
            yPos += 8;
            doc.setFont(undefined, 'normal');
            doc.setFontSize(11);

            doc.text("Base Salary:", 15, yPos);
            doc.text(formatPdfCurrency(record.baseSalary), 195, yPos, { align: 'right' });
            yPos += 7;
            
            itemY = yPos;
            doc.text("Extra Day Addition:", 15, itemY);
            doc.text(formatPdfCurrency(record.extraDayAddition), 195, itemY, { align: 'right' });
            if (record.extraDayDates && record.extraDayDates.length > 0) {
                yPos += 7;
                doc.setFont(undefined, 'italic');
                doc.setFontSize(9);
                doc.text(formatDateList(record.extraDayDates), 15, yPos);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(11);
            }
            yPos += 7;
            
            itemY = yPos;
            doc.text("Overtime Pay:", 15, itemY);
            doc.text(formatPdfCurrency(record.overtimePay), 195, itemY, { align: 'right' });
            if (record.overtimeHours && record.overtimeHours > 0) {
                yPos += 7;
                doc.setFont(undefined, 'italic');
                doc.setFontSize(9);
                doc.text(`(${record.overtimeHours} hrs)`, 15, yPos);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(11);
            }
            yPos += 7;
            
            itemY = yPos;
            doc.text("Other Additions:", 15, itemY);
            doc.text(formatPdfCurrency(record.otherAddition), 195, itemY, { align: 'right' });
            if (record.otherAdditionRemark) {
                yPos += 7;
                doc.setFont(undefined, 'italic');
                doc.setFontSize(9);
                doc.text(`  (${record.otherAdditionRemark})`, 15, yPos);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(11);
            }
            yPos += 7;
            
            doc.line(15, yPos, 195, yPos); // Divider
            yPos += 7;
            doc.setFont(undefined, 'bold');
            doc.text("Total Earnings:", 15, yPos);
            doc.text(formatPdfCurrency(record.totalEarnings), 195, yPos, { align: 'right' });
            yPos += 15; // Extra space

            // Deductions
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text("Deductions", 15, yPos);
            doc.text("Amount (INR)", 195, yPos, { align: 'right' });
            yPos += 8;
            doc.setFont(undefined, 'normal');
            doc.setFontSize(11);

            itemY = yPos;
            doc.text("Absent Day Deduction:", 15, itemY);
            doc.text(formatPdfCurrency(record.absentDeduction), 195, itemY, { align: 'right' });
            if (record.absentDates && record.absentDates.length > 0) {
                yPos += 7;
                doc.setFont(undefined, 'italic');
                doc.setFontSize(9);
                doc.text(formatDateList(record.absentDates), 15, yPos);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(11);
            }
            yPos += 7;

            itemY = yPos;
            doc.text("Half Day Deduction:", 15, itemY);
            doc.text(formatPdfCurrency(record.halfDayDeduction), 195, itemY, { align: 'right' });
            if (record.halfDayDates && record.halfDayDates.length > 0) {
                yPos += 7;
                doc.setFont(undefined, 'italic');
                doc.setFontSize(9);
                doc.text(formatDateList(record.halfDayDates), 15, yPos);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(11);
            }
            yPos += 7;

            itemY = yPos;
            doc.text("Advance Payment:", 15, itemY);
            doc.text(formatPdfCurrency(record.advancePayment), 195, itemY, { align: 'right' });
            if (record.advancePaymentRemark) {
                yPos += 7;
                doc.setFont(undefined, 'italic');
                doc.setFontSize(9);
                doc.text(`  (${record.advancePaymentRemark})`, 15, yPos);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(11);
            }
            yPos += 7;
            
            itemY = yPos;
            doc.text("Other Deductions:", 15, itemY);
            doc.text(formatPdfCurrency(record.otherDeduction), 195, itemY, { align: 'right' });
            if (record.otherDeductionRemark) {
                yPos += 7;
                doc.setFont(undefined, 'italic');
                doc.setFontSize(9);
                doc.text(`  (${record.otherDeductionRemark})`, 15, yPos);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(11);
            }
            yPos += 7;

            doc.line(15, yPos, 195, yPos); // Divider
            yPos += 7;
            doc.setFont(undefined, 'bold');
            doc.text("Total Deductions:", 15, yPos);
            doc.text(formatPdfCurrency(record.totalDeductions), 195, yPos, { align: 'right' });
            yPos += 15; // Extra space

            // Net Pay
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text("Net Pay:", 15, yPos);
            doc.text(formatPdfCurrency(record.netPay), 195, yPos, { align: 'right' });
            yPos += 10;

            // Footer
            yPos = doc.internal.pageSize.height - 20;
            doc.setFontSize(10);
            doc.setFont(undefined, 'italic');
            doc.text("This is a computer-generated pay slip.", 105, yPos, { align: 'center' });


            // Save
            doc.save(`Payslip_${record.employeeName.replace(/ /g, '_')}_${record.month}_${record.year}.pdf`);
        }
        
        /**
         * Exports the currently filtered salary records to a CSV file.
         */
        function exportToCsv() {
            // 1. Get filter values
            const nameFilter = filterEmployeeName.value;
            const monthFilter = filterMonth.value;
            const yearFilter = filterYear.value;

            // 2. Filter the global salaryRecords array
            const filteredRecords = salaryRecords.filter(record => {
                const modeMatch = record.createdByMode === currentMode;
                const nameMatch = !nameFilter || record.employeeName === nameFilter;
                const monthMatch = !monthFilter || record.month === monthFilter;
                const yearMatch = !yearFilter || record.year == yearFilter;
                return modeMatch && nameMatch && monthMatch && yearMatch;
            });
            
            if (filteredRecords.length === 0) {
                noRecordsText.textContent = "No records to export.";
                setTimeout(() => renderSalaryRecords(), 2000); // Re-render to clear
                return;
            }

            // 3. Helper to escape CSV fields
            const escapeCsv = (field) => {
                if (field === null || field === undefined) return '""';
                let str = String(field);
                // If field contains a comma, quote, or newline, wrap it in double quotes
                if (str.search(/("|,|\n)/g) >= 0) {
                    str = '"' + str.replace(/"/g, '""') + '"';
                }
                return str;
            };

            // 4. Define CSV Headers
            const headers = [
                'Employee Name', 'Month', 'Year', 'Created At', 'Created By Mode',
                'Base Salary', 'Absent Days', 'Half Days', 'Extra Days',
                'Overtime Hours', 'Overtime Pay', 'Other Addition', 'Other Addition Remark',
                'Total Earnings', 'Absent Deduction', 'Half Day Deduction',
                'Advance Payment', 'Advance Payment Remark', 'Other Deduction', 'Other Deduction Remark',
                'Total Deductions', 'Net Pay', 'Absent Dates', 'Half Day Dates', 'Extra Day Dates'
            ];
            
            // 5. Create CSV Content
            let csvContent = headers.join(',') + '\n';
            
            filteredRecords.forEach(r => {
                const row = [
                    r.employeeName, r.month, r.year, r.createdAt.toISOString(), r.createdByMode,
                    r.baseSalary, r.absentDays, r.halfDays, r.extraDays,
                    r.overtimeHours, r.overtimePay, r.otherAddition, r.otherAdditionRemark,
                    r.totalEarnings, r.absentDeduction, r.halfDayDeduction,
                    r.advancePayment, r.advancePaymentRemark, r.otherDeduction, r.otherDeductionRemark,
                    r.totalDeductions, r.netPay,
                    JSON.stringify(r.absentDates || []), // Store arrays as JSON strings
                    JSON.stringify(r.halfDayDates || []),
                    JSON.stringify(r.extraDayDates || [])
                ].map(escapeCsv).join(',');
                csvContent += row + '\n';
            });

            // 6. Create and Trigger Download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            
            // Create dynamic filename
            let filename = `salary_export_${currentMode}`;
            if (yearFilter) filename += `_${yearFilter}`;
            if (monthFilter) filename += `_${monthFilter}`;
            if (nameFilter) filename += `_${nameFilter.replace(/ /g, '_')}`;
            filename += '.csv';
            
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        /**
         * Clears all fields on the main salary form.
         */
        function clearForm() {
            // employeeSelect.value = ""; // Keep employee selected
            document.getElementById('baseSalary').value = "";
            
            absentDaysInput.value = "0";
            absentDaysInput.dataset.dates = "[]";
            halfDaysInput.value = "0";
            halfDaysInput.dataset.dates = "[]";
            extraDaysInput.value = "0";
            extraDaysInput.dataset.dates = "[]";
            
            document.getElementById('overtimeHours').value = "";
            document.getElementById('otherAddition').value = "";
            document.getElementById('otherAdditionRemark').value = "";
            
            document.getElementById('advancePayment').value = "";
            document.getElementById('advancePaymentRemark').value = "";
            document.getElementById('otherDeduction').value = "";
            document.getElementById('otherDeductionRemark').value = "";
            
            // Clear summary
            document.getElementById('summarySection').classList.add('hidden');
            lastCalculationData = null;
        }
        
        /**
         * Puts the form into 'Edit' mode, populating it with record data.
         */
        function loadRecordForEdit(recordId) {
            const record = salaryRecords.find(r => r.id === recordId);
            if (!record) {
                console.error("Could not find record to edit:", recordId);
                return;
            }

            // Set global editing ID
            currentEditingRecordId = recordId;

            // Fill form fields
            employeeSelect.value = record.employeeName;
            document.getElementById('month').value = record.month;
            document.getElementById('year').value = record.year;
            
            document.getElementById('baseSalary').value = record.baseSalary || "";
            
            absentDaysInput.value = record.absentDays || "0";
            absentDaysInput.dataset.dates = JSON.stringify(record.absentDates || []);
            halfDaysInput.value = record.halfDays || "0";
            halfDaysInput.dataset.dates = JSON.stringify(record.halfDayDates || []);
            extraDaysInput.value = record.extraDays || "0";
            extraDaysInput.dataset.dates = JSON.stringify(record.extraDayDates || []);
            
            document.getElementById('overtimeHours').value = record.overtimeHours || "";
            document.getElementById('otherAddition').value = record.otherAddition || "";
            document.getElementById('otherAdditionRemark').value = record.otherAdditionRemark || "";
            
            document.getElementById('advancePayment').value = record.advancePayment || "";
            document.getElementById('advancePaymentRemark').value = record.advancePaymentRemark || "";
            document.getElementById('otherDeduction').value = record.otherDeduction || "";
            document.getElementById('otherDeductionRemark').value = record.otherDeductionRemark || "";
            
            // Switch UI to edit mode
            calculateButton.textContent = "Calculate Updates";
            saveRecordButton.textContent = "Save Updates";
            cancelEditButton.classList.remove('hidden');
            document.getElementById('summarySection').classList.add('hidden'); // Hide summary until recalculated
            
            // Switch to dashboard tab
            dashboardTab.click();
            window.scrollTo(0, 0); // Scroll to top
        }
        
        /**
         * Resets the form from 'Edit' mode back to 'Calculate' mode.
         */
        function resetToCalculateMode() {
            currentEditingRecordId = null;
            calculateButton.textContent = "Calculate Pay";
            saveRecordButton.textContent = "Save Record";
            cancelEditButton.classList.add('hidden');
            document.getElementById('summarySection').classList.add('hidden');
            lastCalculationData = null;
            clearForm(); // Also clear the fields
        }


        // --- Firebase Initialization and Auth ---
        async function initializeFirebase() {
            try {
                if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                    console.warn("Firebase config is missing. App cannot connect to database.");
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug');

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("User is authenticated:", user.uid);
                        userId = user.uid;

                        // --- Define Firestore Collections ---
                        // Use public data path
                        employeesCollection = collection(db, `artifacts/${appId}/public/data/employees`);
                        salaryRecordsCollection = collection(db, `artifacts/${appId}/public/data/salaryRecords`);

                        // --- Start Data Listeners ---
                        listenForEmployees();
                        listenForSalaryRecords();
                    } else {
                        console.log("User is not authenticated.");
                        userId = null;
                    }
                });

                // Sign in
                if (initialAuthToken) {
                    console.log("Signing in with custom token...");
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    console.log("Signing in anonymously...");
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase initialization error:", error);
                noRecordsText.textContent = "Error connecting to database.";
                noRecordsText.classList.remove('hidden');
            }
        }
        
        // --- Mode Switching Logic ---
        function setMode(mode) {
            currentMode = mode;
            if (mode === 'owner') {
                modeSwitchBtn.textContent = 'Switch to Accountant Mode';
                modeSwitchBtn.dataset.mode = 'owner';
                modeSwitchBtn.classList.replace('bg-indigo-600', 'bg-red-600');
                modeSwitchBtn.classList.replace('hover:bg-indigo-700', 'hover:bg-red-700');
            } else {
                modeSwitchBtn.textContent = 'Switch to Owner Mode';
                modeSwitchBtn.dataset.mode = 'accountant';
                modeSwitchBtn.classList.replace('bg-red-600', 'bg-indigo-600');
                modeSwitchBtn.classList.replace('hover:bg-red-700', 'hover:bg-indigo-700');
            }
            console.log("Mode switched to:", currentMode);
            
            // Re-render data and analysis for the new mode
            renderSalaryRecords();
            if (!analysisPage.classList.contains('hidden')) {
                renderAnalysis();
            }
        }
        
        
        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            // initDateFields(); // <-- MOVED
            // initializeFirebase(); // <-- MOVED
            
            // --- Dashboard Lock Listener (NEW) ---
            unlockDashboardBtn.addEventListener('click', () => {
                if (lockPinInput.value === '9131') {
                    // Correct PIN
                    lockError.textContent = "";
                    dashboardLockModal.classList.add('opacity-0', 'pointer-events-none');
                    mainAppContainer.classList.remove('hidden');
                    
                    // NOW initialize the app
                    initDateFields();
                    initializeFirebase(); // Start Firebase connection

                } else {
                    // Incorrect PIN
                    lockError.textContent = "Incorrect PIN. Please try again.";
                    lockPinInput.value = "";
                }
            });
            
            // --- Tab Navigation Listeners ---
            dashboardTab.addEventListener('click', () => {
                dashboardPage.classList.remove('hidden');
                salaryDataPage.classList.add('hidden');
                analysisPage.classList.add('hidden'); // Hide analysis
                dashboardTab.classList.add('active');
                salaryDataTab.classList.remove('active');
                analysisTab.classList.remove('active'); // Deactivate analysis
            });

            salaryDataTab.addEventListener('click', () => {
                dashboardPage.classList.add('hidden');
                salaryDataPage.classList.remove('hidden');
                analysisPage.classList.add('hidden'); // Hide analysis
                dashboardTab.classList.remove('active');
                salaryDataTab.classList.add('active');
                analysisTab.classList.remove('active'); // Deactivate analysis
                renderSalaryRecords();
            });

            analysisTab.addEventListener('click', () => {
                dashboardPage.classList.add('hidden');
                salaryDataPage.classList.add('hidden');
                analysisPage.classList.remove('hidden'); // Show analysis
                dashboardTab.classList.remove('active');
                salaryDataTab.classList.remove('active');
                analysisTab.classList.add('active'); // Activate analysis
                renderAnalysis();
            });

            // --- Employee Modal Listeners ---
            manageEmployeesBtn.addEventListener('click', () => {
                resetEmployeeForm(); // Ensure form is in 'Add' mode
                showModal(employeeModal);
            });
            closeEmployeeModal.addEventListener('click', () => hideModal(employeeModal));
            addEmployeeBtn.addEventListener('click', addEmployee);
            updateEmployeeBtn.addEventListener('click', updateEmployee);
            cancelEmployeeUpdateBtn.addEventListener('click', resetEmployeeForm);
            
            // Employee Edit/Delete listeners (using delegation)
            employeeListContainer.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-employee-btn');
                if (deleteBtn) {
                    employeeToDelete = {
                        id: deleteBtn.dataset.id,
                        name: deleteBtn.dataset.name
                    };
                    employeeToDeleteName.textContent = employeeToDelete.name;
                    showModal(confirmDeleteModal);
                }
                
                const editBtn = e.target.closest('.edit-employee-btn');
                if (editBtn) {
                    currentEmployeeEditingId = editBtn.dataset.id;
                    employeeFormTitle.textContent = "Update Employee";
                    newEmployeeNameInput.value = editBtn.dataset.name;
                    newEmployeeSalaryInput.value = editBtn.dataset.salary;
                    addEmployeeBtn.classList.add('hidden');
                    updateEmployeeBtn.classList.remove('hidden');
                    cancelEmployeeUpdateBtn.classList.remove('hidden');
                    employeeError.classList.add('hidden');
                }
            });
            cancelDeleteBtn.addEventListener('click', () => hideModal(confirmDeleteModal));
            confirmDeleteBtn.addEventListener('click', confirmDeleteEmployee);
            
            // --- Salary Record Edit/Delete Listeners (Delegation) ---
            salaryRecordsContainer.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-record-btn');
                if (deleteBtn) {
                    recordToDeleteId = deleteBtn.dataset.id;
                    recordToDeleteName.textContent = deleteBtn.dataset.name;
                    showModal(confirmRecordDeleteModal);
                }
                
                const editBtn = e.target.closest('.edit-record-btn');
                if (editBtn) {
                    loadRecordForEdit(editBtn.dataset.id);
                }
                
                const pdfBtn = e.target.closest('.download-record-pdf-btn');
                if (pdfBtn) {
                    const recordId = pdfBtn.dataset.id;
                    const recordToDownload = salaryRecords.find(r => r.id === recordId);
                    if (recordToDownload) {
                        generatePdf(recordToDownload);
                    } else {
                        console.error("Could not find record to download:", recordId);
                    }
                }
            });
            cancelRecordDeleteBtn.addEventListener('click', () => hideModal(confirmRecordDeleteModal));
            confirmRecordDeleteBtn.addEventListener('click', confirmDeleteRecord);
            
            // --- PDF/CSV Download Listeners ---
            downloadPdfButton.addEventListener('click', () => generatePdf()); // Calls with no args
            exportCsvButton.addEventListener('click', exportToCsv);

            // --- Filter Listeners ---
            filterEmployeeName.addEventListener('change', renderSalaryRecords);
            filterMonth.addEventListener('change', renderSalaryRecords);
            filterYear.addEventListener('change', renderSalaryRecords);

            // --- Calendar Listeners ---
            calendarGrid.addEventListener('click', (e) => {
                const dayEl = e.target.closest('.calendar-day');
                if (dayEl && dayEl.classList.contains('current-month')) {
                    const date = dayEl.dataset.date;
                    dayEl.classList.toggle('selected');
                    
                    if (tempSelectedDates.includes(date)) {
                        tempSelectedDates = tempSelectedDates.filter(d => d !== date);
                    } else {
                        tempSelectedDates.push(date);
                    }
                    tempSelectedDates.sort(); // Keep them in order
                }
            });

            openAbsentCalendarBtn.addEventListener('click', () => openCalendar(absentDaysInput, 'Select Absent Dates'));
            openHalfDayCalendarBtn.addEventListener('click', () => openCalendar(halfDaysInput, 'Select Half Days'));
            openExtraDayCalendarBtn.addEventListener('click', () => openCalendar(extraDaysInput, 'Select Extra Days'));
            closeCalendarModalBtn.addEventListener('click', () => hideModal(calendarModal));
            cancelCalendarBtn.addEventListener('click', () => hideModal(calendarModal));

            saveCalendarBtn.addEventListener('click', () => {
                if (currentCalendarInput) {
                    currentCalendarInput.value = tempSelectedDates.length;
                    currentCalendarInput.dataset.dates = JSON.stringify(tempSelectedDates);
                }
                hideModal(calendarModal);
                currentCalendarInput = null;
                tempSelectedDates = [];
            });
            
            // --- Employee Dropdown Listener ---
            employeeSelect.addEventListener('change', (e) => {
                // Do not auto-fill if we are in edit mode
                if (currentEditingRecordId) {
                    return;
                }
                
                // Clear all fields first
                clearForm();
                
                // Then, set the new base salary
                const selectedOption = e.target.options[e.target.selectedIndex];
                const salary = selectedOption.dataset.salary;
                if (salary) {
                    document.getElementById('baseSalary').value = salary;
                }
            });
            
            // --- Mode Switch Listeners ---
            modeSwitchBtn.addEventListener('click', () => {
                if (modeSwitchBtn.dataset.mode === 'accountant') {
                    // Trying to switch to Owner mode, show password modal
                    passwordError.classList.add('hidden');
                    passwordInput.value = "";
                    showModal(passwordModal);
                } else {
                    // Switching from Owner to Accountant mode, no password needed
                    setMode('accountant');
                }
            });
            
            cancelPasswordBtn.addEventListener('click', () => hideModal(passwordModal));
            submitPasswordBtn.addEventListener('click', () => {
                const pass = passwordInput.value;
                if (pass === '9111000') { // This check is correct
                    setMode('owner');
                    hideModal(passwordModal);
                } else {
                    passwordError.textContent = "Incorrect password.";
                    passwordError.classList.remove('hidden');
                }
            });
            
            // --- Calculation Logic ---
            calculateButton.addEventListener('click', function() {
                
                // ... existing code ... -->
                // --- Store data for PDF generation ---
                lastCalculationData = {
                    employeeName, month, year,
                    
                    baseSalary, // Store raw number
                    extraDays, // <<< THIS WAS THE MISSING LINE
                    extraDayAddition, // Store raw number
                    overtimeHours, // Store OT hours
                    overtimePay, // Store raw number
                    otherAddition, // Store raw number
                    totalEarnings, // Store raw number
                    
                    absentDays, // Store count
                    absentDeduction, // Store raw number
                    halfDays, // Store count
                    halfDayDeduction, // Store raw number
                    advancePayment, // Store raw number
                    otherDeduction, // Store raw number
                    totalDeductions, // Store raw number
                    
                    netPay, // Store raw number
                    
                    // Store the date arrays as well
                    absentDates,
                    halfDayDates,
                    extraDayDates,
                    
                    otherAdditionRemark,
                    advancePaymentRemark,
                    otherDeductionRemark
                };
                
                // --- Populate Summary Section ---
                document.getElementById('summaryEmployee').textContent = employeeName || "N/A";
                document.getElementById('summaryMonth').textContent = `For ${month}, ${year}`;
                document.getElementById('summaryDate').textContent = new Date().toLocaleDateString('en-IN');

                // Earnings
                document.getElementById('summaryBase').textContent = formatCurrency(baseSalary);
                document.getElementById('summaryExtraDay').textContent = `+ ${formatCurrency(extraDayAddition)}`;
                
                const summaryExtraDayDatesEl = document.getElementById('summaryExtraDayDates');
                if (extraDayDates.length > 0) {
                    const formattedDates = extraDayDates.map(d => d.split('-')[2]).join(', ');
                    summaryExtraDayDatesEl.textContent = `Dates: ${formattedDates}`;
                    summaryExtraDayDatesEl.classList.remove('hidden');
                } else {
                    summaryExtraDayDatesEl.classList.add('hidden');
                    summaryExtraDayDatesEl.textContent = '';
                }
                
                document.getElementById('summaryOvertime').textContent = `+ ${formatCurrency(overtimePay)}`;
                const summaryOvertimeHoursEl = document.getElementById('summaryOvertimeHours');
                if (overtimeHours > 0) {
                    summaryOvertimeHoursEl.textContent = `(${overtimeHours} hrs)`;
                    summaryOvertimeHoursEl.classList.remove('hidden');
                } else {
                    summaryOvertimeHoursEl.classList.add('hidden');
                    summaryOvertimeHoursEl.textContent = '';
                }
                
                document.getElementById('summaryOtherAddition').textContent = `+ ${formatCurrency(otherAddition)}`;
                
                const summaryOtherAdditionRemark = document.getElementById('summaryOtherAdditionRemark');
                if (otherAdditionRemark) {
                    summaryOtherAdditionRemark.textContent = `"${otherAdditionRemark}"`;
                    summaryOtherAdditionRemark.classList.remove('hidden');
                } else {
                    summaryOtherAdditionRemark.classList.add('hidden');
                    summaryOtherAdditionRemark.textContent = ''; // Clear content
                }

                // Populate the Total Earnings field
                document.getElementById('summaryTotalEarnings').textContent = formatCurrency(totalEarnings);

                // Deductions
                document.getElementById('summaryAbsent').textContent = `- ${formatCurrency(absentDeduction)}`;
                const summaryAbsentDatesEl = document.getElementById('summaryAbsentDates');
                if (absentDates.length > 0) {
                    const formattedDates = absentDates.map(d => d.split('-')[2]).join(', '); // Get just the day (e.g., '11, 16, 18')
                    summaryAbsentDatesEl.textContent = `Dates: ${formattedDates}`;
                    summaryAbsentDatesEl.classList.remove('hidden');
                } else {
                    summaryAbsentDatesEl.classList.add('hidden');
                    summaryAbsentDatesEl.textContent = ''; // Clear content
                }
                
                document.getElementById('summaryHalfDay').textContent = `- ${formatCurrency(halfDayDeduction)}`;
                
                const summaryHalfDayDatesEl = document.getElementById('summaryHalfDayDates');
                if (halfDayDates.length > 0) {
                    const formattedDates = halfDayDates.map(d => d.split('-')[2]).join(', ');
                    summaryHalfDayDatesEl.textContent = `Dates: ${formattedDates}`;
                    summaryHalfDayDatesEl.classList.remove('hidden');
                } else {
                    summaryHalfDayDatesEl.classList.add('hidden');
                    summaryHalfDayDatesEl.textContent = '';
                }
                
                document.getElementById('summaryAdvance').textContent = `- ${formatCurrency(advancePayment)}`;
                const summaryAdvanceRemark = document.getElementById('summaryAdvanceRemark');
                if (advancePaymentRemark) {
                    summaryAdvanceRemark.textContent = `"${advancePaymentRemark}"`;
                    summaryAdvanceRemark.classList.remove('hidden');
                } else {
                    summaryAdvanceRemark.classList.add('hidden');
                    summaryAdvanceRemark.textContent = '';
                }
                
                document.getElementById('summaryOtherDeduction').textContent = `- ${formatCurrency(otherDeduction)}`;
                document.getElementById('summaryTotalDeductions').textContent = formatCurrency(totalDeductions);
                
                const summaryOtherDeductionRemark = document.getElementById('summaryOtherDeductionRemark');
                 if (otherDeductionRemark) {
                     summaryOtherDeductionRemark.textContent = `"${otherDeductionRemark}"`;
                     summaryOtherDeductionRemark.classList.remove('hidden');
                } else {
                     summaryOtherDeductionRemark.classList.add('hidden');
                     summaryOtherDeductionRemark.textContent = ''; // Clear content
                }

                // Net Pay
                document.getElementById('summaryNetPay').textContent = formatCurrency(netPay);

                // --- Show the Summary ---
                document.getElementById('summarySection').classList.remove('hidden');

                // Scroll to the summary
                document.getElementById('summarySection').scrollIntoView({ behavior: 'smooth' });
            });
            
            // --- Save Record Listener ---
            saveRecordButton.addEventListener('click', () => {
                if (lastCalculationData) {
                    saveSalaryRecord(lastCalculationData);
                } else {
                    saveStatus.textContent = "Please calculate pay first.";
                    setTimeout(() => saveStatus.textContent = "", 2000);
                }
            });
            
            // --- Cancel Edit Listener ---
            cancelEditButton.addEventListener('click', resetToCalculateMode);
        });
    </script>

</body>
</html>
