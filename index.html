<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salary Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- Load Marked.js for AI Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Set base font -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styling for number inputs (hide arrows) */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        /* Modal styles */
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        /* Calendar Styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .calendar-day {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 36px;
            width: 36px;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .calendar-day.header {
            font-weight: 600;
            font-size: 0.75rem;
            color: #4b5563; /* text-gray-600 */
        }
        .calendar-day.current-month:hover {
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        .calendar-day.other-month {
            color: #d1d5db; /* text-gray-300 */
            cursor: not-allowed;
        }
        .calendar-day.selected {
            background-color: #ef4444; /* bg-red-500 */
            color: white;
            font-weight: 600;
        }
        .calendar-day.today {
            border: 1px solid #3b82f6; /* border-blue-500 */
        }
        
        /* Tab styles */
        .tab-btn {
            @apply px-8 py-3 text-xl font-bold text-gray-600 rounded-lg hover:bg-gray-200 transition-all duration-200;
        }
        .tab-btn.active {
            @apply bg-blue-600 text-white shadow-md hover:bg-blue-700;
        }

        /* AI Insight Styles */
        .ai-content h1, .ai-content h2, .ai-content h3 { @apply font-bold mt-4 mb-2 text-gray-900; }
        .ai-content h1 { @apply text-2xl; }
        .ai-content h2 { @apply text-xl; }
        .ai-content p { @apply mb-3 text-gray-700 leading-relaxed; }
        .ai-content ul { @apply list-disc pl-5 mb-4 space-y-1 text-gray-700; }
        .ai-content strong { @apply text-blue-700; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Dashboard Lock Screen Modal -->
    <div id="dashboardLockModal" class="modal fixed inset-0 z-[100] flex items-center justify-center bg-gray-900">
        <div class="modal-content bg-white w-full max-w-sm p-6 rounded-xl shadow-2xl">
            <h3 class="text-2xl font-semibold text-gray-900 mb-4 text-center">Enter PIN</h3>
            <p class="text-gray-600 mb-6 text-center">Please enter the PIN to unlock the dashboard.</p>
            <input type="password" id="lockPinInput" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-center text-xl tracking-widest" maxlength="4">
            <p id="lockError" class="text-red-500 text-sm text-center mt-2 h-4"></p>
            <div class="flex justify-end gap-3 mt-6">
                <button id="unlockDashboardBtn" class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 font-semibold text-lg">Unlock</button>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="mainAppContainer" class="hidden">

        <!-- Header: Tab Navigation & Mode Switch -->
        <div class="bg-white shadow-sm sticky top-0 z-40 p-5">
            <div class="container mx-auto max-w-4xl flex justify-between items-center text-center sm:text-left flex-col sm:flex-row gap-4">
                <nav class="flex gap-2 sm:gap-6">
                    <button id="dashboardTab" class="tab-btn active text-sm sm:text-xl px-4 sm:px-8">
                        Salary
                    </button>
                    <button id="salaryDataTab" class="tab-btn text-sm sm:text-xl px-4 sm:px-8">
                        Records
                    </button>
                    <button id="analysisTab" class="tab-btn text-sm sm:text-xl px-4 sm:px-8">
                        Analysis
                    </button>
                </nav>
                <div class="flex items-center">
                    <button id="modeSwitchBtn" data-mode="accountant" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition duration-200 shadow-md whitespace-nowrap">
                        Switch to Owner Mode
                    </button>
                </div>
            </div>
        </div>

        <!-- Page 1: Salary Dashboard -->
        <div id="dashboardPage" class="container mx-auto max-w-4xl p-4 sm:p-8">
            <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl">
            
                <!-- Logo -->
                <div class="flex justify-center mb-6">
                    <img id="dashboardCompanyLogo" src="https://i.postimg.cc/rsRFnMMc/1002397847-removebg-preview-1.png" alt="Company Logo" class="h-20 w-auto"
                         onerror="this.style.display='none'; this.nextElementSibling.classList.remove('hidden');">
                    <!-- Fallback text if image fails to load -->
                    <div class="hidden text-gray-500 text-center">Logo could not be loaded</div>
                </div>
                
                <!-- Header -->
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-6 text-center">
                    Employee Salary Dashboard
                </h1>
    
                <!-- Main Form -->
                <div class="space-y-6">
    
                    <!-- Row 1: Employee, Month, and Year -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <label for="employeeName" class="block text-sm font-medium text-gray-700">Employee Name</label>
                                <button id="manageEmployeesBtn" class="hidden text-xs text-blue-600 hover:text-blue-800 font-medium">Manage</button>
                            </div>
                            <select id="employeeName" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Select Employee</option>
                            </select>
                        </div>
                        <div>
                            <label for="month" class="block text-sm font-medium text-gray-700 mb-1">Select Month</label>
                            <select id="month" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option>January</option>
                                <option>February</option>
                                <option>March</option>
                                <option>April</option>
                                <option>May</option>
                                <option>June</option>
                                <option>July</option>
                                <option>August</option>
                                <option>September</option>
                                <option>October</option>
                                <option>November</option>
                                <option>December</option>
                            </select>
                        </div>
                        <div>
                            <label for="year" class="block text-sm font-medium text-gray-700 mb-1">Select Year</label>
                            <select id="year" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                    </div>
    
                    <!-- Row 2: Salary and Attendance -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="baseSalary" class="block text-sm font-medium text-gray-700 mb-1">Base Salary</label>
                            <div class="flex">
                                <span class="inline-flex items-center px-3 rounded-l-lg border border-r-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">₹</span>
                                <input type="number" id="baseSalary" placeholder="e.g., 50000" class="w-full px-4 py-2 border border-gray-300 rounded-r-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label for="absentDays" class="block text-sm font-medium text-gray-700 mb-1">Absent</label>
                                <div class="flex">
                                    <input type="text" id="absentDays" placeholder="0" readonly class="w-full px-4 py-2 border border-gray-300 rounded-l-lg shadow-sm focus:outline-none bg-gray-50 cursor-pointer">
                                    <button id="openAbsentCalendar" class="px-3 py-2 border border-l-0 border-gray-300 rounded-r-lg bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label for="halfDays" class="block text-sm font-medium text-gray-700 mb-1">Half Days</label>
                                <div class="flex">
                                    <input type="text" id="halfDays" placeholder="0" readonly class="w-full px-4 py-2 border border-gray-300 rounded-l-lg shadow-sm focus:outline-none bg-gray-50 cursor-pointer">
                                    <button id="openHalfDayCalendar" class="px-3 py-2 border border-l-0 border-gray-300 rounded-r-lg bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label for="extraDays" class="block text-sm font-medium text-gray-700 mb-1">Extra Days</label>
                                <div class="flex">
                                    <input type="text" id="extraDays" placeholder="0" readonly class="w-full px-4 py-2 border border-gray-300 rounded-l-lg shadow-sm focus:outline-none bg-gray-50 cursor-pointer">
                                    <button id="openExtraDayCalendar" class="px-3 py-2 border border-l-0 border-gray-300 rounded-r-lg bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
    
                    <!-- Row 3: Additions -->
                    <div class="border-t border-gray-200 pt-6 space-y-6">
                        <h2 class="text-xl font-semibold text-gray-800">Additions</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="overtimeHours" class="block text-sm font-medium text-gray-700 mb-1">Overtime (Hours)</label>
                                <div class="flex">
                                    <span class="inline-flex items-center px-3 rounded-l-lg border border-r-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">Hrs</span>
                                    <input type="number" id="overtimeHours" placeholder="e.g., 2.5" class="w-full px-4 py-2 border border-gray-300 rounded-r-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            <div>
                                <label for="otherAddition" class="block text-sm font-medium text-gray-700 mb-1">Other Addition</label>
                                <div class="flex">
                                    <span class="inline-flex items-center px-3 rounded-l-lg border border-r-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">₹</span>
                                    <input type="number" id="otherAddition" placeholder="0.00" class="w-full px-4 py-2 border border-gray-300 rounded-r-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            <div class="md:col-span-2">
                                 <label for="otherAdditionRemark" class="block text-sm font-medium text-gray-700 mb-1">Other Addition Remark</label>
                                <input type="text" id="otherAdditionRemark" placeholder="e.g., Performance Bonus" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                    </div>
    
                    <!-- Row 4: Deductions -->
                    <div class="border-t border-gray-200 pt-6 space-y-6">
                        <h2 class="text-xl font-semibold text-gray-800">Deductions</h2>
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="advancePayment" class="block text-sm font-medium text-gray-700 mb-1">Advance Payment</label>
                                    <div class="flex">
                                        <span class="inline-flex items-center px-3 rounded-l-lg border border-r-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">₹</span>
                                        <input type="number" id="advancePayment" placeholder="0.00" class="w-full px-4 py-2 border border-gray-300 rounded-r-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>
                                <div>
                                    <label for="otherDeduction" class="block text-sm font-medium text-gray-700 mb-1">Other Deduction</label>
                                    <div class="flex">
                                        <span class="inline-flex items-center px-3 rounded-l-lg border border-r-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">₹</span>
                                        <input type="number" id="otherDeduction" placeholder="0.00" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="advancePaymentRemark" class="block text-sm font-medium text-gray-700 mb-1">Advance Payment Remark</label>
                                    <input type="text" id="advancePaymentRemark" placeholder="e.g., Loan Installment" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label for="otherDeductionRemark" class="block text-sm font-medium text-gray-700 mb-1">Other Deduction Remark</label>
                                    <input type="text" id="otherDeductionRemark" placeholder="e.g., Canteen Bill" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                        </div>
                    </div>
    
                    <!-- Row 5: Calculate Button -->
                    <div class="border-t border-gray-200 pt-8">
                        <div class="flex gap-4">
                            <button id="calculateButton" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold text-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 shadow-md">
                                Calculate Pay
                            </button>
                            <button id="cancelEditButton" class="hidden w-1/3 bg-gray-200 text-gray-800 py-3 px-6 rounded-lg font-semibold text-lg hover:bg-gray-300 transition duration-200">
                                Cancel Edit
                            </button>
                        </div>
                        <p id="saveStatus" class="text-center text-green-600 text-sm mt-2 h-4"></p>
                    </div>
                </div>
    
                <!-- Summary Section -->
                <div id="summarySection" class="hidden mt-10 border-t border-gray-300 pt-8">
                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-6 text-center">
                        Pay Summary
                    </h2>
                    
                    <div class="bg-gray-50 p-6 rounded-lg shadow-inner border border-gray-200">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <div class="text-lg font-semibold text-gray-800" id="summaryEmployee"></div>
                                <div class="text-sm text-gray-500" id="summaryMonth"></div>
                                <div class="text-xs text-blue-600 italic mt-1" id="summaryDesignation"></div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-500">Pay Summary</div>
                                <div class="text-lg font-semibold text-gray-800" id="summaryDate"></div>
                            </div>
                        </div>
    
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-white p-4 rounded-lg shadow-sm border">
                                <h3 class="font-bold text-lg text-green-700 mb-3 border-b pb-2">Earnings</h3>
                                <div class="space-y-2">
                                    <div class="flex justify-between text-gray-700">
                                        <span>Base Salary:</span>
                                        <span class="font-medium text-gray-900" id="summaryBase"></span>
                                    </div>
                                    <div class="flex justify-between text-gray-700">
                                        <span>Extra Day Addition:</span>
                                        <span class="font-medium text-gray-900" id="summaryExtraDay"></span>
                                    </div>
                                    <div id="summaryExtraDayDates" class="text-xs text-gray-500 italic pl-4 hidden"></div>
                                    <div class="flex justify-between text-gray-700">
                                        <span>Overtime Pay:</span>
                                        <span class="font-medium text-gray-900" id="summaryOvertime"></span>
                                    </div>
                                    <div id="summaryOvertimeHours" class="text-xs text-gray-500 italic pl-4 hidden"></div>
                                    <div class="flex justify-between text-gray-700">
                                        <span>Other Additions:</span>
                                        <span class="font-medium text-gray-900" id="summaryOtherAddition"></span>
                                    </div>
                                    <div id="summaryOtherAdditionRemark" class="text-xs text-gray-500 italic pl-4"></div>
                                    <div class="flex justify-between font-bold border-t pt-2 mt-2">
                                        <span class="text-gray-800">Total Earnings:</span>
                                        <span class="text-green-600" id="summaryTotalEarnings"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow-sm border">
                                <h3 class="font-bold text-lg text-red-700 mb-3 border-b pb-2">Deductions</h3>
                                <div class="space-y-2">
                                    <div class="flex justify-between text-gray-700">
                                        <span>Absent Day Deduction:</span>
                                        <span class="font-medium text-gray-900" id="summaryAbsent"></span>
                                    </div>
                                    <div id="summaryAbsentDates" class="text-xs text-gray-500 italic pl-4 hidden"></div>
                                    <div class="flex justify-between text-gray-700">
                                        <span>Half Day Deduction:</span>
                                        <span class="font-medium text-gray-900" id="summaryHalfDay"></span>
                                    </div>
                                    <div id="summaryHalfDayDates" class="text-xs text-gray-500 italic pl-4 hidden"></div>
                                    <div class="flex justify-between text-gray-700">
                                        <span>Advance Payment:</span>
                                        <span class="font-medium text-gray-900" id="summaryAdvance"></span>
                                    </div>
                                    <div id="summaryAdvanceRemark" class="text-xs text-gray-500 italic pl-4"></div>
                                    <div class="flex justify-between text-gray-700">
                                        <span>Other Deductions:</span>
                                        <span class="font-medium text-gray-900" id="summaryOtherDeduction"></span>
                                    </div>
                                    <div id="summaryOtherDeductionRemark" class="text-xs text-gray-500 italic pl-4"></div>
                                    <div class="flex justify-between font-bold border-t pt-2 mt-2">
                                        <span class="text-gray-800">Total Deductions:</span>
                                        <span class="text-red-600" id="summaryTotalDeductions"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-6 bg-blue-100 border border-blue-200 p-4 rounded-lg flex justify-between items-center text-xl sm:text-2xl font-bold">
                            <span class="text-blue-800">Net Pay:</span>
                            <span class="text-blue-700" id="summaryNetPay"></span>
                        </div>
                        
                        <div class="mt-8 flex flex-col sm:flex-row gap-4">
                            <button id="saveRecordButton" class="flex-1 bg-green-600 text-white py-3 px-6 rounded-lg font-semibold text-lg hover:bg-green-700 transition duration-200 shadow-md">
                                Save Record
                            </button>
                            <button id="downloadPdfButton" class="flex-1 bg-gray-600 text-white py-3 px-6 rounded-lg font-semibold text-lg hover:bg-gray-700 transition duration-200 shadow-md">
                                PDF
                            </button>
                            <button id="summaryWhatsAppBtn" class="flex-1 bg-green-500 text-white py-3 px-6 rounded-lg font-semibold text-lg hover:bg-green-600 transition duration-200 shadow-md flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.06 3.973l-1.127 4.113 4.209-1.103a7.882 7.882 0 0 0 3.792.98h.004c4.367 0 7.926-3.558 7.93-7.93a7.856 7.856 0 0 0-2.33-5.64zM7.994 14.125a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/>
                                </svg>
                                WhatsApp
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 2: Salary Data -->
        <div id="salaryDataPage" class="hidden container mx-auto max-w-4xl p-4 sm:p-8">
            <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-6 text-center">
                    Saved Salary Data
                </h1>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 p-4 bg-gray-50 rounded-lg border">
                    <div>
                        <label for="filterEmployeeName" class="block text-sm font-medium text-gray-700 mb-1">Filter by Employee</label>
                        <select id="filterEmployeeName" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All Employees</option>
                        </select>
                    </div>
                    <div>
                        <label for="filterMonth" class="block text-sm font-medium text-gray-700 mb-1">Filter by Month</label>
                        <select id="filterMonth" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All Months</option>
                            <option>January</option><option>February</option><option>March</option><option>April</option><option>May</option><option>June</option>
                            <option>July</option><option>August</option><option>September</option><option>October</option><option>November</option><option>December</option>
                        </select>
                    </div>
                    <div>
                        <label for="filterYear" class="block text-sm font-medium text-gray-700 mb-1">Filter by Year</label>
                        <select id="filterYear" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All Years</option>
                        </select>
                    </div>
                </div>
                <div class="mb-6 flex justify-end">
                    <button id="exportCsvButton" class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition duration-200 shadow-md flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        Export to CSV
                    </button>
                </div>
                <div id="salaryRecordsContainer" class="space-y-4">
                    <p id="noRecordsText" class="text-gray-500 text-center italic">Loading records...</p>
                </div>
            </div>
        </div>

        <!-- Page 3: Analysis -->
        <div id="analysisPage" class="hidden container mx-auto max-w-4xl p-4 sm:p-8">
            <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-6 text-center">
                    Salary Data Analysis
                </h1>

                <!-- Analysis Filter Controls -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg border">
                    <div>
                        <label for="analysisFilterEmployeeName" class="block text-sm font-medium text-gray-700 mb-1">Filter by Employee</label>
                        <select id="analysisFilterEmployeeName" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All Employees</option>
                        </select>
                    </div>
                    <div>
                        <label for="analysisFilterMonth" class="block text-sm font-medium text-gray-700 mb-1">Filter by Month</label>
                        <select id="analysisFilterMonth" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All Months</option>
                            <option>January</option><option>February</option><option>March</option><option>April</option><option>May</option><option>June</option>
                            <option>July</option><option>August</option><option>September</option><option>October</option><option>November</option><option>December</option>
                        </select>
                    </div>
                    <div>
                        <label for="analysisFilterYear" class="block text-sm font-medium text-gray-700 mb-1">Filter by Year</label>
                        <select id="analysisFilterYear" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All Years</option>
                        </select>
                    </div>
                </div>
    
                <div id="analysisContent" class="space-y-6">
                    <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-md">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4" id="analysisChartTitle">Total Salary Paid Per Month</h3>
                        <div class="relative h-64 sm:h-80">
                            <canvas id="myChart"></canvas>
                        </div>
                    </div>
    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-indigo-600 p-6 rounded-xl shadow-lg text-white">
                            <h3 class="text-sm font-medium uppercase tracking-wider opacity-80">Total Salary Given (Advance + Remainder)</h3>
                            <p class="text-4xl font-bold mt-2" id="analysisTotalSalaryGiven">₹0.00</p>
                        </div>
                        <div class="bg-orange-500 p-6 rounded-xl shadow-lg text-white">
                            <h3 class="text-sm font-medium uppercase tracking-wider opacity-80">Total Advance Given</h3>
                            <p class="text-4xl font-bold mt-2" id="analysisTotalAdvanceGiven">₹0.00</p>
                        </div>
                        <div class="bg-red-600 p-6 rounded-xl shadow-lg text-white">
                            <h3 class="text-sm font-medium uppercase tracking-wider opacity-80">Total Deductions</h3>
                            <p class="text-4xl font-bold mt-2" id="analysisTotalDeductionsCard">₹0.00</p>
                        </div>
                        <div class="bg-blue-50 p-6 rounded-xl border border-blue-200 shadow-md">
                            <h3 class="text-sm font-medium text-blue-600 uppercase tracking-wide">Total Salary Distributed (Net Pay)</h3>
                            <p class="text-4xl font-bold text-blue-800 mt-2" id="analysisTotalDistributed">₹0.00</p>
                        </div>
                        <div class="bg-green-50 p-6 rounded-xl border border-green-200 shadow-md">
                            <h3 class="text-sm font-medium text-green-600 uppercase tracking-wide">Total Payslips Issued</h3>
                            <p class="text-4xl font-bold text-green-800 mt-2" id="analysisTotalPayslips">0</p>
                        </div>
                        <div id="analysisAvgPayCard" class="bg-indigo-50 p-6 rounded-xl border border-indigo-200 shadow-md">
                            <h3 class="text-sm font-medium text-indigo-600 uppercase tracking-wide">Average Net Pay</h3>
                            <p class="text-4xl font-bold text-indigo-800 mt-2" id="analysisAveragePay">₹0.00</p>
                        </div>
                        <div id="analysisHighestPayCard" class="bg-yellow-50 p-6 rounded-xl border border-yellow-200 shadow-md">
                            <h3 class="text-sm font-medium text-yellow-600 uppercase tracking-wide">Highest Single Payslip</h3>
                            <p class="text-4xl font-bold text-yellow-800 mt-2" id="analysisHighestPayslipAmount">₹0.00</p>
                            <p class="text-sm text-gray-600 mt-1" id="analysisHighestPayslipEmployee">N/A</p>
                        </div>
                        <div id="analysisMostLeaveCard" class="bg-red-50 p-6 rounded-xl border border-red-200 shadow-md">
                            <h3 class="text-sm font-medium text-red-600 uppercase tracking-wide">Most Leave Taken</h3>
                            <p class="text-4xl font-bold text-red-800 mt-2" id="analysisMostLeave">0 days</p>
                            <p class="text-sm text-gray-600 mt-1" id="analysisMostLeaveEmployee">N/A</p>
                        </div>
                        <div id="analysisMostActiveCard" class="bg-green-50 p-6 rounded-xl border border-green-200 shadow-md">
                            <h3 class="text-sm font-medium text-green-600 uppercase tracking-wide">Most Active Worker</h3>
                            <p class="text-4xl font-bold text-green-800 mt-2" id="analysisMostActive">0 days</p>
                            <p class="text-sm text-gray-600 mt-1" id="analysisMostActiveEmployee">N/A</p>
                        </div>
                    </div>

                    <!-- AI Insights Section -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-xl border border-indigo-200 shadow-lg mt-8">
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                                </svg>
                                <h3 class="text-lg font-bold text-indigo-900 uppercase tracking-tight">AI Business Insights</h3>
                            </div>
                            <button id="getAiInsightsBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition duration-200 shadow-md flex items-center gap-2 text-sm">
                                Generate Insights
                            </button>
                        </div>
                        <div id="aiInsightsContainer" class="ai-content bg-white p-6 rounded-lg border border-indigo-100 min-h-[100px] text-gray-500 italic">
                            Click 'Generate Insights' to analyze your payroll data using Gemini AI.
                        </div>
                    </div>
    
                    <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-md">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Total Pay by Employee</h3>
                        <ul class="space-y-3 max-h-60 overflow-y-auto" id="analysisEmployeeTotalsList">
                        </ul>
                    </div>
                </div>
                <p id="noAnalysisDataText" class="text-gray-500 text-center italic hidden">No salary data found to analyze.</p>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="employeeModal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-white w-full max-w-md p-6 rounded-xl shadow-2xl transform scale-95">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800" id="employeeModalTitle">Manage Employees</h2>
                <button id="closeEmployeeModal" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div id="employeeListContainer" class="max-h-60 overflow-y-auto space-y-2 mb-4 pr-2">
                <p class="text-gray-500 text-sm italic">Loading employees...</p>
            </div>
            <div class="border-t pt-4">
                <h3 class="text-lg font-semibold text-gray-800 mb-2" id="employeeFormTitle">Add New Employee</h3>
                <div class="space-y-3">
                    <div class="grid grid-cols-1 gap-3">
                        <div>
                            <label for="newEmployeeName" class="block text-sm font-medium text-gray-700 mb-1">Employee Name</label>
                            <input type="text" id="newEmployeeName" placeholder="Enter name" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="newEmployeeDesignation" class="block text-sm font-medium text-gray-700 mb-1">Designation</label>
                            <input type="text" id="newEmployeeDesignation" placeholder="e.g., Senior Accountant" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="newEmployeeSalary" class="block text-sm font-medium text-gray-700 mb-1">Default Base Salary</label>
                            <div class="flex">
                                <span class="inline-flex items-center px-3 rounded-l-lg border border-r-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">₹</span>
                                <input type="number" id="newEmployeeSalary" placeholder="e.g., 30000" class="w-full px-4 py-2 border border-gray-300 rounded-r-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button id="addEmployeeBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-200">Add Employee</button>
                        <button id="updateEmployeeBtn" class="hidden w-full bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition duration-200">Update Employee</button>
                        <button id="cancelEmployeeUpdateBtn" class="hidden w-1/3 bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
                    </div>
                    <p id="employeeError" class="text-red-500 text-xs mt-1 h-4"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm and Other Modals -->
    <div id="confirmDeleteModal" class="modal fixed inset-0 z-60 flex items-center justify-center bg-black bg-opacity-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-white w-full max-w-sm p-6 rounded-xl shadow-2xl transform scale-95">
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Confirm Deletion</h3>
            <p class="text-gray-600 mb-6">Are you sure you want to delete <strong id="employeeToDeleteName"></strong>?</p>
            <div class="flex justify-end gap-3">
                <button id="cancelDeleteBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="confirmDeleteBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>
    <div id="confirmRecordDeleteModal" class="modal fixed inset-0 z-60 flex items-center justify-center bg-black bg-opacity-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-white w-full max-w-sm p-6 rounded-xl shadow-2xl transform scale-95">
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Confirm Record Deletion</h3>
            <p class="text-gray-600 mb-6">Are you sure you want to delete this salary record for <strong id="recordToDeleteName"></strong>?</p>
            <div class="flex justify-end gap-3">
                <button id="cancelRecordDeleteBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="confirmRecordDeleteBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>
    <div id="calendarModal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-white w-full max-w-md p-6 rounded-xl shadow-2xl transform scale-95">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800" id="calendarHeader">Select Dates</h2>
                <button id="closeCalendarModal" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div class="calendar-grid mb-4" id="calendarGrid"></div>
            <div class="flex justify-end gap-3">
                <button id="cancelCalendarBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="saveCalendarBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Save Dates</button>
            </div>
        </div>
    </div>
    <div id="passwordModal" class="modal fixed inset-0 z-60 flex items-center justify-center bg-black bg-opacity-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-white w-full max-w-sm p-6 rounded-xl shadow-2xl transform scale-95">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Enter Owner Password</h3>
            <input type="password" id="passwordInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <p id="passwordError" class="text-red-500 text-xs mt-1 h-4"></p>
            <div class="flex justify-end gap-3 mt-4">
                <button id="cancelPasswordBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="submitPasswordBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Login</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, Timestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const apiKey = ""; // Provided at runtime
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const userFirebaseConfig = {
            apiKey: "AIzaSyCMppXprg2OJswgLSXmmPgyhaRhxwDp0NA",
            authDomain: "salarymanagement-7f0ec.firebaseapp.com",
            projectId: "salarymanagement-7f0ec",
            storageBucket: "salarymanagement-7f0ec.firebasestorage.app",
            messagingSenderId: "857263287159",
            appId: "1:857263287159:web:70b284c66afa5be7590f72"
        };
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify(userFirebaseConfig));
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId, employeesCollection, salaryRecordsCollection;
        let salaryRecords = [], employees = [], employeeToDelete = null, recordToDeleteId = null, lastCalculationData = null, currentEditingRecordId = null, currentMode = "accountant", chartInstance = null;

        const employeeSelect = document.getElementById('employeeName'), manageEmployeesBtn = document.getElementById('manageEmployeesBtn'), employeeModal = document.getElementById('employeeModal');
        const employeeListContainer = document.getElementById('employeeListContainer'), newEmployeeNameInput = document.getElementById('newEmployeeName'), newEmployeeSalaryInput = document.getElementById('newEmployeeSalary'), newEmployeeDesignationInput = document.getElementById('newEmployeeDesignation'), addEmployeeBtn = document.getElementById('addEmployeeBtn'), updateEmployeeBtn = document.getElementById('updateEmployeeBtn'), cancelEmployeeUpdateBtn = document.getElementById('cancelEmployeeUpdateBtn'), employeeFormTitle = document.getElementById('employeeFormTitle'), employeeError = document.getElementById('employeeError');
        const confirmDeleteModal = document.getElementById('confirmDeleteModal'), employeeToDeleteName = document.getElementById('employeeToDeleteName'), cancelDeleteBtn = document.getElementById('cancelDeleteBtn'), confirmDeleteBtn = document.getElementById('confirmDeleteBtn'), confirmRecordDeleteModal = document.getElementById('confirmRecordDeleteModal'), recordToDeleteName = document.getElementById('recordToDeleteName'), cancelRecordDeleteBtn = document.getElementById('cancelRecordDeleteBtn'), confirmRecordDeleteBtn = document.getElementById('confirmRecordDeleteBtn');
        const calendarModal = document.getElementById('calendarModal'), openAbsentCalendarBtn = document.getElementById('openAbsentCalendar'), openHalfDayCalendarBtn = document.getElementById('openHalfDayCalendar'), openExtraDayCalendarBtn = document.getElementById('openExtraDayCalendar'), closeCalendarModalBtn = document.getElementById('closeCalendarModal'), cancelCalendarBtn = document.getElementById('cancelCalendarBtn'), saveCalendarBtn = document.getElementById('saveCalendarBtn'), calendarGrid = document.getElementById('calendarGrid'), calendarHeader = document.getElementById('calendarHeader'), absentDaysInput = document.getElementById('absentDays'), halfDaysInput = document.getElementById('halfDays'), extraDaysInput = document.getElementById('extraDays'), downloadPdfButton = document.getElementById('downloadPdfButton'), saveStatus = document.getElementById('saveStatus'), calculateButton = document.getElementById('calculateButton'), cancelEditButton = document.getElementById('cancelEditButton'), saveRecordButton = document.getElementById('saveRecordButton');
        const dashboardTab = document.getElementById('dashboardTab'), salaryDataTab = document.getElementById('salaryDataTab'), dashboardPage = document.getElementById('dashboardPage'), salaryDataPage = document.getElementById('salaryDataPage'), salaryRecordsContainer = document.getElementById('salaryRecordsContainer'), noRecordsText = document.getElementById('noRecordsText'), exportCsvButton = document.getElementById('exportCsvButton');
        const analysisTab = document.getElementById('analysisTab'), analysisPage = document.getElementById('analysisPage'), analysisContent = document.getElementById('analysisContent'), noAnalysisDataText = document.getElementById('noAnalysisDataText'), analysisTotalDistributed = document.getElementById('analysisTotalDistributed'), analysisTotalPayslips = document.getElementById('analysisTotalPayslips'), analysisAveragePay = document.getElementById('analysisAveragePay'), analysisHighestPayslipAmount = document.getElementById('analysisHighestPayslipAmount'), analysisHighestPayslipEmployee = document.getElementById('analysisHighestPayslipEmployee'), analysisEmployeeTotalsList = document.getElementById('analysisEmployeeTotalsList'), analysisChartTitle = document.getElementById('analysisChartTitle'), analysisMostLeave = document.getElementById('analysisMostLeave'), analysisMostLeaveEmployee = document.getElementById('analysisMostLeaveEmployee'), analysisMostActive = document.getElementById('analysisMostActive'), analysisMostActiveEmployee = document.getElementById('analysisMostActiveEmployee');
        const analysisTotalSalaryGiven = document.getElementById('analysisTotalSalaryGiven'), analysisTotalAdvanceGiven = document.getElementById('analysisTotalAdvanceGiven'), analysisTotalDeductionsCard = document.getElementById('analysisTotalDeductionsCard');
        const analysisAvgPayCard = document.getElementById('analysisAvgPayCard'), analysisHighestPayCard = document.getElementById('analysisHighestPayCard'), analysisMostLeaveCard = document.getElementById('analysisMostLeaveCard'), analysisMostActiveCard = document.getElementById('analysisMostActiveCard');
        const filterEmployeeName = document.getElementById('filterEmployeeName'), filterMonth = document.getElementById('filterMonth'), filterYear = document.getElementById('filterYear');
        const analysisFilterEmployeeName = document.getElementById('analysisFilterEmployeeName');
        const analysisFilterMonth = document.getElementById('analysisFilterMonth');
        const analysisFilterYear = document.getElementById('analysisFilterYear');
        const summaryWhatsAppBtn = document.getElementById('summaryWhatsAppBtn');
        const getAiInsightsBtn = document.getElementById('getAiInsightsBtn');
        const aiInsightsContainer = document.getElementById('aiInsightsContainer');

        const modeSwitchBtn = document.getElementById('modeSwitchBtn'), passwordModal = document.getElementById('passwordModal'), passwordInput = document.getElementById('passwordInput'), passwordError = document.getElementById('passwordError'), cancelPasswordBtn = document.getElementById('cancelPasswordBtn'), submitPasswordBtn = document.getElementById('submitPasswordBtn');
        const dashboardLockModal = document.getElementById('dashboardLockModal'), lockPinInput = document.getElementById('lockPinInput'), unlockDashboardBtn = document.getElementById('unlockDashboardBtn'), lockError = document.getElementById('lockError'), mainAppContainer = document.getElementById('mainAppContainer');

        let tempSelectedDates = [], currentCalendarInput = null, currentEmployeeEditingId = null;
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

        const showModal = (modal) => { modal.classList.remove('opacity-0', 'pointer-events-none'); modal.querySelector('.modal-content').classList.remove('scale-95'); };
        const hideModal = (modal) => { modal.classList.add('opacity-0', 'pointer-events-none'); modal.querySelector('.modal-content').classList.add('scale-95'); };

        function formatInCurrency(amount) {
            const parts = (amount || 0).toFixed(2).split('.');
            parts[0] = parts[0].replace(/(\d)(?=(\d\d)+\d$)/g, "$1,");
            return `Rs. ${parts.join('.')}`;
        }

        /**
         * AI Insight Generator
         */
        async function fetchAIInsights() {
            const currentFiltRecords = salaryRecords.filter(r => {
                const nameMatch = !analysisFilterEmployeeName.value || r.employeeName === analysisFilterEmployeeName.value;
                const monthMatch = !analysisFilterMonth.value || r.month === analysisFilterMonth.value;
                const yearMatch = !analysisFilterYear.value || r.year == analysisFilterYear.value;
                return r.createdByMode === currentMode && nameMatch && monthMatch && yearMatch;
            });

            if (currentFiltRecords.length === 0) {
                aiInsightsContainer.textContent = "No data available to analyze. Please adjust filters.";
                return;
            }

            const dataSummary = currentFiltRecords.map(r => ({
                emp: r.employeeName,
                desig: r.designation || 'Staff',
                per: `${r.month} ${r.year}`,
                net: r.netPay,
                adv: r.advancePayment || 0,
                abs: r.absentDays || 0,
                extra: r.extraDays || 0,
                ot: r.overtimeHours || 0
            }));

            const systemPrompt = `You are a professional financial and HR analyst for GURU NATURALS AND AGRO INDUSTRIES. 
            Analyze the provided payroll data and give deep insights. 
            Identify:
            1. Employee attendance patterns (who is absent often vs most active).
            2. Salary trends (increasing/decreasing payouts).
            3. Efficiency (who works extra days or overtime).
            4. Business advice for the owner based on this data.
            Keep the tone professional, concise, and helpful. Use Markdown for formatting.`;

            const userQuery = `Analyze this payroll data for the current period: ${JSON.stringify(dataSummary)}`;

            aiInsightsContainer.innerHTML = '<div class="flex items-center gap-2"><div class="animate-spin h-5 w-5 border-2 border-indigo-600 border-t-transparent rounded-full"></div> Analyzing business data...</div>';
            getAiInsightsBtn.disabled = true;

            const makeApiCall = async (retryCount = 0) => {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: userQuery }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] }
                        })
                    });

                    if (!response.ok) {
                        if (response.status === 429 && retryCount < 5) {
                            const delay = Math.pow(2, retryCount) * 1000;
                            await new Promise(r => setTimeout(r, delay));
                            return makeApiCall(retryCount + 1);
                        }
                        throw new Error(`API returned ${response.status}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!text) throw new Error("No response from AI");
                    return text;

                } catch (err) {
                    if (retryCount < 5) {
                        const delay = Math.pow(2, retryCount) * 1000;
                        await new Promise(r => setTimeout(r, delay));
                        return makeApiCall(retryCount + 1);
                    }
                    throw err;
                }
            };

            try {
                const insightText = await makeApiCall();
                aiInsightsContainer.innerHTML = marked.parse(insightText);
            } catch (err) {
                console.error(err);
                aiInsightsContainer.textContent = "AI Analysis failed. Please check your connection or try again later.";
            } finally {
                getAiInsightsBtn.disabled = false;
            }
        }

        /**
         * WhatsApp Message Logic
         */
        function sendWhatsAppNotification(record) {
            const r = record || lastCalculationData;
            if (!r) return;

            const text = `*Salary Payout Notification*\n\n` +
                         `*Employee:* ${r.employeeName}\n` +
                         `*Designation:* ${r.designation || 'Staff'}\n` +
                         `*Period:* ${r.month} ${r.year}\n` +
                         `--------------------------\n` +
                         `*Total Earnings:* ${formatInCurrency(r.totalEarnings)}\n` +
                         `*Total Deductions:* ${formatInCurrency(r.totalDeductions)}\n` +
                         `--------------------------\n` +
                         `*Net Pay (Remainder):* ${formatInCurrency(r.netPay)}\n\n` +
                         `_Thank you for your hard work!_`;
            
            const encodedText = encodeURIComponent(text);
            window.open(`https://wa.me/?text=${encodedText}`, '_blank');
        }

        function renderSalaryRecords() {
            const nameFilter = filterEmployeeName.value, monthFilter = filterMonth.value, yearFilter = filterYear.value;
            const filteredRecords = salaryRecords.filter(record => {
                const modeMatch = record.createdByMode === currentMode;
                const nameMatch = !nameFilter || record.employeeName === nameFilter;
                const monthMatch = !monthFilter || record.month === monthFilter;
                const yearMatch = !yearFilter || record.year == yearFilter;
                return modeMatch && nameMatch && monthMatch && yearMatch;
            });
            salaryRecordsContainer.innerHTML = '';
            if (filteredRecords.length === 0) {
                noRecordsText.textContent = salaryRecords.length === 0 ? "No salary records found." : "No records match filters.";
                noRecordsText.classList.remove('hidden'); return;
            }
            noRecordsText.classList.add('hidden');
            
            filteredRecords.forEach(record => {
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-lg shadow-sm border flex flex-col sm:flex-row justify-between items-start";
                const recordDate = record.createdAt ? record.createdAt.toLocaleString('en-IN', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true }) : 'N/A';
                card.innerHTML = `
                    <div class="mb-4 sm:mb-0">
                        <h3 class="text-lg font-semibold text-gray-800">${record.employeeName}</h3>
                        <p class="text-xs text-blue-600 font-medium">${record.designation || 'N/A'}</p>
                        <p class="text-sm text-gray-600">For ${record.month}, ${record.year}</p>
                        <p class="text-xs text-gray-400">Saved on: ${recordDate}</p>
                    </div>
                    <div class="flex flex-col items-start sm:items-end w-full sm:w-auto">
                        <span class="text-xl font-bold text-blue-700">${formatInCurrency(record.netPay)}</span>
                        <div class="flex gap-2 mt-2">
                            <button class="edit-record-btn bg-blue-100 text-blue-700 text-sm font-medium py-1 px-3 rounded-full hover:bg-blue-200" data-id="${record.id}">Edit</button>
                            <button class="delete-record-btn bg-red-100 text-red-700 text-sm font-medium py-1 px-3 rounded-full hover:bg-red-200" data-id="${record.id}" data-name="${record.employeeName}">Delete</button>
                            <button class="download-record-pdf-btn bg-gray-100 text-gray-700 text-sm font-medium py-1 px-3 rounded-full hover:bg-gray-200" data-id="${record.id}">PDF</button>
                            <button class="whatsapp-record-btn bg-green-100 text-green-700 text-sm font-medium py-1 px-3 rounded-full hover:bg-green-200 flex items-center gap-1" data-id="${record.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16"><path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.06 3.973l-1.127 4.113 4.209-1.103a7.882 7.882 0 0 0 3.792.98h.004c4.367 0 7.926-3.558 7.93-7.93a7.856 7.856 0 0 0-2.33-5.64zM7.994 14.125a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/></svg>
                                WA
                            </button>
                        </div>
                    </div>`;
                salaryRecordsContainer.appendChild(card);
            });
        }

        function renderAnalysis() {
            const nameF = analysisFilterEmployeeName.value;
            const monthF = analysisFilterMonth.value;
            const yearF = analysisFilterYear.value;

            // STRATEGY: Data Isolation. 
            // Only fetch records for the current mode to ensure Accountant can't see Owner data in analysis.
            const filteredRecords = salaryRecords.filter(r => {
                const modeMatch = r.createdByMode === currentMode;
                const nameMatch = !nameF || r.employeeName === nameF;
                const monthMatch = !monthF || r.month === monthF;
                const yearMatch = !yearF || r.year == yearF;
                return modeMatch && nameMatch && monthMatch && yearMatch;
            });

            if (filteredRecords.length === 0) {
                analysisContent.classList.add('hidden');
                noAnalysisDataText.classList.remove('hidden');
                noAnalysisDataText.textContent = "No data found for selected filters in this mode.";
                return;
            }

            analysisContent.classList.remove('hidden');
            noAnalysisDataText.classList.add('hidden');

            // --- Toggle comparison cards based on filter ---
            const isIndividualEmployee = !!nameF;
            [analysisAvgPayCard, analysisHighestPayCard, analysisMostLeaveCard, analysisMostActiveCard].forEach(card => {
                if (isIndividualEmployee) card.classList.add('hidden');
                else card.classList.remove('hidden');
            });

            // Calculate stats based on filteredRecords (which already respects currentMode)
            const totalDistributed = filteredRecords.reduce((acc, r) => acc + (r.netPay || 0), 0);
            const totalPayslips = filteredRecords.length;
            const averagePay = totalPayslips > 0 ? (totalDistributed / totalPayslips) : 0;
            const highestPayslip = filteredRecords.reduce((max, r) => (r.netPay > max.netPay) ? r : max, { netPay: -Infinity });

            const totalSalaryGivenVal = filteredRecords.reduce((acc, r) => acc + (r.netPay || 0) + (r.advancePayment || 0), 0);
            const totalAdvanceGivenVal = filteredRecords.reduce((acc, r) => acc + (r.advancePayment || 0), 0);
            const totalDeductionsVal = filteredRecords.reduce((acc, r) => acc + (r.totalDeductions || 0), 0);

            const employeeTotals = filteredRecords.reduce((acc, r) => {
                acc[r.employeeName] = (acc[r.employeeName] || 0) + (r.netPay || 0); return acc;
            }, {});
            const sortedEmployeeTotals = Object.entries(employeeTotals).map(([name, total]) => ({ name, total })).sort((a, b) => b.total - a.total);

            const employeeAttendance = filteredRecords.reduce((acc, r) => {
                acc[r.employeeName] = (acc[r.employeeName] || 0) + (r.absentDays || 0) + ((r.halfDays || 0) * 0.5); return acc;
            }, {});
            const sortedAttendance = Object.entries(employeeAttendance).map(([name, totalLeaveDays]) => ({ name, totalLeaveDays })).sort((a, b) => b.totalLeaveDays - a.totalLeaveDays);

            let mostLeave = sortedAttendance[0], mostActive = sortedAttendance[sortedAttendance.length - 1];

            const monthlyTotals = filteredRecords.reduce((acc, r) => {
                const mIdx = monthNames.indexOf(r.month);
                const key = `${r.year}-${String(mIdx).padStart(2, '0')}`;
                if (!acc[key]) acc[key] = { total: 0, label: `${r.month.substring(0, 3)} ${r.year}` };
                acc[key].total += (r.netPay || 0); return acc;
            }, {});
            const sortedMonthlyTotals = Object.entries(monthlyTotals).map(([key, data]) => ({ key, ...data })).sort((a, b) => a.key.localeCompare(b.key));

            analysisTotalSalaryGiven.textContent = formatInCurrency(totalSalaryGivenVal);
            analysisTotalAdvanceGiven.textContent = formatInCurrency(totalAdvanceGivenVal);
            analysisTotalDeductionsCard.textContent = formatInCurrency(totalDeductionsVal);
            
            analysisTotalDistributed.textContent = formatInCurrency(totalDistributed);
            analysisTotalPayslips.textContent = totalPayslips;
            analysisAveragePay.textContent = formatInCurrency(averagePay);
            if (highestPayslip.netPay > -Infinity) {
                analysisHighestPayslipAmount.textContent = formatInCurrency(highestPayslip.netPay);
                analysisHighestPayslipEmployee.textContent = `To ${highestPayslip.employeeName} for ${highestPayslip.month}, ${highestPayslip.year}`;
            }
            analysisMostLeave.textContent = mostLeave ? `${mostLeave.totalLeaveDays} days` : "0 days";
            analysisMostLeaveEmployee.textContent = mostLeave ? mostLeave.name : "N/A";
            analysisMostActive.textContent = mostActive ? `${mostActive.totalLeaveDays} days` : "0 days";
            analysisMostActiveEmployee.textContent = mostActive ? mostActive.name : "N/A";

            analysisEmployeeTotalsList.innerHTML = '';
            sortedEmployeeTotals.forEach(emp => {
                const li = document.createElement('li'); li.className = "flex justify-between items-center p-3 bg-gray-50 rounded-lg border";
                li.innerHTML = `<span class="font-medium text-gray-700">${emp.name}</span><span class="font-bold text-gray-900">${formatInCurrency(emp.total)}</span>`;
                analysisEmployeeTotalsList.appendChild(li);
            });

            const ctx = document.getElementById('myChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar', data: { labels: sortedMonthlyTotals.map(m => m.label), datasets: [{ data: sortedMonthlyTotals.map(m => m.total), backgroundColor: 'rgba(59, 130, 246, 0.5)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1, borderRadius: 5 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { callback: v => '₹' + v.toLocaleString('en-IN') } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => c.parsed.y.toLocaleString('en-IN', { style: 'currency', currency: 'INR' }) } } } }
            });
        }

        function renderEmployeeSelect() {
            const currentS = employeeSelect.value, currentF = filterEmployeeName.value, currentAF = analysisFilterEmployeeName.value;
            employeeSelect.innerHTML = '<option value="">Select Employee</option>';
            filterEmployeeName.innerHTML = '<option value="">All Employees</option>';
            analysisFilterEmployeeName.innerHTML = '<option value="">All Employees</option>';
            const sortedE = [...employees].sort((a, b) => a.name.localeCompare(b.name));
            sortedE.forEach(emp => {
                const o = new Option(emp.name, emp.name); 
                o.dataset.salary = emp.baseSalary || "";
                o.dataset.designation = emp.designation || "N/A";
                if (emp.name === currentS) o.selected = true; 
                employeeSelect.add(o);
                filterEmployeeName.add(new Option(emp.name, emp.name, false, emp.name === currentF));
                analysisFilterEmployeeName.add(new Option(emp.name, emp.name, false, emp.name === currentAF));
            });
        }

        function renderEmployeeManagementList() {
            employeeListContainer.innerHTML = employees.length ? '' : '<p class="text-gray-500 text-sm italic">No employees added.</p>';
            [...employees].sort((a, b) => a.name.localeCompare(b.name)).forEach(emp => {
                const div = document.createElement('div'); div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg border';
                div.innerHTML = `<div><span class="text-gray-800 font-medium">${emp.name}</span><span class="text-xs text-blue-600 ml-2 italic">${emp.designation || 'N/A'}</span><span class="text-gray-500 text-sm ml-2">${emp.baseSalary ? `(₹${emp.baseSalary.toLocaleString('en-IN')})` : ''}</span></div><div class="flex gap-2"><button class="edit-employee-btn text-blue-600 hover:text-blue-800 font-medium" data-id="${emp.id}" data-name="${emp.name}" data-salary="${emp.baseSalary || ''}" data-designation="${emp.designation || 'N/A'}">Edit</button><button class="delete-employee-btn text-red-500 hover:text-red-700 font-medium" data-id="${emp.id}" data-name="${emp.name}">Delete</button></div>`;
                employeeListContainer.appendChild(div);
            });
        }

        function resetEmployeeForm() { currentEmployeeEditingId = null; employeeFormTitle.textContent = "Add New Employee"; newEmployeeNameInput.value = ""; newEmployeeSalaryInput.value = ""; newEmployeeDesignationInput.value = ""; addEmployeeBtn.classList.remove('hidden'); updateEmployeeBtn.classList.add('hidden'); cancelEmployeeUpdateBtn.classList.add('hidden'); employeeError.classList.add('hidden'); }

        async function addEmployee() {
            const name = newEmployeeNameInput.value.trim(), baseSalary = parseFloat(newEmployeeSalaryInput.value) || 0, designation = newEmployeeDesignationInput.value.trim() || "Staff";
            if (!name) { employeeError.textContent = 'Enter a name.'; employeeError.classList.remove('hidden'); return; }
            if (employees.some(e => e.name.toLowerCase() === name.toLowerCase())) { employeeError.textContent = 'Exists.'; employeeError.classList.remove('hidden'); return; }
            try { addEmployeeBtn.disabled = true; await addDoc(employeesCollection, { name, baseSalary, designation, createdAt: Timestamp.now() }); resetEmployeeForm(); clearForm(); } catch (e) { console.error(e); } finally { addEmployeeBtn.disabled = false; }
        }

        async function updateEmployee() {
            const name = newEmployeeNameInput.value.trim(), baseSalary = parseFloat(newEmployeeSalaryInput.value) || 0, designation = newEmployeeDesignationInput.value.trim() || "Staff";
            if (!name || !currentEmployeeEditingId) return;
            try { updateEmployeeBtn.disabled = true; await updateDoc(doc(db, employeesCollection.path, currentEmployeeEditingId), { name, baseSalary, designation }); resetEmployeeForm(); } catch (e) { console.error(e); } finally { updateEmployeeBtn.disabled = false; }
        }

        async function confirmDeleteEmployee() {
            if (!employeeToDelete) return;
            try { await deleteDoc(doc(db, employeesCollection.path, employeeToDelete.id)); } catch (e) { console.error(e); } finally { hideModal(confirmDeleteModal); employeeToDelete = null; }
        }

        async function confirmDeleteRecord() {
            if (!recordToDeleteId) return;
            try { await deleteDoc(doc(db, salaryRecordsCollection.path, recordToDeleteId)); } catch (e) { console.error(e); } finally { hideModal(confirmRecordDeleteModal); recordToDeleteId = null; }
        }

        async function saveSalaryRecord(data) {
            try {
                saveRecordButton.disabled = true;
                if (currentEditingRecordId) {
                    await updateDoc(doc(db, salaryRecordsCollection.path, currentEditingRecordId), data);
                    saveStatus.textContent = "Updated!";
                } else {
                    await addDoc(salaryRecordsCollection, { ...data, createdByMode: currentMode, createdAt: Timestamp.now() });
                    saveStatus.textContent = "Saved!";
                }
                setTimeout(() => saveStatus.textContent = "", 2000);
                resetToCalculateMode(); clearForm();
            } catch (e) { console.error(e); saveStatus.textContent = "Error."; } finally { saveRecordButton.disabled = false; }
        }

        function listenForEmployees() { onSnapshot(employeesCollection, (s) => { employees = s.docs.map(d => ({ id: d.id, ...d.data(), designation: d.data().designation || "N/A" })); renderEmployeeSelect(); renderEmployeeManagementList(); }); }
        function listenForSalaryRecords() {
            onSnapshot(query(salaryRecordsCollection), (s) => {
                salaryRecords = s.docs.map(d => {
                    const data = d.data(); let c = null;
                    if (data.createdAt) {
                        if (typeof data.createdAt.toDate === 'function') c = data.createdAt.toDate();
                        else if (typeof data.createdAt === 'string') { c = new Date(data.createdAt); if (isNaN(c.getTime())) c = null; }
                    }
                    return { id: d.id, ...data, createdAt: c, designation: data.designation || "N/A" };
                }).sort((a, b) => b.createdAt - a.createdAt);
                renderSalaryRecords(); if (!analysisPage.classList.contains('hidden')) renderAnalysis();
            });
        }

        function renderCalendar(month, year) {
            calendarGrid.innerHTML = ''; const mIdx = monthNames.indexOf(month);
            if (mIdx === -1 || !year) return;
            calendarHeader.textContent = `${month}, ${year}`;
            const first = new Date(year, mIdx, 1).getDay(), days = new Date(year, mIdx + 1, 0).getDate(), prevDays = new Date(year, mIdx, 0).getDate();
            ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach(d => { const el = document.createElement('div'); el.className = 'calendar-day header'; el.textContent = d; calendarGrid.appendChild(el); });
            for (let i = 0; i < first; i++) { const el = document.createElement('div'); el.className = 'calendar-day other-month'; el.textContent = prevDays - first + 1 + i; calendarGrid.appendChild(el); }
            for (let i = 1; i <= days; i++) {
                const el = document.createElement('div'), dStr = `${year}-${String(mIdx + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                el.className = `calendar-day current-month ${tempSelectedDates.includes(dStr) ? 'selected' : ''}`; el.textContent = i; el.dataset.date = dStr; calendarGrid.appendChild(el);
            }
        }

        function openCalendar(target, title) {
            currentCalendarInput = target; calendarHeader.textContent = title;
            const m = document.getElementById('month').value, y = document.getElementById('year').value;
            tempSelectedDates = target.dataset.dates ? JSON.parse(target.dataset.dates) : [];
            renderCalendar(m, y); showModal(calendarModal);
        }

        function initDateFields() {
            const d = new Date(); d.setMonth(d.getMonth() - 1);
            const mIdx = d.getMonth(), mName = monthNames[mIdx], y = d.getFullYear();
            document.getElementById('month').value = mName;
            const ySel = document.getElementById('year'), fYSel = document.getElementById('filterYear'), aFYSel = document.getElementById('analysisFilterYear');
            ySel.innerHTML = ''; fYSel.innerHTML = '<option value="">All Years</option>'; aFYSel.innerHTML = '<option value="">All Years</option>';
            for (let i = 2095; i >= 1970; i--) {
                const o = new Option(i, i); ySel.add(o); fYSel.add(new Option(i, i)); aFYSel.add(new Option(i, i));
            }
            ySel.value = y; document.getElementById('filterMonth').value = mName; fYSel.value = y;
            document.getElementById('analysisFilterMonth').value = mName; aFYSel.value = y;
        }

        function generatePdf(data) {
            const r = data || lastCalculationData; if (!r) return;
            const { jsPDF } = window.jspdf; 
            const doc = new jsPDF();
            const fDt = (d) => d && d.length ? `(Dates: ${d.map(x => x.split('-')[2]).join(', ')})` : "";
            let y = 4;
            const logo = document.getElementById('dashboardCompanyLogo');
            if (logo && logo.complete) {
                try { doc.addImage(logo, 'PNG', 97.5, y, 22, 18); } catch (err) { console.error("PDF Logo load failed:", err); }
            }
            y = 30;
            doc.setTextColor(255, 0, 0); doc.setFontSize(18); doc.setFont('helvetica', 'bold');
            doc.text("GURU NATURALS AND AGRO INDUSTRIES", 15, y);
            y += 7; doc.setFontSize(9); doc.setFont('helvetica', 'normal');
            doc.text("21, shanti vihar colony near bengali square kanadia road, indore, madhya pradesh, 452016", 15, y);
            y += 5; doc.text("GST No: 23ABAFG7574N1Z0", 15, y);
            y += 10; doc.setTextColor(0, 0, 0); doc.setFontSize(18); doc.setFont('helvetica', 'bold');
            doc.text("PAY SLIP", 105, y, { align: 'center' });
            y += 15; doc.setFontSize(11);
            doc.setFont('helvetica', 'bold'); doc.text("Employee Name:", 15, y); doc.setFont('helvetica', 'normal'); doc.text(r.employeeName || 'N/A', 50, y);
            doc.setFont('helvetica', 'bold'); doc.text("Pay Period:", 140, y); doc.setFont('helvetica', 'normal'); doc.text(`${r.month}, ${r.year}`, 165, y);
            y += 7; doc.setFont('helvetica', 'bold'); doc.text("Designation:", 15, y); doc.setFont('helvetica', 'normal'); doc.text(r.designation || 'Staff', 50, y);
            y += 10; doc.line(15, y, 195, y); 
            y += 10; doc.setFontSize(14); doc.setFont('helvetica', 'bold'); doc.text("Earnings", 15, y); doc.text("Amount (INR)", 195, y, { align: 'right' }); 
            y += 8; doc.setFont('helvetica', 'normal'); doc.setFontSize(11);
            doc.text("Base Salary:", 15, y); doc.text(formatInCurrency(r.baseSalary), 195, y, { align: 'right' }); y += 7;
            doc.text("Extra Day Addition:", 15, y); doc.text(formatInCurrency(r.extraDayAddition), 195, y, { align: 'right' }); if (r.extraDayDates?.length) { y += 5; doc.setFontSize(9); doc.text(fDt(r.extraDayDates), 15, y); doc.setFontSize(11); } y += 7;
            doc.text("Overtime Pay:", 15, y); doc.text(formatInCurrency(r.overtimePay), 195, y, { align: 'right' }); if (r.overtimeHours) { y += 5; doc.setFontSize(9); doc.text(`(${r.overtimeHours} hrs)`, 15, y); doc.setFontSize(11); } y += 7;
            doc.text("Other Additions:", 15, y); doc.text(formatInCurrency(r.otherAddition), 195, y, { align: 'right' }); if (r.otherAdditionRemark) { y += 5; doc.setFontSize(9); doc.text(`(${r.otherAdditionRemark})`, 15, y); doc.setFontSize(11); } y += 7;
            doc.line(15, y, 195, y); y += 7; doc.setFont('helvetica', 'bold'); doc.text("Total Earnings:", 15, y); doc.text(formatInCurrency(r.totalEarnings), 195, y, { align: 'right' }); 
            y += 15; doc.text("Deductions", 15, y); doc.text("Amount (INR)", 195, y, { align: 'right' }); y += 8; doc.setFont('helvetica', 'normal');
            doc.text("Absent Deduction:", 15, y); doc.text(formatInCurrency(r.absentDeduction), 195, y, { align: 'right' }); if (r.absentDates?.length) { y += 5; doc.setFontSize(9); doc.text(fDt(r.absentDates), 15, y); doc.setFontSize(11); } y += 7;
            doc.text("Half Day Deduction:", 15, y); doc.text(formatInCurrency(r.halfDayDeduction), 195, y, { align: 'right' }); if (r.halfDayDates?.length) { y += 5; doc.setFontSize(9); doc.text(fDt(r.halfDayDates), 15, y); doc.setFontSize(11); } y += 7;
            doc.text("Advance Payment:", 15, y); doc.text(formatInCurrency(r.advancePayment), 195, y, { align: 'right' }); if (r.advancePaymentRemark) { y += 5; doc.setFontSize(9); doc.text(`(${r.advancePaymentRemark})`, 15, y); doc.setFontSize(11); } y += 7;
            doc.text("Other Deductions:", 15, y); doc.text(formatInCurrency(r.otherDeduction), 195, y, { align: 'right' }); if (r.otherDeductionRemark) { y += 5; doc.setFontSize(9); doc.text(`(${r.otherDeductionRemark})`, 15, y); doc.setFontSize(11); } y += 7;
            doc.line(15, y, 195, y); y += 7; doc.setFont('helvetica', 'bold'); doc.text("Total Deductions:", 15, y); doc.text(formatInCurrency(r.totalDeductions), 195, y, { align: 'right' }); 
            y += 15; doc.setFontSize(16); doc.text("Net Pay:", 15, y); doc.text(formatInCurrency(r.netPay), 195, y, { align: 'right' });
            doc.setTextColor(100, 100, 100); doc.setFontSize(9); doc.setFont('helvetica', 'italic');
            doc.text("This is a computer generated payslip and does not require signature and stamp.", 105, 285, { align: 'center' });
            doc.save(`Payslip_${r.employeeName}_${r.month}_${r.year}.pdf`);
        }

        function exportToCsv() {
            const nF = filterEmployeeName.value, mF = filterMonth.value, yF = filterYear.value;
            const fR = salaryRecords.filter(r => r.createdByMode === currentMode && (!nF || r.employeeName === nF) && (!mF || r.month === mF) && (!yF || r.year == yF));
            if (!fR.length) return;
            const h = ['Employee', 'Designation', 'Month', 'Year', 'Net Pay', 'Total Earnings', 'Total Deductions', 'Advance Paid'];
            let c = h.join(',') + '\n';
            fR.forEach(r => c += [r.employeeName, (r.designation || 'Staff'), r.month, r.year, r.netPay, r.totalEarnings, r.totalDeductions, r.advancePayment].join(',') + '\n');
            const blob = new Blob([c], { type: 'text/csv' }), url = URL.createObjectURL(blob), a = document.createElement('a');
            a.href = url; a.download = `salary_export.csv`; a.click();
        }

        function clearForm() {
            document.getElementById('baseSalary').value = ""; absentDaysInput.value = "0"; absentDaysInput.dataset.dates = "[]";
            halfDaysInput.value = "0"; halfDaysInput.dataset.dates = "[]"; extraDaysInput.value = "0"; extraDaysInput.dataset.dates = "[]";
            document.getElementById('overtimeHours').value = ""; document.getElementById('otherAddition').value = ""; document.getElementById('otherAdditionRemark').value = "";
            document.getElementById('advancePayment').value = ""; document.getElementById('advancePaymentRemark').value = ""; document.getElementById('otherDeduction').value = ""; document.getElementById('otherDeductionRemark').value = "";
            document.getElementById('summarySection').classList.add('hidden'); lastCalculationData = null;
        }

        function loadRecordForEdit(id) {
            const r = salaryRecords.find(x => x.id === id); if (!r) return;
            currentEditingRecordId = id; employeeSelect.value = r.employeeName; document.getElementById('month').value = r.month; document.getElementById('year').value = r.year; document.getElementById('baseSalary').value = r.baseSalary || "";
            absentDaysInput.value = r.absentDays || "0"; absentDaysInput.dataset.dates = JSON.stringify(r.absentDates || []);
            halfDaysInput.value = r.halfDays || "0"; halfDaysInput.dataset.dates = JSON.stringify(r.halfDayDates || []);
            extraDaysInput.value = r.extraDays || "0"; extraDaysInput.dataset.dates = JSON.stringify(r.extraDayDates || []);
            document.getElementById('overtimeHours').value = r.overtimeHours || ""; document.getElementById('otherAddition').value = r.otherAddition || ""; document.getElementById('otherAdditionRemark').value = r.otherAdditionRemark || "";
            document.getElementById('advancePayment').value = r.advancePayment || ""; document.getElementById('advancePaymentRemark').value = r.advancePaymentRemark || ""; document.getElementById('otherDeduction').value = r.otherDeduction || ""; document.getElementById('otherDeductionRemark').value = r.otherDeductionRemark || "";
            calculateButton.textContent = "Calculate Updates"; saveRecordButton.textContent = "Save Updates"; cancelEditButton.classList.remove('hidden'); document.getElementById('summarySection').classList.add('hidden');
            dashboardTab.click(); window.scrollTo(0, 0);
        }

        function resetToCalculateMode() { currentEditingRecordId = null; calculateButton.textContent = "Calculate Pay"; saveRecordButton.textContent = "Save Record"; cancelEditButton.classList.add('hidden'); document.getElementById('summarySection').classList.add('hidden'); clearForm(); }

        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app);
                onAuthStateChanged(auth, (u) => {
                    if (u) {
                        userId = u.uid; employeesCollection = collection(db, `artifacts/${appId}/public/data/employees`); salaryRecordsCollection = collection(db, `artifacts/${appId}/public/data/salaryRecords`);
                        listenForEmployees(); listenForSalaryRecords();
                    }
                });
                if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken); else await signInAnonymously(auth);
            } catch (e) { console.error(e); }
        }

        function setMode(m) {
            currentMode = m; const isO = m === 'owner';
            modeSwitchBtn.textContent = isO ? 'Switch to Accountant Mode' : 'Switch to Owner Mode';
            modeSwitchBtn.dataset.mode = m;
            modeSwitchBtn.classList.toggle('bg-red-600', isO); modeSwitchBtn.classList.toggle('bg-indigo-600', !isO);
            manageEmployeesBtn.classList.toggle('hidden', !isO);
            renderSalaryRecords(); if (!analysisPage.classList.contains('hidden')) renderAnalysis();
        }

        document.addEventListener('DOMContentLoaded', () => {
            unlockDashboardBtn.addEventListener('click', () => {
                if (lockPinInput.value === '9131') {
                    dashboardLockModal.classList.add('opacity-0', 'pointer-events-none'); mainAppContainer.classList.remove('hidden');
                    initDateFields(); initializeFirebase();
                } else { lockError.textContent = "Wrong PIN."; lockPinInput.value = ""; }
            });

            dashboardTab.addEventListener('click', () => { dashboardPage.classList.remove('hidden'); salaryDataPage.classList.add('hidden'); analysisPage.classList.add('hidden'); dashboardTab.classList.add('active'); salaryDataTab.classList.remove('active'); analysisTab.classList.remove('active'); });
            salaryDataTab.addEventListener('click', () => { dashboardPage.classList.add('hidden'); salaryDataPage.classList.remove('hidden'); analysisPage.classList.add('hidden'); dashboardTab.classList.remove('active'); salaryDataTab.classList.add('active'); analysisTab.classList.remove('active'); renderSalaryRecords(); });
            analysisTab.addEventListener('click', () => { dashboardPage.classList.add('hidden'); salaryDataPage.classList.add('hidden'); analysisPage.classList.remove('hidden'); dashboardTab.classList.remove('active'); salaryDataTab.classList.remove('active'); analysisTab.classList.add('active'); renderAnalysis(); });

            manageEmployeesBtn.addEventListener('click', () => { resetEmployeeForm(); showModal(employeeModal); });
            closeEmployeeModal.addEventListener('click', () => hideModal(employeeModal));
            addEmployeeBtn.addEventListener('click', addEmployee);
            updateEmployeeBtn.addEventListener('click', updateEmployee);
            cancelEmployeeUpdateBtn.addEventListener('click', resetEmployeeForm);
            employeeListContainer.addEventListener('click', (e) => {
                const d = e.target.closest('.delete-employee-btn'), ed = e.target.closest('.edit-employee-btn');
                if (d) { employeeToDelete = { id: d.dataset.id, name: d.dataset.name }; employeeToDeleteName.textContent = d.dataset.name; showModal(confirmDeleteModal); }
                if (ed) { currentEmployeeEditingId = ed.dataset.id; employeeFormTitle.textContent = "Update"; newEmployeeNameInput.value = ed.dataset.name; newEmployeeSalaryInput.value = ed.dataset.salary; newEmployeeDesignationInput.value = ed.dataset.designation || ""; addEmployeeBtn.classList.add('hidden'); updateEmployeeBtn.classList.remove('hidden'); cancelEmployeeUpdateBtn.classList.remove('hidden'); }
            });
            cancelDeleteBtn.addEventListener('click', () => hideModal(confirmDeleteModal));
            confirmDeleteBtn.addEventListener('click', confirmDeleteEmployee);

            salaryRecordsContainer.addEventListener('click', (e) => {
                const d = e.target.closest('.delete-record-btn'), ed = e.target.closest('.edit-record-btn'), p = e.target.closest('.download-record-pdf-btn'), w = e.target.closest('.whatsapp-record-btn');
                if (d) { recordToDeleteId = d.dataset.id; recordToDeleteName.textContent = d.dataset.name; showModal(confirmRecordDeleteModal); }
                if (ed) loadRecordForEdit(ed.dataset.id);
                if (p) { const r = salaryRecords.find(x => x.id === p.dataset.id); if (r) generatePdf(r); }
                if (w) { const r = salaryRecords.find(x => x.id === w.dataset.id); if (r) sendWhatsAppNotification(r); }
            });
            cancelRecordDeleteBtn.addEventListener('click', () => hideModal(confirmRecordDeleteModal));
            confirmRecordDeleteBtn.addEventListener('click', confirmDeleteRecord);
            downloadPdfButton.addEventListener('click', () => generatePdf());
            exportCsvButton.addEventListener('click', exportToCsv);
            summaryWhatsAppBtn.addEventListener('click', () => sendWhatsAppNotification());
            getAiInsightsBtn.addEventListener('click', fetchAIInsights);

            filterEmployeeName.addEventListener('change', renderSalaryRecords);
            filterMonth.addEventListener('change', renderSalaryRecords);
            filterYear.addEventListener('change', renderSalaryRecords);
            
            analysisFilterEmployeeName.addEventListener('change', renderAnalysis);
            analysisFilterMonth.addEventListener('change', renderAnalysis);
            analysisFilterYear.addEventListener('change', renderAnalysis);

            calendarGrid.addEventListener('click', (e) => {
                const el = e.target.closest('.calendar-day.current-month'); if (!el) return;
                const d = el.dataset.date; el.classList.toggle('selected');
                if (tempSelectedDates.includes(d)) tempSelectedDates = tempSelectedDates.filter(x => x !== d); else tempSelectedDates.push(d);
                tempSelectedDates.sort();
            });
            openAbsentCalendarBtn.addEventListener('click', () => openCalendar(absentDaysInput, 'Absent'));
            openHalfDayCalendarBtn.addEventListener('click', () => openCalendar(halfDaysInput, 'Half Days'));
            openExtraDayCalendarBtn.addEventListener('click', () => openCalendar(extraDaysInput, 'Extra Days'));
            closeCalendarModalBtn.addEventListener('click', () => hideModal(calendarModal));
            cancelCalendarBtn.addEventListener('click', () => hideModal(calendarModal));
            saveCalendarBtn.addEventListener('click', () => { if (currentCalendarInput) { currentCalendarInput.value = tempSelectedDates.length; currentCalendarInput.dataset.dates = JSON.stringify(tempSelectedDates); } hideModal(calendarModal); });

            employeeSelect.addEventListener('change', (e) => {
                if (currentEditingRecordId) return; clearForm();
                const selected = e.target.options[e.target.selectedIndex];
                const s = selected.dataset.salary; 
                if (s) document.getElementById('baseSalary').value = s;
            });

            modeSwitchBtn.addEventListener('click', () => { if (modeSwitchBtn.dataset.mode === 'accountant') { passwordError.classList.add('hidden'); passwordInput.value = ""; showModal(passwordModal); } else setMode('accountant'); });
            cancelPasswordBtn.addEventListener('click', () => hideModal(passwordModal));
            submitPasswordBtn.addEventListener('click', () => { if (passwordInput.value === '9111000') { setMode('owner'); hideModal(passwordModal); } else { passwordError.textContent = "Wrong."; passwordError.classList.remove('hidden'); } });

            calculateButton.addEventListener('click', () => {
                const sel = employeeSelect.options[employeeSelect.selectedIndex];
                const eN = sel.value, m = document.getElementById('month').value, y = document.getElementById('year').value;
                const eD = sel.dataset.designation || 'N/A'; 

                if (!eN) { saveStatus.textContent = "Select employee."; return; }
                const bS = parseFloat(document.getElementById('baseSalary').value) || 0, absD = parseFloat(absentDaysInput.value) || 0, hD = parseFloat(halfDaysInput.value) || 0, exD = parseFloat(extraDaysInput.value) || 0;
                const otH = parseFloat(document.getElementById('overtimeHours').value) || 0, otA = parseFloat(document.getElementById('otherAddition').value) || 0, otR = document.getElementById('otherAdditionRemark').value;
                const adP = parseFloat(document.getElementById('advancePayment').value) || 0, adR = document.getElementById('advancePaymentRemark').value, odP = parseFloat(document.getElementById('otherDeduction').value) || 0, odR = document.getElementById('otherDeductionRemark').value;
                const pDS = bS / 30, pHS = pDS / 9, absDed = pDS * absD, hDDed = (pDS / 2) * hD, exAdd = pDS * exD, otP = pHS * otH;
                const tE = bS + exAdd + otP + otA, tD = absDed + hDDed + adP + odP, nP = tE - tD;
                const fmt = (v) => v.toLocaleString('en-IN', { style: 'currency', currency: 'INR' });
                
                lastCalculationData = { employeeName: eN, designation: eD, month: m, year: y, baseSalary: bS, extraDays: exD, extraDayAddition: exAdd, overtimeHours: otH, overtimePay: otP, otherAddition: otA, totalEarnings: tE, absentDays: absD, absentDeduction: absDed, halfDays: hD, halfDayDeduction: hDDed, advancePayment: adP, otherDeduction: odP, totalDeductions: tD, netPay: nP, absentDates: JSON.parse(absentDaysInput.dataset.dates || '[]'), halfDayDates: JSON.parse(halfDaysInput.dataset.dates || '[]'), extraDayDates: JSON.parse(extraDaysInput.dataset.dates || '[]'), otherAdditionRemark: otR, advancePaymentRemark: adR, otherDeductionRemark: odR };
                
                document.getElementById('summaryEmployee').textContent = eN; 
                document.getElementById('summaryDesignation').textContent = eD;
                document.getElementById('summaryMonth').textContent = `${m} ${y}`; 
                document.getElementById('summaryDate').textContent = new Date().toLocaleDateString('en-IN');
                document.getElementById('summaryBase').textContent = fmt(bS); document.getElementById('summaryExtraDay').textContent = `+ ${fmt(exAdd)}`;
                document.getElementById('summaryOvertime').textContent = `+ ${fmt(otP)}`; document.getElementById('summaryOtherAddition').textContent = `+ ${fmt(otA)}`;
                document.getElementById('summaryTotalEarnings').textContent = fmt(tE); document.getElementById('summaryAbsent').textContent = `- ${fmt(absDed)}`;
                document.getElementById('summaryHalfDay').textContent = `- ${fmt(hDDed)}`; document.getElementById('summaryAdvance').textContent = `- ${fmt(adP)}`;
                document.getElementById('summaryOtherDeduction').textContent = `- ${fmt(odP)}`; document.getElementById('summaryTotalDeductions').textContent = fmt(tD);
                document.getElementById('summaryNetPay').textContent = fmt(nP); document.getElementById('summarySection').classList.remove('hidden'); document.getElementById('summarySection').scrollIntoView({ behavior: 'smooth' });
            });
            saveRecordButton.addEventListener('click', () => { if (lastCalculationData) saveSalaryRecord(lastCalculationData); });
            cancelEditButton.addEventListener('click', resetToCalculateMode);
        });
    </script>
</body>
</html>
